{"componentChunkName":"component---src-templates-asm-source-jsx","path":"/src/prg-4-5.asm","webpackCompilationHash":"0a0d43c2c0dda6221466","result":{"data":{"asmSource":{"path":"/src/prg-4-5.asm","name":"prg-4-5","raw":";\n; Bank 4 & Bank 5\n; ===============\n;\n; What's inside:\n;\n;   - Music engine\n;   - Sound effects engine\n;   - Sound effect pointers and data\n;   - Song pointers and data\n;   - Note length tables (tempos)\n;   - Instrument tables and data\n;\n\nStartProcessingSoundQueue:\n\tLDA #$FF\n\tSTA JOY2\n\tLDA StackArea\n\tCMP #Stack100_Pause\n\tBNE ProcessMusicAndSfxQueues\n\n\tLDA #%00001100 ; Mute the two square channels\n\tSTA SND_CHN\n\t; You would think you could skip processing,\n\t; since if the game is paused, nothing should\n\t; be setting new music or whatever.\n\t;\n\t; You would be correct, except for the suicide code!\n\t; That sets MusicQueue2.\n\t;\n\t; If not for processing it, the music would not\n\t; change (or stop) when you used the code. Welp!\n\tJMP ProcessOnlyMusicQueue2\n\n\nProcessMusicAndSfxQueues:\n\tJSR ProcessSoundEffectQueue2\n\n\tJSR ProcessSoundEffectQueue1\n\n\tJSR ProcessSoundEffectQueue3\n\n\tJSR ProcessDPCMQueue\n\nProcessOnlyMusicQueue2:\n\tJSR ProcessMusicQueue\n\n\t; Reset queues\n\tLDA #$00\n\tSTA SoundEffectQueue2\n\tSTA MusicQueue2\n\tSTA SoundEffectQueue1\n\tSTA DPCMQueue\n\tSTA MusicQueue1\n\tSTA SoundEffectQueue3\n\tRTS\n\n\nProcessSoundEffectQueue2_Jump:\n\tLDA #$42\n\tLDX #$82\n\tLDY #$A8\n\tJSR PlaySquare1Sweep\n\n\tLDA #$22\n\tSTA SoundEffectTimer2\n\nProcessSoundEffectQueue2_JumpPart2:\n\tLDA SoundEffectTimer2\n\tCMP #$20\n\tBNE ProcessSoundEffectQueue2_JumpPart3\n\n\tLDX #$DF\n\tLDY #$F6\n\tBNE ProcessSoundEffectQueue2_SetSquare1ThenDecrementTimer\n\nProcessSoundEffectQueue2_JumpPart3:\n\tCMP #$1A\n\tBNE ProcessSoundEffectQueue2_ThenDecrementTimer\n\n\tLDX #$C1\n\tLDY #$BC\n\nProcessSoundEffectQueue2_SetSquare1ThenDecrementTimer:\n\tJSR SetSquare1VolumeAndSweep\n\n\tBNE ProcessSoundEffectQueue2_ThenDecrementTimer\n\nProcessSoundEffectQueue2_CoinGet:\n\tLDA #$35\n\tLDX #$8D\n\tSTA SoundEffectTimer2\n\n\tLDY #$7F\n\tLDA #$5E\n\tJSR PlaySquare1Sweep\n\nProcessSoundEffectQueue2_CoinGetPart2:\n\tLDA SoundEffectTimer2\n\tCMP #$30\n\tBNE ProcessSoundEffectQueue2_ThenDecrementTimer\n\n\tLDA #$54\n\tSTA SQ1_LO\n\nProcessSoundEffectQueue2_ThenDecrementTimer:\n\tBNE ProcessSoundEffectQueue2_DecrementTimer\n\nProcessSoundEffectQueue2:\n\tLDA SoundEffectPlaying2\n\tCMP #SoundEffect2_Climbing\n\tBEQ ProcessSoundEffectQueue2_DecrementTimer\n\n\tLDY SoundEffectQueue2\n\tBEQ ProcessSoundEffectQueue2_None\n\n\tSTY SoundEffectPlaying2\n\tLSR SoundEffectQueue2\n\tBCS ProcessSoundEffectQueue2_Jump\n\n\tLSR SoundEffectQueue2\n\tBCS ProcessSoundEffectQueue2_Climbing\n\n\tLSR SoundEffectQueue2\n\tBCS ProcessSoundEffectQueue2_CoinGet\n\n\tLSR SoundEffectQueue2\n\tBCS ProcessSoundEffectQueue2_Shrinking\n\n\tLSR SoundEffectQueue2\n\tBCS ProcessSoundEffectQueue2_IntroFallSlide\n\n\tLSR SoundEffectQueue2\n\tBCS ProcessSoundEffectQueue2_Growing\n\nProcessSoundEffectQueue2_None:\n\tLDA SoundEffectPlaying2\n\tBEQ ProcessSoundEffectQueue2_NoneExit\n\n\t; Jumping\n\tLSR A\n\tBCS ProcessSoundEffectQueue2_JumpPart2\n\n\t; Climbing\n\tLSR A\n\tBCS ProcessSoundEffectQueue2_DecrementTimer\n\n\t; CoinGet\n\tLSR A\n\tBCS ProcessSoundEffectQueue2_CoinGetPart2\n\n\t; Shrinking\n\tLSR A\n\tBCS ProcessSoundEffectQueue2_ShrinkingPart2\n\n\t; IntroFallSlide\n\tLSR A\n\tBCS ProcessSoundEffectQueue2_DecrementTimer\n\n\t; Growing\n\tLSR A\n\tBCS ProcessSoundEffectQueue2_GrowingPart2\n\nProcessSoundEffectQueue2_NoneExit:\n\tRTS\n\nProcessSoundEffectQueue2_IntroFallSlide:\n\tLDA #$60\n\tLDY #$A5\n\tBNE ProcessSoundEffectQueue2_SingleSweep\n\nProcessSoundEffectQueue2_Climbing:\n\tSTY SoundEffectPlaying2\n\tLDA #$05\n\tLDY #$9C\n\n; A = timer\n; Y = sweep\nProcessSoundEffectQueue2_SingleSweep:\n\tLDX #$9E\n\tSTA SoundEffectTimer2\n\tLDA #$60\n\tJSR PlaySquare1Sweep\n\nProcessSoundEffectQueue2_DecrementTimer:\n\tDEC SoundEffectTimer2\n\tBNE ProcessSoundEffectQueue2_Exit\n\n\tLDX #%00001110\n\tSTX SND_CHN\n\tLDX #%00001111\n\tSTX SND_CHN\n\tLDX #$00\n\tSTX SoundEffectPlaying2\n\nProcessSoundEffectQueue2_Exit:\n\tRTS\n\nProcessSoundEffectQueue2_Shrinking:\n\tLDA #$2F\n\tSTA SoundEffectTimer2\n\nProcessSoundEffectQueue2_ShrinkingPart2:\n\tLDA SoundEffectTimer2\n\tLSR A\n\tBCS ProcessSoundEffectQueue2_ShrinkingPart3\n\n\tLSR A\n\tBCS ProcessSoundEffectQueue2_ShrinkingPart3\n\n\tAND #$02\n\tBEQ ProcessSoundEffectQueue2_ShrinkingPart3\n\n\tLDY #$91\n\tLDX #$9A\n\tLDA #$68\n\tJSR PlaySquare1Sweep\n\nProcessSoundEffectQueue2_ShrinkingPart3:\n\tJMP ProcessSoundEffectQueue2_DecrementTimer\n\nProcessSoundEffectQueue2_Growing:\n\tLDA #$36\n\tSTA SoundEffectTimer2\n\nProcessSoundEffectQueue2_GrowingPart2:\n\tLDA SoundEffectTimer2\n\tLSR A\n\tBCS ProcessSoundEffectQueue2_DecrementTimer\n\n\tTAY\n\tLDA MushroomSoundData - 1, Y\n\tLDX #$5D\n\tLDY #$7F\n\tJSR PlaySquare1Sweep\n\n\tJMP ProcessSoundEffectQueue2_DecrementTimer\n\nMushroomSoundData:\n\t.db $6A, $74, $6A, $64, $5C, $52, $5C, $52, $4C, $44, $66, $70, $66, $60, $58, $4E\n\t.db $58, $4E, $48, $40, $56, $60, $56, $50, $48, $3E, $48, $3E, $38, $30 ; $10\n\n\nProcessSoundEffectQueue1:\n\tLDA SoundEffectQueue1\n\tBEQ ProcessSoundEffectQueue1_None\n\n\tCMP #SoundEffect1_StopwatchTick\n\tBNE ProcessSoundEffectQueue1_Part2\n\n\tLDX SoundEffectPlaying1\n\tBEQ ProcessSoundEffectQueue1_Part2\n\nProcessSoundEffectQueue1_None:\n\tLDA SoundEffectPlaying1\n\tBNE ProcessSoundEffectQueue1_Part3\n\n\tRTS\n\nProcessSoundEffectQueue1_Part2:\n\tSTA SoundEffectPlaying1\n\tLDY #$00\n\nProcessSoundEffectQueue1_PointerLoop:\n\tINY\n\tLSR A\n\tBCC ProcessSoundEffectQueue1_PointerLoop\n\n\tLDA SoundEffectPointers - 1, Y\n\tSTA SoundEffect1DataOffset\n\nProcessSoundEffectQueue1_Part3:\n\tLDY SoundEffect1DataOffset\n\tINC SoundEffect1DataOffset\n\tLDA SoundEffectPointers, Y\n\tBMI ProcessSoundEffectQueue1_Patch\n\n\tBNE ProcessSoundEffectQueue1_Note\n\n\t; if it was $00, we're at the end of the data for this sound effect\n\tLDX #$90\n\tSTX SQ2_VOL\n\tLDX #$18\n\tSTX SQ2_HI\n\tLDX #$00\n\tSTX SQ2_LO\n\tSTX SoundEffectPlaying1\n\tRTS\n\nProcessSoundEffectQueue1_Patch:\n\tSTA SQ2_VOL\n\tLDY SoundEffect1DataOffset\n\tINC SoundEffect1DataOffset\n\tLDA SoundEffectPointers, Y\n\nProcessSoundEffectQueue1_Note:\n\tCMP #$7E\n\tBEQ ProcessSoundEffectQueue1_Exit\n\n\tJSR PlaySquare2Note\n\nProcessSoundEffectQueue1_Exit:\n\tLDA #$7F\n\tSTA SQ2_SWEEP\n\n\tRTS\n\n\n;\n; Sound effect data\n;\n.include \"src/music/sound-effect-data.asm\"\n\n\nProcessSoundEffectQueue3_ShortNoise:\n\tLDA #$02\n\tSTA SoundEffectTimer3\n\nProcessSoundEffectQueue3_ShortNoisePart2:\n\tLDA #$1A\n\tSTA NOISE_VOL\n\tLDA #$04\n\tSTA NOISE_LO\n\tSTA NOISE_HI\n\tBNE ProcessSoundEffectQueue3_DecrementTimer\n\nProcessSoundEffectQueue3:\n\tLDY SoundEffectQueue3\n\tBEQ ProcessSoundEffectQueue3_Part2\n\n\tSTY SoundEffectPlaying3\n\tLSR SoundEffectQueue3\n\tBCS ProcessSoundEffectQueue3_ShortNoise\n\n\tLSR SoundEffectQueue3\n\tBCS ProcessSoundEffectQueue3_Rumble\n\n\tLSR SoundEffectQueue3\n\tBCS ProcessSoundEffectQueue3_Rumble\n\nProcessSoundEffectQueue3_Part2:\n\tLDA SoundEffectPlaying3\n\tLSR A\n\tBCS ProcessSoundEffectQueue3_ShortNoisePart2\n\n\tLSR A\n\tBCS ProcessSoundEffectQueue3_RumblePart2\n\n\tLSR A\n\tBCS ProcessSoundEffectQueue3_RumblePart2\n\n\tRTS\n\nProcessSoundEffectQueue3_Rumble:\n\tLDA #$7F\n\tSTA SoundEffectTimer3\n\nProcessSoundEffectQueue3_RumblePart2:\n\tLDY SoundEffectTimer3\n\tLDA ProcessMusicQueue, Y ; weird, but i guess that's one way to get \"random\" noise\n\tORA #$0C\n\tSTA NOISE_LO\n\tLDA SoundEffectTimer3\n\tLSR A\n\tLSR A\n\tLSR A\n\tAND #$1F\n\tORA #$10\n\tSTA NOISE_VOL\n\tLDA #$18\n\tSTA NOISE_HI\n\nProcessSoundEffectQueue3_DecrementTimer:\n\tDEC SoundEffectTimer3\n\tBNE ProcessSoundEffectQueue3_Exit\n\n\tLDX #$07\n\tSTX SND_CHN\n\tLDX #$0F\n\tSTX SND_CHN\n\tLDX #$00\n\tSTX SoundEffectPlaying3\n\nProcessSoundEffectQueue3_Exit:\n\tRTS\n\n\nProcessDPCMQueue:\n\tLDA DPCMQueue\n\tBNE ProcessDPCMQueue_Part2\n\n\tLDA DPCMPlaying\n\tBEQ ProcessDPCMQueue_None\n\n\tDEC DPCMTimer\n\tBNE ProcessDPCMQueue_Exit\n\nProcessDPCMQueue_None:\n\tLDA #$00\n\tSTA DPCMPlaying\n\tLDA #%00001111\n\tSTA SND_CHN\n\nProcessDPCMQueue_Exit:\n\tRTS\n\nProcessDPCMQueue_Part2:\n\tSTA DPCMPlaying\nIFDEF EXPAND_MUSIC\n\tCMP #$7E\n\tBNE ProcessDPCMQueue_LookUpSample\n\n\tLDA #$A0\n\tSTA DPCMTimer\n\tRTS\n\nProcessDPCMQueue_LookUpSample:\nENDIF\n\tLDY #$00\n\nIFNDEF EXPAND_MUSIC\nProcessDPCMQueue_PointerLoop:\n\tINY\n\tLSR A\n\tBCC ProcessDPCMQueue_PointerLoop\nELSE\n\tTAY\nENDIF\n\n\tLDA DMCFreqTable - 1, Y\n\tSTA DMC_FREQ\n\n\tLDA DMCStartTable - 1, Y\n\tSTA DMC_START\n\tLDA DMCLengthTable - 1, Y\n\tSTA DMC_LEN\n\tLDA #$A0\n\tSTA DPCMTimer\n\tLDA #%00001111\n\tSTA SND_CHN\n\tLDA #%00011111\n\tSTA SND_CHN\n\tRTS\n\n\nDMCStartTable:\n\t.db (DPCMSampleData_DoorOpenBombBom - DPCMSampleData)/64 ; $4F\n\t.db (DPCMSampleData_DrumSample - DPCMSampleData)/64 ; $60\n\t.db (DPCMSampleData_PlayerHurt - DPCMSampleData)/64 ; $4B\n\t.db (DPCMSampleData_ItemPull - DPCMSampleData)/64 ; $00\n\t.db (DPCMSampleData_BossDeath - DPCMSampleData)/64 ; $31\n\t.db (DPCMSampleData_DrumSample - DPCMSampleData)/64 ; $60\n\t.db (DPCMSampleData_BossHurt - DPCMSampleData)/64 ; $0E\n\t.db (DPCMSampleData_PlayerDeath - DPCMSampleData)/64 ; $1D\n\nDMCLengthTable:\n\t.db (DPCMSampleDataEnd_DoorOpenBombBom - DPCMSampleData_DoorOpenBombBom)/16 ; $43\n\t.db (DPCMSampleDataEnd_DrumSample_A - DPCMSampleData_DrumSample)/16 ; $14\n\t.db (DPCMSampleDataEnd_PlayerHurt - DPCMSampleData_PlayerHurt)/16 ; $10\n\t.db (DPCMSampleDataEnd_ItemPull - DPCMSampleData_ItemPull)/16 ; $38\n\t.db (DPCMSampleDataEnd_BossDeath - DPCMSampleData_BossDeath)/16 ; $48\n\t.db (DPCMSampleDataEnd_DrumSample_B - DPCMSampleData_DrumSample)/16 ; $28\n\t.db (DPCMSampleDataEnd_BossHurt - DPCMSampleData_BossHurt)/16 ; $3C\n\t.db (DPCMSampleDataEnd_PlayerDeath - DPCMSampleData_PlayerDeath)/16 ; $50\n\nDMCFreqTable:\n\t.db $0E\n\t.db $0E\n\t.db $0F\n\t.db $0F\n\t.db $0F\n\t.db $0F\n\t.db $0F\n\t.db $0F\n\t.db $60 ; ???\n\n\nProcessMusicQueue_ThenReadNoteData:\n\tJMP ProcessMusicQueue_ReadNoteData\n\nProcessMusicQueue_StopMusic:\n\tJMP StopMusic\n\nProcessMusicQueue:\n\tLDA MusicQueue2\n\tBMI ProcessMusicQueue_StopMusic\n\n\tCMP #Music2_EndingAndCast\n\tBEQ ProcessMusicQueue_EndingAndCast\n\n\tLDA MusicQueue2\n\tBNE ProcessMusicQueue_Part2\n\n\tLDA MusicQueue1\n\tBNE ProcessMusicQueue_MusicQueue1\n\n\tLDA MusicPlaying2\n\tORA MusicPlaying1\n\tBNE ProcessMusicQueue_ThenReadNoteData\n\n\tRTS\n\nProcessMusicQueue_EndingAndCast:\n\tSTA MusicPlaying2\n\tLDY #$00\n\tSTY MusicPlaying1\n\tLDY #$08 ; index of ending music pointer\n\tBNE ProcessMusicQueue_ReadFirstPointer\n\nProcessMusicQueue_MusicQueue1:\n\tSTA MusicPlaying1\n\tLDY #$00\n\tSTY MusicPlaying2\n\tLDY #$FF\n\nIFNDEF EXPAND_MUSIC\nProcessMusicQueue_FirstPointerLoop:\n\tINY\n\tLSR A\n\tBCC ProcessMusicQueue_FirstPointerLoop\nELSE\n\tTAY\n\tDEY\nENDIF\n\nProcessMusicQueue_ReadFirstPointer:\n\tLDA MusicPointersFirstPart, Y\n\tSTA MusicPointerFirstPart\n\tLDA MusicPointersEndPart, Y\n\tCLC\n\tADC #$02\n\tSTA MusicPointerEndPart\n\tLDA MusicPointersLoopPart, Y\n\tSTA MusicPointerLoopPart\n\tLDA MusicPointerFirstPart\n\nProcessMusicQueue_SetCurrentPart:\n\tSTA MusicPointerCurrentPart\n\nProcessMusicQueue_SetNextPart:\n\tINC MusicPointerCurrentPart\n\tLDY MusicPointerCurrentPart\n\tCPY MusicPointerEndPart\n\tBNE ProcessMusicQueue_ReadHeader\n\n\tLDA MusicPointerLoopPart\n\tBNE ProcessMusicQueue_SetCurrentPart\n\n\tJMP StopMusic\n\nProcessMusicQueue_Part2:\n\tSTA MusicPlaying2\n\tLDY MusicPlaying1\n\tSTY MusicResume1\n\tLDY #$00\n\tSTY MusicPlaying1\n\nIFNDEF EXPAND_MUSIC\nProcessMusicQueue_PointerLoop:\n\tINY\n\tLSR A\n\tBCC ProcessMusicQueue_PointerLoop\nELSE\n\tTAY\nENDIF\n\nIFNDEF EXPAND_MUSIC\nProcessMusicQueue_ReadHeader:\n\tLDA MusicPartPointers - 1, Y\n\tTAY\n\tLDA MusicPartPointers, Y\n\tSTA MusicTempoSetting\n\tLDA MusicPartPointers + 1, Y\n\tSTA CurrentMusicPointer\n\tLDA MusicPartPointers + 2, Y\n\tSTA CurrentMusicPointer + 1\n\tLDA MusicPartPointers + 3, Y\n\tSTA CurrentMusicTriangleOffset\n\tLDA MusicPartPointers + 4, Y\n\tSTA CurrentMusicSquare1Offset\n\tLDA MusicPartPointers + 5, Y\n\tSTA CurrentMusicNoiseOffset\n\tSTA CurrentMusicNoiseStartOffset\nIFDEF PROTOTYPE_MUSIC_UNDERGROUND\n\tLDA MusicPartPointers + 6, Y\nENDIF\n\tSTA CurrentMusicDPCMOffset\n\tSTA CurrentMusicDPCMStartOffset\nENDIF\n\nIFDEF EXPAND_MUSIC\nProcessMusicQueue_ReadHeader:\n\tLDA MusicPartPointers - 1, Y\n\tTAY\n\n\tLDA MusicHeaderPointersLo, Y\n\tSTA byte_RAM_0\n\tLDA MusicHeaderPointersHi, Y\n\tSTA byte_RAM_0+1\n\n\tLDY #$00\n\n\tLDA (byte_RAM_0), Y\n\tSTA MusicTempoSetting\n\tINY\n\tLDA (byte_RAM_0), Y\n\tSTA CurrentMusicPointer\n\tINY\n\tLDA (byte_RAM_0), Y\n\tSTA CurrentMusicPointer + 1\n\tINY\n\tLDA (byte_RAM_0), Y\n\tSTA CurrentMusicTriangleOffset\n\tINY\n\tLDA (byte_RAM_0), Y\n\tSTA CurrentMusicSquare1Offset\n\tINY\n\tLDA (byte_RAM_0), Y\n\tSTA CurrentMusicNoiseOffset\n\tSTA CurrentMusicNoiseStartOffset\n\tINY\n\tLDA (byte_RAM_0), Y\n\tSTA CurrentMusicDPCMOffset\n\tSTA CurrentMusicDPCMStartOffset\nENDIF\n\n\tLDA #$01\n\tSTA MusicSquare2NoteLength\n\tSTA MusicSquare1NoteLength\n\tSTA MusicTriangleNoteLength\n\tSTA MusicNoiseNoteLength\n\tSTA MusicDPCMNoteLength\n\n\tLDA #$00\n\tSTA CurrentMusicSquare2Offset\n\tSTA MusicSquare1NoteSweep\nIFDEF EXPAND_MUSIC\n\tSTA MusicSquare1NoteBend\n\tSTA MusicSquare2NoteBend\nENDIF\n\n\tLDA #%00001011\n\tSTA SND_CHN\n\tLDA #%00001111\n\tSTA SND_CHN\n\nProcessMusicQueue_ReadNoteData:\n\tDEC MusicSquare2NoteLength\n\tBNE ProcessMusicQueue_Square2SustainNote\n\n\tLDY CurrentMusicSquare2Offset\n\tINC CurrentMusicSquare2Offset\n\tLDA (CurrentMusicPointer), Y\n\tBEQ ProcessMusicQueue_EndOfSegment\n\n\tBPL ProcessMusicQueue_Square2Note\n\n\tBNE ProcessMusicQueue_Square2Patch\n\nProcessMusicQueue_EndOfSegment:\n\tLDA MusicPlaying1\n\tBNE ProcessMusicQueue_ThenSetNextPart\n\n\tLDA MusicPlaying2\n\tCMP #Music2_EndingAndCast\n\tBEQ ProcessMusicQueue_ThenSetNextPart\n\nIFNDEF EXPAND_MUSIC\n\tAND #Music1_Overworld | Music1_Inside | Music1_Subspace\nELSE\n\tJSR CheckStopMusic\nENDIF\n\tBEQ StopMusic\n\n\tLDA MusicResume1\n\tBNE ProcessMusicQueue_ResumeMusicQueue1\n\nStopMusic:\n\tLDA #$00\n\tSTA MusicPlaying2\n\tSTA MusicPlaying1\n\tSTA SND_CHN\n\tLDX #%00001111\n\tSTX SND_CHN\n\tRTS\n\nProcessMusicQueue_ThenSetNextPart:\n\tJMP ProcessMusicQueue_SetNextPart\n\nProcessMusicQueue_ResumeMusicQueue1:\n\tJMP ProcessMusicQueue_MusicQueue1\n\nProcessMusicQueue_Square2Patch:\n\tTAX\n\tAND #$F0\n\tSTA MusicSquare2Patch\n\tTXA\n\tJSR ProcessMusicQueue_PatchNoteLength\n\n\tSTA MusicSquare2NoteStartLength\n\nProcessMusicQueue_Square2NextOffset:\n\tLDY CurrentMusicSquare2Offset\n\tINC CurrentMusicSquare2Offset\n\tLDA (CurrentMusicPointer), Y\n\nProcessMusicQueue_Square2Note:\n\tLDX SoundEffectPlaying1\n\tBNE ProcessMusicQueue_Square2ContinueNote\n\n\tJSR PlaySquare2Note\n\n\tTAY\n\tBNE ProcessMusicQueue_Square2StartNote\n\n\tLDA MusicSquareInstrumentStartOffset\n\tJMP ProcessMusicQueue_Square2UpdateNoteOffset\n\nProcessMusicQueue_Square2StartNote:\n\tLDA MusicSquare2NoteStartLength\n\t; seems like the next line should be LDX MusicSquareEnvelope based on the equivalent code for square 1?\n\tLDX MusicSquareInstrumentStartOffset ; always overridden in the following subroutine...?\n\tJSR SetInstrumentStartOffset\n\nProcessMusicQueue_Square2UpdateNoteOffset:\n\tSTA MusicSquare2InstrumentOffset\n\nIFDEF EXPAND_MUSIC\n\tJSR CheckSquare2NoteBend\nENDIF\n\n\tJSR SetSquare2VolumeAndSweep\n\nProcessMusicQueue_Square2ContinueNote:\n\tLDA MusicSquare2NoteStartLength\n\tSTA MusicSquare2NoteLength\n\nProcessMusicQueue_Square2SustainNote:\n\tLDX SoundEffectPlaying1\n\tBNE ProcessMusicQueue_Square1\n\nIFDEF EXPAND_MUSIC\n\tLDA MusicSquare2NoteBend\n\tBEQ ProcessMusicQueue_LoadSquare2InstrumentOffset\n\n\tLDA MusicSquare2NoteStartLength\n\tLDX #$04\n\tJSR UpdateNoteBend\nENDIF\n\nProcessMusicQueue_LoadSquare2InstrumentOffset:\n\tLDY MusicSquare2InstrumentOffset\n\tBEQ ProcessMusicQueue_LoadSquare2Instrument\n\n\tDEC MusicSquare2InstrumentOffset\n\nProcessMusicQueue_LoadSquare2Instrument:\n\tLDA MusicSquare2NoteStartLength\n\tLDX MusicSquare2Patch\n\tJSR LoadSquareInstrumentDVE\n\n\tSTA SQ2_VOL\n\tLDX #$7F\n\tSTX SQ2_SWEEP\n\nProcessMusicQueue_Square1:\n\tDEC MusicSquare1NoteLength\n\tBNE ProcessMusicQueue_Square1SustainNote\n\nProcessMusicQueue_Square1Patch:\n\tLDY CurrentMusicSquare1Offset\n\tINC CurrentMusicSquare1Offset\n\tLDA (CurrentMusicPointer), Y\n\tBPL ProcessMusicQueue_Square1AfterPatch\n\n\tTAX\n\tAND #$F0\n\tSTA MusicSquare1Patch\n\tTXA\n\tJSR ProcessMusicQueue_PatchNoteLength\n\n\tSTA MusicSquare1NoteStartLength\n\nProcessMusicQueue_Square1NextOffset:\n\tLDY CurrentMusicSquare1Offset\n\tINC CurrentMusicSquare1Offset\n\tLDA (CurrentMusicPointer), Y\n\nProcessMusicQueue_Square1AfterPatch:\n\tTAY\n\tBNE ProcessMusicQueue_Square1Note\n\n\tLDA #$83\n\tSTA SQ1_VOL\n\tLDA #$94\n\tSTA SQ1_SWEEP\n\tSTA MusicSquare1NoteSweep\n\tBNE ProcessMusicQueue_Square1Patch\n\nProcessMusicQueue_Square1Note:\n\tLDY SoundEffectPlaying2\n\tBNE ProcessMusicQueue_Square1ContinueNote\n\n\tJSR PlaySquare1Note\n\n\tBNE ProcessMusicQueue_Square1StartNote\n\n\tLDA MusicSquareInstrumentStartOffset\n\tJMP ProcessMusicQueue_Square1UpdateNoteOffset\n\nProcessMusicQueue_Square1StartNote:\n\tLDA MusicSquare1NoteStartLength\n\tLDX MusicSquareEnvelope ; always overridden in the following subroutine...?\n\tJSR SetInstrumentStartOffset\n\nProcessMusicQueue_Square1UpdateNoteOffset:\n\tSTA MusicSquare1InstrumentOffset\n\nIFDEF EXPAND_MUSIC\n\tJSR CheckSquare1NoteBend\nENDIF\n\n\tJSR SetSquare1VolumeAndSweep\n\nProcessMusicQueue_Square1ContinueNote:\n\tLDA MusicSquare1NoteStartLength\n\tSTA MusicSquare1NoteLength\n\nProcessMusicQueue_Square1SustainNote:\n\tLDA SoundEffectPlaying2\n\tBNE ProcessMusicQueue_Triangle\n\nIFDEF EXPAND_MUSIC\n\tLDA MusicSquare1NoteBend\n\tBEQ ProcessMusicQueue_LoadSquare1InstrumentOffset\n\n\tLDX #$00\n\tLDA MusicSquare1NoteStartLength\n\tJSR UpdateNoteBend\nENDIF\n\nProcessMusicQueue_LoadSquare1InstrumentOffset:\n\tLDY MusicSquare1InstrumentOffset\n\tBEQ ProcessMusicQueue_Square1AfterDecrementInstrumentOffset\n\n\tDEC MusicSquare1InstrumentOffset\n\nProcessMusicQueue_Square1AfterDecrementInstrumentOffset:\n\tLDA MusicSquare1NoteStartLength\n\tLDX MusicSquare1Patch\n\tJSR LoadSquareInstrumentDVE\n\n\tSTA SQ1_VOL\n\tLDA MusicSquare1NoteSweep\n\tBNE ProcessMusicQueue_Square1Sweep\n\n\tLDA #$7F\n\nProcessMusicQueue_Square1Sweep:\n\tSTA SQ1_SWEEP\n\nProcessMusicQueue_Triangle:\n\tLDA CurrentMusicTriangleOffset\n\tBEQ ProcessMusicQueue_NoiseDPCM\n\n\tDEC MusicTriangleNoteLength\n\tBNE ProcessMusicQueue_NoiseDPCM\n\n\tLDY CurrentMusicTriangleOffset\n\tINC CurrentMusicTriangleOffset\n\tLDA (CurrentMusicPointer), Y\n\tBEQ ProcessMusicQueue_TriangleSetLength\n\n\tBPL ProcessMusicQueue_TriangleNote\n\n\tJSR ProcessMusicQueue_PatchNoteLength\n\n\tSTA MusicTriangleNoteStartLength\n\tLDA #$1F\n\tSTA TRI_LINEAR\n\tLDY CurrentMusicTriangleOffset\n\tINC CurrentMusicTriangleOffset\n\tLDA (CurrentMusicPointer), Y\n\tBEQ ProcessMusicQueue_TriangleSetLength\n\nProcessMusicQueue_TriangleNote:\n\tJSR PlayTriangleNote\n\n\tLDX MusicTriangleNoteStartLength\n\tSTX MusicTriangleNoteLength\n\tTXA\n\tCMP #$0A\n\tBCC ProcessMusicQueue_TriangleNoteShort\n\n\tCMP #$1E\n\tBCS ProcessMusicQueue_TriangleNoteLong\n\nProcessMusicQueue_TriangleNoteMedium:\n\tLDA #$24\n\tBNE ProcessMusicQueue_TriangleSetLength\n\nProcessMusicQueue_TriangleNoteShort:\n\tLDA #$18\n\tBNE ProcessMusicQueue_TriangleSetLength\n\nProcessMusicQueue_TriangleNoteLong:\n\tLDA #$6F\n\nProcessMusicQueue_TriangleSetLength:\n\tSTA TRI_LINEAR\n\nProcessMusicQueue_NoiseDPCM:\nIFNDEF EXPAND_MUSIC\n\tIFNDEF PROTOTYPE_MUSIC_UNDERGROUND\n\t\tIFNDEF PROTOTYPE_MUSIC_STARMAN\n\t\t\t; skip to DPCM for underground/invincibility music\n\t\t\tLDA MusicPlaying1\n\t\t\tAND #Music1_Inside | Music1_Invincible\n\t\t\tBNE ProcessMusicQueue_DPCM\n\t\tELSE\n\t\t\t; skip to DPCM for underground music ONLY\n\t\t\tLDA MusicPlaying1\n\t\t\tAND #Music1_Inside\n\t\t\tBNE ProcessMusicQueue_DPCM\n\t\tENDIF\n\tELSE\n\t\tIFNDEF PROTOTYPE_MUSIC_STARMAN\n\t\t\t; no starman, underground\n\t\t\tLDA MusicPlaying1\n\t\t\tAND #Music1_Invincible\n\t\t\tBNE ProcessMusicQueue_DPCM\n\t\tENDIF\n\tENDIF\nENDIF\n\nProcessMusicQueue_Noise:\n\tLDA CurrentMusicNoiseOffset\n\tBEQ ProcessMusicQueue_ThenNoiseEnd\n\n\tDEC MusicNoiseNoteLength\n\tBNE ProcessMusicQueue_ThenNoiseEnd\n\nProcessMusicQueue_NoiseByte:\n\tLDY CurrentMusicNoiseOffset\n\tINC CurrentMusicNoiseOffset\n\tLDA (CurrentMusicPointer), Y\n\tBEQ ProcessMusicQueue_NoiseLoopSegment\n\n\tBPL ProcessMusicQueue_NoiseNote\n\n\tJSR ProcessMusicQueue_PatchNoteLength\n\n\tSTA MusicNoiseNoteStartLength\n\tLDY CurrentMusicNoiseOffset\n\tINC CurrentMusicNoiseOffset\n\tLDA (CurrentMusicPointer), Y\n\tBEQ ProcessMusicQueue_NoiseLoopSegment\n\nProcessMusicQueue_NoiseNote:\n\tLSR A\n\tTAY\n\tLDA NoiseVolTable, Y\n\tSTA NOISE_VOL\n\tLDA NoiseLoTable, Y\n\tSTA NOISE_LO\n\tLDA NoiseHiTable, Y\n\tSTA NOISE_HI\n\tLDA MusicNoiseNoteStartLength\n\tSTA MusicNoiseNoteLength\n\nProcessMusicQueue_ThenNoiseEnd:\n\tJMP ProcessMusicQueue_NoiseEnd\n\nProcessMusicQueue_NoiseLoopSegment:\n\tLDA CurrentMusicNoiseStartOffset\n\tSTA CurrentMusicNoiseOffset\n\tJMP ProcessMusicQueue_NoiseByte\n\nProcessMusicQueue_NoiseEnd:\nIFNDEF EXPAND_MUSIC\n\tLDA MusicPlaying1\n\tIFNDEF PROTOTYPE_MUSIC_STARMAN\n\t\tAND #Music1_Inside | Music1_Invincible\n\tELSE\n\t\tAND #Music1_Inside\n\tENDIF\n\tBNE ProcessMusicQueue_DPCM\n\n\tRTS\nENDIF\n\nProcessMusicQueue_DPCM:\n\tLDA CurrentMusicDPCMOffset\n\tBEQ ProcessMusicQueue_DPCMEnd\n\n\tDEC MusicDPCMNoteLength\n\tBNE ProcessMusicQueue_DPCMEnd\n\nProcessMusicQueue_DPCMByte:\n\tLDY CurrentMusicDPCMOffset\n\tINC CurrentMusicDPCMOffset\n\tLDA (CurrentMusicPointer), Y\n\tBEQ ProcessMusicQueue_DPCMLoopSegment\n\n\tBPL ProcessMusicQueue_DPCMNote\n\n\tJSR ProcessMusicQueue_PatchNoteLength\n\n\tSTA MusicDPCMNoteStartLength\n\tLDY CurrentMusicDPCMOffset\n\tINC CurrentMusicDPCMOffset\n\tLDA (CurrentMusicPointer), Y\n\tBEQ ProcessMusicQueue_DPCMLoopSegment\n\nProcessMusicQueue_DPCMNote:\n\t; POI: This left shift precludes using the first DPCM sample (bomb explosion) in the DPCM track.\n\t; This could be to allow $80 for a \"rest\" note on the DPCM track, but none of the in-game music\n\t; takes advantage of that.\nIFNDEF EXPAND_MUSIC\n\tASL A\nENDIF\n\tSTA DPCMQueue\n\tJSR ProcessDPCMQueue\n\n\tLDA MusicDPCMNoteStartLength\n\tSTA MusicDPCMNoteLength\n\nProcessMusicQueue_DPCMEnd:\n\tRTS\n\nProcessMusicQueue_DPCMLoopSegment:\n\tLDA CurrentMusicDPCMStartOffset\n\tSTA CurrentMusicDPCMOffset\n\tJMP ProcessMusicQueue_DPCMByte\n\n\nNoiseVolTable:\n\t.db $10\n\t.db $1E\n\t.db $1F\n\t.db $16\n\nNoiseLoTable:\n\t.db $00\n\t.db $03\n\t.db $0A\n\t.db $02\n\nNoiseHiTable:\n\t.db $00\n\t.db $18\n\t.db $18\n\t.db $58\n\n\n; Input\n;   A = full patch byte\n; Output\n;   A = new note length\nProcessMusicQueue_PatchNoteLength:\n\tAND #$0F\n\tCLC\n\tADC MusicTempoSetting\n\tTAY\n\tLDA NoteLengthTable, Y\n\tRTS\n\n; Input\n;   A = note start length, >= $13 for table A, < $13 for instrument table B\n; Ouput\n;   A = starting instrument offset ($16 for short, $3F for long)\n;   X = duty/volume/envelope ($82)\n;   Y = sweep ($7F)\n;\nSetInstrumentStartOffset:\n\tCMP #$13\n\tBCC SetInstrumentStartOffset_Short\n\tLDA #$3F\n\tBNE SetInstrumentStartOffset_Exit\nSetInstrumentStartOffset_Short:\n\tLDA #$16\nSetInstrumentStartOffset_Exit:\n\tLDX #$82\n\tLDY #$7F\n\tRTS\n\n;\n; Loads instrument data for a square channel\n;\n; Each instrument has two lookup tables based on the note length.\n;\n; Input\n;   A = note length, >= $13 for table A, < $13 for instrument table B\n;   X = instrument patch\n;   Y = instrument offset\n; Output\n;   A = duty/volume/envelope\n;\nLoadSquareInstrumentDVE:\n\tCPX #$90\n\tBEQ LoadSquareInstrumentDVE_90_E0\n\n\tCPX #$E0\n\tBEQ LoadSquareInstrumentDVE_90_E0\n\n\tCPX #$A0\n\tBEQ LoadSquareInstrumentDVE_A0\n\n\tCPX #$B0\n\tBEQ LoadSquareInstrumentDVE_B0\n\n\tCPX #$C0\n\tBEQ LoadSquareInstrumentDVE_C0\n\n\tCPX #$D0\n\tBEQ LoadSquareInstrumentDVE_D0\n\n\tCPX #$F0\n\tBEQ LoadSquareInstrumentDVE_F0\n\nLoadSquareInstrumentDVE_80:\n\tCMP #$13\n\tBCC LoadSquareInstrumentDVE_80_Short\n\tLDA InstrumentDVE_80, Y\n\tBNE LoadSquareInstrumentDVE_80_Exit\nLoadSquareInstrumentDVE_80_Short:\n\tLDA InstrumentDVE_80_Short, Y\nLoadSquareInstrumentDVE_80_Exit:\n\tRTS\n\nLoadSquareInstrumentDVE_90_E0:\n\tCMP #$13\n\tBCC LoadSquareInstrumentDVE_90_E0_Short\n\tLDA InstrumentDVE_90_E0, Y\n\tBNE LoadSquareInstrumentDVE_90_E0_Exit\nLoadSquareInstrumentDVE_90_E0_Short:\n\tLDA InstrumentDVE_90_E0_Short, Y\nLoadSquareInstrumentDVE_90_E0_Exit:\n\tRTS\n\nLoadSquareInstrumentDVE_A0:\n\tCMP #$13\n\tBCC LoadSquareInstrumentDVE_A0_Short\n\tLDA InstrumentDVE_A0, Y\n\tBNE LoadSquareInstrumentDVE_A0_Exit\nLoadSquareInstrumentDVE_A0_Short:\n\tLDA InstrumentDVE_A0_Short, Y\nLoadSquareInstrumentDVE_A0_Exit:\n\tRTS\n\nLoadSquareInstrumentDVE_B0:\n\tCMP #$13\n\tBCC LoadSquareInstrumentDVE_B0_Short\n\tLDA InstrumentDVE_B0, Y\n\tBNE LoadSquareInstrumentDVE_B0_Exit\nLoadSquareInstrumentDVE_B0_Short:\n\tLDA InstrumentDVE_B0_Short, Y\nLoadSquareInstrumentDVE_B0_Exit:\n\tRTS\n\nLoadSquareInstrumentDVE_C0:\n\tCMP #$13\n\tBCC LoadSquareInstrumentDVE_C0_Short\n\tLDA InstrumentDVE_C0, Y\n\tBNE LoadSquareInstrumentDVE_C0_Exit\nLoadSquareInstrumentDVE_C0_Short:\n\tLDA InstrumentDVE_C0_Short, Y\nLoadSquareInstrumentDVE_C0_Exit:\n\tRTS\n\nLoadSquareInstrumentDVE_F0:\n\tCMP #$13\n\tBCC LoadSquareInstrumentDVE_F0_Short\n\tLDA InstrumentDVE_F0, Y\n\tBNE LoadSquareInstrumentDVE_F0_Exit\nLoadSquareInstrumentDVE_F0_Short:\n\tLDA InstrumentDVE_F0_Short, Y\nLoadSquareInstrumentDVE_F0_Exit:\n\tRTS\n\nLoadSquareInstrumentDVE_D0:\n\tCMP #$13\n\tBCC LoadSquareInstrumentDVE_D0_Short\n\tLDA InstrumentDVE_D0, Y\n\tBNE LoadSquareInstrumentDVE_D0_Exit\nLoadSquareInstrumentDVE_D0_Short:\n\tLDA InstrumentDVE_D0_Short, Y\nLoadSquareInstrumentDVE_D0_Exit:\n\tRTS\n\n\n; Sets volume/sweep on Square 1 channel\n;\n; Input\n;   X = duty/volume/envelope\n;   Y = sweep\nSetSquare1VolumeAndSweep:\n\tSTY SQ1_SWEEP\n\tSTX SQ1_VOL\n\tRTS\n\n; Sets volume/sweep on Square 2 channel\n;\n; Input\n;   X = duty/volume/envelope\n;   Y = sweep\nSetSquare2VolumeAndSweep:\n\tSTX SQ2_VOL\n\tSTY SQ2_SWEEP\n\tRTS\n\n; Sets volume/sweep on Square 1 channel and plays a note\n;\n; Input\n;   A = note\n;   X = duty/volume/envelope\n;   Y = sweep\nPlaySquare1Sweep:\n\tSTX SQ1_VOL\n\tSTY SQ1_SWEEP\n\n; Play a note on the Square 1 channel\n;\n; Input\n;   A = note\nPlaySquare1Note:\n\tLDX #$00\n\n; Plays a note\n;\n; Input\n;   A = note\n;   X = channel\n;       $00: square 1\n;       $04: square 2\n;       $08: triangle\n;       $0C: noise\n; Output\n;   A = $00 for rest, hi frequency otherwise\nPlayNote:\n\tCMP #$7E\n\tBNE PlayNote_NotRest\n\n\tLDA #$10\n\tSTA SQ1_VOL, X\n\tLDA #$00\n\tRTS\n\nPlayNote_NotRest:\n\tLDY #$01\n\tSTY NextOctave\n\tPHA\n\tTAY\n\tBMI PlayNote_LoadFrequencyData\n\nPlayNote_IncrementOctave:\n\tINC NextOctave\n\tSEC\n\tSBC #$18\n\tBPL PlayNote_IncrementOctave\n\nPlayNote_LoadFrequencyData:\n\tCLC\n\tADC #$18\n\tTAY\n\tLDA NoteFrequencyData, Y\n\tSTA NextFrequencyLo\n\tLDA NoteFrequencyData + 1, Y\n\tSTA NextFrequencyHi\n\nPlayNote_FrequencyOctaveLoop:\n\tLSR NextFrequencyHi\n\tROR NextFrequencyLo\n\tDEC NextOctave\n\tBNE PlayNote_FrequencyOctaveLoop\n\n\tPLA\n\tCMP #$38\n\tBCC PlayNote_CheckSquareChorus\n\n\t; tweak the frequency for notes >= $38\n\tDEC NextFrequencyLo\n\n;\n; Square 2 plays slightly detuned when Square 1 is using instrument E0\n;\n; This can be used to achieve a honky tonk piano effect, which is used for the\n; title screen as well as the bridge of the overworld theme.\n;\nPlayNote_CheckSquareChorus:\n\tTXA\n\tCMP #APUOffset_Square2\n\tBNE PlayNote_SetFrequency\n\n\tLDA MusicSquare1Patch\n\tCMP #$E0\n\tBEQ PlayNote_SetFrequency_Square2Detuned\n\nIFDEF EXPAND_MUSIC\n\tLDA MusicSquare1NoteBend, X\n\tBNE NoteBendStashFrequency\nENDIF\n\nPlayNote_SetFrequency:\n\tLDA NextFrequencyLo\n\tSTA SQ1_LO, X\n\tSTA MusicSquare1Lo, X ; unused\n\tLDA NextFrequencyHi\n\tORA #$08\n\tSTA SQ1_HI, X\n\tRTS\n\nPlayNote_SetFrequency_Square2Detuned:\n\tLDA NextFrequencyLo\n\tSEC\n\tSBC #$02\n\tSTA SQ2_LO\n\tSTA MusicSquare2Lo\n\tLDA NextFrequencyHi\n\tORA #$08\n\tSTA SQ2_HI\n\tRTS\n\n; (not referenced)\n; Sets volume/sweep on Square 2 channel and plays a note\n;\n; Input\n;   A = note\n;   X = duty/volume/envelope\n;   Y = sweep\nPlaySquare2Sweep:\n\tSTX SQ2_VOL\n\tSTY SQ2_SWEEP\n\n; Play a note on the Square 2 channel\n;\n; Input\n;   A = note\nPlaySquare2Note:\n\tLDX #APUOffset_Square2\n\tBNE PlayNote\n\n; Play a note on the Triangle channel\n;\n; Input\n;   A = note\nPlayTriangleNote:\n\tLDX #APUOffset_Triangle\n\tBNE PlayNote\n\n\nIFDEF EXPAND_MUSIC\n;\n; Determines whether the currently playing track should stop\n;\n; Input\n;   A = MusicPlaying2\n;\nCheckStopMusic:\n\tCMP #Music1_Overworld\n\tBEQ CheckStopMusic_Resume\n\tCMP #Music1_Inside\n\tBEQ CheckStopMusic_Resume\n\tCMP #Music1_Subspace\n\tBEQ CheckStopMusic_Resume\n\nCheckStopMusic_Stop:\n\tLDA #$00\n\tRTS\n\nCheckStopMusic_Resume:\n\tLDA #$01\n\tRTS\n\n\n;\n; Reads ahead to see if we have a note bend\n;\nCheckSquare2NoteBend:\n\tLDY CurrentMusicSquare2Offset\n\tLDA (CurrentMusicPointer), Y\n\tCMP #$FF\n\tBNE CheckSquare2NoteBend_Exit\n\n\tINC CurrentMusicSquare2Offset\n\n\tLDA MusicSquare2Lo\n\tSTA MusicSquare2NoteBend\n\n\tPLA\n\tPLA\n\tJMP ProcessMusicQueue_Square2NextOffset\n\nCheckSquare2NoteBend_Exit:\n\tRTS\n\n\n;\n; Reads ahead to see if we have a note bend\n;\nCheckSquare1NoteBend:\n\tLDY CurrentMusicSquare1Offset\n\tLDA (CurrentMusicPointer), Y\n\tCMP #$FF\n\tBNE CheckSquare1NoteBend_Exit\n\n\tINC CurrentMusicSquare1Offset\n\n\tLDA MusicSquare1Lo\n\tSTA MusicSquare1NoteBend\n\n\tPLA\n\tPLA\n\tJMP ProcessMusicQueue_Square1NextOffset\n\nCheckSquare1NoteBend_Exit:\n\tRTS\n\n\nNoteBendStashFrequency:\n\t; If bend is in effect, this stores the last set frequency\n\tLDA <NextFrequencyLo\n\tSTA MusicSquare1Lo, X\n\tRTS\n\n\n;\n; Updates note bend\n;\n; Input\n;   A = rest time remaining\n;   X = channel\n;       $00: square 1\n;       $04: square 2\n;\nUpdateNoteBend:\n\tAND #%00000011\n\tCMP #$03\n\tBEQ UpdateNoteBend_AfterDecrement\n\n\tDEC MusicSquare1NoteBend, X\n\nUpdateNoteBend_AfterDecrement:\n\tLDA MusicSquare1NoteBend, X\n\tCMP MusicSquare1Lo, X\n\tBCS UpdateNoteBend_Exit\n\n\tLDA #$00\n\tSTA MusicSquare1NoteBend, X\n\tLDA MusicSquare1Lo, X\n\nUpdateNoteBend_Exit:\n\tSTA SQ1_LO, X\n\tRTS\nENDIF\n\n\n;\n; -------------------------------------------------------------------------\n; Various bits of the music engine have been extracted into separate files;\n; see the individual files for details on the formats within\n;\n\n; Frequency table for notes; standard between various Mario games\n.include \"src/music/frequency-table.asm\";\n\n; Unused space in the original ($875F - $8EFF)\nunusedSpace $8F00, $FF\n\n; Note lengths for various BPM settings\n.include \"src/music/note-lengths.asm\";\n\n; Unused space in the original ($8FB3 - $8FFF)\nunusedSpace $9000, $FF\n\n; Pointers to music segments\nIFNDEF EXPAND_MUSIC\n\t.include \"src/music/music-part-pointers.asm\"\nELSE\n\t.include \"src/music/music-part-pointers-expanded.asm\"\nENDIF\n\n; Headers for songs (BPM, tracks to use, etc)\n.include \"src/music/music-headers.asm\"\n\n; More music pointers\n.include \"src/music/music-pointers.asm\"\n\n; Music and track data\n.include \"src/music/music-data.asm\"\n\n; Instrument data and definitions\n.include \"src/music/instruments.asm\"\n","sections":[{"comment":"\nBank 4 & Bank 5\n===============\n\nWhat's inside:\n\n- Music engine\n- Sound effects engine\n- Sound effect pointers and data\n- Song pointers and data\n- Note length tables (tempos)\n- Instrument tables and data\n","content":"\nStartProcessingSoundQueue:\n\tLDA #$FF\n\tSTA JOY2\n\tLDA StackArea\n\tCMP #Stack100_Pause\n\tBNE ProcessMusicAndSfxQueues\n\n\tLDA #%00001100 ; Mute the two square channels\n\tSTA SND_CHN","htmlComment":"<h1>Bank 4 &#x26; Bank 5</h1>\n<p>What's inside:</p>\n<ul>\n<li>Music engine</li>\n<li>Sound effects engine</li>\n<li>Sound effect pointers and data</li>\n<li>Song pointers and data</li>\n<li>Note length tables (tempos)</li>\n<li>Instrument tables and data</li>\n</ul>\n","htmlContent":"\nStartProcessingSoundQueue:\n\t<span class=\"token opcode property\">LDA</span> <span class=\"token hexnumber string\">#$FF</span>\n\t<span class=\"token opcode property\">STA</span> JOY<span class=\"token decimalnumber string\">2</span>\n\t<span class=\"token opcode property\">LDA</span> StackArea\n\t<span class=\"token opcode property\">CMP</span> #Stack<span class=\"token decimalnumber string\">100</span>_Pause\n\t<span class=\"token opcode property\">BNE</span> ProcessMusicAndSfxQueues\n\n\t<span class=\"token opcode property\">LDA</span> <span class=\"token binarynumber string\">#%00001100</span> <span class=\"token comment\">; Mute the two square channels</span>\n\t<span class=\"token opcode property\">STA</span> SND_CHN","line":14},{"comment":"You would think you could skip processing,\nsince if the game is paused, nothing should\nbe setting new music or whatever.\n\nYou would be correct, except for the suicide code!\nThat sets MusicQueue2.\n\nIf not for processing it, the music would not\nchange (or stop) when you used the code. Welp!","content":"\tJMP ProcessOnlyMusicQueue2\n\n\nProcessMusicAndSfxQueues:\n\tJSR ProcessSoundEffectQueue2\n\n\tJSR ProcessSoundEffectQueue1\n\n\tJSR ProcessSoundEffectQueue3\n\n\tJSR ProcessDPCMQueue\n\nProcessOnlyMusicQueue2:\n\tJSR ProcessMusicQueue\n","htmlComment":"<p>You would think you could skip processing,\nsince if the game is paused, nothing should\nbe setting new music or whatever.</p>\n<p>You would be correct, except for the suicide code!\nThat sets MusicQueue2.</p>\n<p>If not for processing it, the music would not\nchange (or stop) when you used the code. Welp!</p>\n","htmlContent":"\t<span class=\"token opcode property\">JMP</span> ProcessOnlyMusicQueue<span class=\"token decimalnumber string\">2</span>\n\n\nProcessMusicAndSfxQueues:\n\t<span class=\"token opcode property\">JSR</span> ProcessSoundEffectQueue<span class=\"token decimalnumber string\">2</span>\n\n\t<span class=\"token opcode property\">JSR</span> ProcessSoundEffectQueue<span class=\"token decimalnumber string\">1</span>\n\n\t<span class=\"token opcode property\">JSR</span> ProcessSoundEffectQueue<span class=\"token decimalnumber string\">3</span>\n\n\t<span class=\"token opcode property\">JSR</span> ProcessDPCMQueue\n\nProcessOnlyMusicQueue<span class=\"token decimalnumber string\">2</span>:\n\t<span class=\"token opcode property\">JSR</span> ProcessMusicQueue\n","line":33},{"comment":"Reset queues","content":"\tLDA #$00\n\tSTA SoundEffectQueue2\n\tSTA MusicQueue2\n\tSTA SoundEffectQueue1\n\tSTA DPCMQueue\n\tSTA MusicQueue1\n\tSTA SoundEffectQueue3\n\tRTS\n\n\nProcessSoundEffectQueue2_Jump:\n\tLDA #$42\n\tLDX #$82\n\tLDY #$A8\n\tJSR PlaySquare1Sweep\n\n\tLDA #$22\n\tSTA SoundEffectTimer2\n\nProcessSoundEffectQueue2_JumpPart2:\n\tLDA SoundEffectTimer2\n\tCMP #$20\n\tBNE ProcessSoundEffectQueue2_JumpPart3\n\n\tLDX #$DF\n\tLDY #$F6\n\tBNE ProcessSoundEffectQueue2_SetSquare1ThenDecrementTimer\n\nProcessSoundEffectQueue2_JumpPart3:\n\tCMP #$1A\n\tBNE ProcessSoundEffectQueue2_ThenDecrementTimer\n\n\tLDX #$C1\n\tLDY #$BC\n\nProcessSoundEffectQueue2_SetSquare1ThenDecrementTimer:\n\tJSR SetSquare1VolumeAndSweep\n\n\tBNE ProcessSoundEffectQueue2_ThenDecrementTimer\n\nProcessSoundEffectQueue2_CoinGet:\n\tLDA #$35\n\tLDX #$8D\n\tSTA SoundEffectTimer2\n\n\tLDY #$7F\n\tLDA #$5E\n\tJSR PlaySquare1Sweep\n\nProcessSoundEffectQueue2_CoinGetPart2:\n\tLDA SoundEffectTimer2\n\tCMP #$30\n\tBNE ProcessSoundEffectQueue2_ThenDecrementTimer\n\n\tLDA #$54\n\tSTA SQ1_LO\n\nProcessSoundEffectQueue2_ThenDecrementTimer:\n\tBNE ProcessSoundEffectQueue2_DecrementTimer\n\nProcessSoundEffectQueue2:\n\tLDA SoundEffectPlaying2\n\tCMP #SoundEffect2_Climbing\n\tBEQ ProcessSoundEffectQueue2_DecrementTimer\n\n\tLDY SoundEffectQueue2\n\tBEQ ProcessSoundEffectQueue2_None\n\n\tSTY SoundEffectPlaying2\n\tLSR SoundEffectQueue2\n\tBCS ProcessSoundEffectQueue2_Jump\n\n\tLSR SoundEffectQueue2\n\tBCS ProcessSoundEffectQueue2_Climbing\n\n\tLSR SoundEffectQueue2\n\tBCS ProcessSoundEffectQueue2_CoinGet\n\n\tLSR SoundEffectQueue2\n\tBCS ProcessSoundEffectQueue2_Shrinking\n\n\tLSR SoundEffectQueue2\n\tBCS ProcessSoundEffectQueue2_IntroFallSlide\n\n\tLSR SoundEffectQueue2\n\tBCS ProcessSoundEffectQueue2_Growing\n\nProcessSoundEffectQueue2_None:\n\tLDA SoundEffectPlaying2\n\tBEQ ProcessSoundEffectQueue2_NoneExit\n","htmlComment":"<p>Reset queues</p>\n","htmlContent":"\t<span class=\"token opcode property\">LDA</span> <span class=\"token hexnumber string\">#$00</span>\n\t<span class=\"token opcode property\">STA</span> SoundEffectQueue<span class=\"token decimalnumber string\">2</span>\n\t<span class=\"token opcode property\">STA</span> MusicQueue<span class=\"token decimalnumber string\">2</span>\n\t<span class=\"token opcode property\">STA</span> SoundEffectQueue<span class=\"token decimalnumber string\">1</span>\n\t<span class=\"token opcode property\">STA</span> DPCMQueue\n\t<span class=\"token opcode property\">STA</span> MusicQueue<span class=\"token decimalnumber string\">1</span>\n\t<span class=\"token opcode property\">STA</span> SoundEffectQueue<span class=\"token decimalnumber string\">3</span>\n\t<span class=\"token opcode property\">RTS</span>\n\n\nProcessSoundEffectQueue<span class=\"token decimalnumber string\">2</span>_Jump:\n\t<span class=\"token opcode property\">LDA</span> <span class=\"token hexnumber string\">#$42</span>\n\t<span class=\"token opcode property\">LDX</span> <span class=\"token hexnumber string\">#$82</span>\n\t<span class=\"token opcode property\">LDY</span> <span class=\"token hexnumber string\">#$A8</span>\n\t<span class=\"token opcode property\">JSR</span> PlaySquare<span class=\"token decimalnumber string\">1</span>Sweep\n\n\t<span class=\"token opcode property\">LDA</span> <span class=\"token hexnumber string\">#$22</span>\n\t<span class=\"token opcode property\">STA</span> SoundEffectTimer<span class=\"token decimalnumber string\">2</span>\n\nProcessSoundEffectQueue<span class=\"token decimalnumber string\">2</span>_JumpPart<span class=\"token decimalnumber string\">2</span>:\n\t<span class=\"token opcode property\">LDA</span> SoundEffectTimer<span class=\"token decimalnumber string\">2</span>\n\t<span class=\"token opcode property\">CMP</span> <span class=\"token hexnumber string\">#$20</span>\n\t<span class=\"token opcode property\">BNE</span> ProcessSoundEffectQueue<span class=\"token decimalnumber string\">2</span>_JumpPart<span class=\"token decimalnumber string\">3</span>\n\n\t<span class=\"token opcode property\">LDX</span> <span class=\"token hexnumber string\">#$DF</span>\n\t<span class=\"token opcode property\">LDY</span> <span class=\"token hexnumber string\">#$F6</span>\n\t<span class=\"token opcode property\">BNE</span> ProcessSoundEffectQueue<span class=\"token decimalnumber string\">2</span>_SetSquare<span class=\"token decimalnumber string\">1</span>ThenDecrementTimer\n\nProcessSoundEffectQueue<span class=\"token decimalnumber string\">2</span>_JumpPart<span class=\"token decimalnumber string\">3</span>:\n\t<span class=\"token opcode property\">CMP</span> <span class=\"token hexnumber string\">#$1A</span>\n\t<span class=\"token opcode property\">BNE</span> ProcessSoundEffectQueue<span class=\"token decimalnumber string\">2</span>_ThenDecrementTimer\n\n\t<span class=\"token opcode property\">LDX</span> <span class=\"token hexnumber string\">#$C1</span>\n\t<span class=\"token opcode property\">LDY</span> <span class=\"token hexnumber string\">#$BC</span>\n\nProcessSoundEffectQueue<span class=\"token decimalnumber string\">2</span>_SetSquare<span class=\"token decimalnumber string\">1</span>ThenDecrementTimer:\n\t<span class=\"token opcode property\">JSR</span> SetSquare<span class=\"token decimalnumber string\">1</span>VolumeAndSweep\n\n\t<span class=\"token opcode property\">BNE</span> ProcessSoundEffectQueue<span class=\"token decimalnumber string\">2</span>_ThenDecrementTimer\n\nProcessSoundEffectQueue<span class=\"token decimalnumber string\">2</span>_CoinGet:\n\t<span class=\"token opcode property\">LDA</span> <span class=\"token hexnumber string\">#$35</span>\n\t<span class=\"token opcode property\">LDX</span> <span class=\"token hexnumber string\">#$8D</span>\n\t<span class=\"token opcode property\">STA</span> SoundEffectTimer<span class=\"token decimalnumber string\">2</span>\n\n\t<span class=\"token opcode property\">LDY</span> <span class=\"token hexnumber string\">#$7F</span>\n\t<span class=\"token opcode property\">LDA</span> <span class=\"token hexnumber string\">#$5E</span>\n\t<span class=\"token opcode property\">JSR</span> PlaySquare<span class=\"token decimalnumber string\">1</span>Sweep\n\nProcessSoundEffectQueue<span class=\"token decimalnumber string\">2</span>_CoinGetPart<span class=\"token decimalnumber string\">2</span>:\n\t<span class=\"token opcode property\">LDA</span> SoundEffectTimer<span class=\"token decimalnumber string\">2</span>\n\t<span class=\"token opcode property\">CMP</span> <span class=\"token hexnumber string\">#$30</span>\n\t<span class=\"token opcode property\">BNE</span> ProcessSoundEffectQueue<span class=\"token decimalnumber string\">2</span>_ThenDecrementTimer\n\n\t<span class=\"token opcode property\">LDA</span> <span class=\"token hexnumber string\">#$54</span>\n\t<span class=\"token opcode property\">STA</span> SQ<span class=\"token decimalnumber string\">1</span>_LO\n\nProcessSoundEffectQueue<span class=\"token decimalnumber string\">2</span>_ThenDecrementTimer:\n\t<span class=\"token opcode property\">BNE</span> ProcessSoundEffectQueue<span class=\"token decimalnumber string\">2</span>_DecrementTimer\n\nProcessSoundEffectQueue<span class=\"token decimalnumber string\">2</span>:\n\t<span class=\"token opcode property\">LDA</span> SoundEffectPlaying<span class=\"token decimalnumber string\">2</span>\n\t<span class=\"token opcode property\">CMP</span> #SoundEffect<span class=\"token decimalnumber string\">2</span>_Climbing\n\t<span class=\"token opcode property\">BEQ</span> ProcessSoundEffectQueue<span class=\"token decimalnumber string\">2</span>_DecrementTimer\n\n\t<span class=\"token opcode property\">LDY</span> SoundEffectQueue<span class=\"token decimalnumber string\">2</span>\n\t<span class=\"token opcode property\">BEQ</span> ProcessSoundEffectQueue<span class=\"token decimalnumber string\">2</span>_None\n\n\t<span class=\"token opcode property\">STY</span> SoundEffectPlaying<span class=\"token decimalnumber string\">2</span>\n\t<span class=\"token opcode property\">LSR</span> SoundEffectQueue<span class=\"token decimalnumber string\">2</span>\n\t<span class=\"token opcode property\">BCS</span> ProcessSoundEffectQueue<span class=\"token decimalnumber string\">2</span>_Jump\n\n\t<span class=\"token opcode property\">LSR</span> SoundEffectQueue<span class=\"token decimalnumber string\">2</span>\n\t<span class=\"token opcode property\">BCS</span> ProcessSoundEffectQueue<span class=\"token decimalnumber string\">2</span>_Climbing\n\n\t<span class=\"token opcode property\">LSR</span> SoundEffectQueue<span class=\"token decimalnumber string\">2</span>\n\t<span class=\"token opcode property\">BCS</span> ProcessSoundEffectQueue<span class=\"token decimalnumber string\">2</span>_CoinGet\n\n\t<span class=\"token opcode property\">LSR</span> SoundEffectQueue<span class=\"token decimalnumber string\">2</span>\n\t<span class=\"token opcode property\">BCS</span> ProcessSoundEffectQueue<span class=\"token decimalnumber string\">2</span>_Shrinking\n\n\t<span class=\"token opcode property\">LSR</span> SoundEffectQueue<span class=\"token decimalnumber string\">2</span>\n\t<span class=\"token opcode property\">BCS</span> ProcessSoundEffectQueue<span class=\"token decimalnumber string\">2</span>_IntroFallSlide\n\n\t<span class=\"token opcode property\">LSR</span> SoundEffectQueue<span class=\"token decimalnumber string\">2</span>\n\t<span class=\"token opcode property\">BCS</span> ProcessSoundEffectQueue<span class=\"token decimalnumber string\">2</span>_Growing\n\nProcessSoundEffectQueue<span class=\"token decimalnumber string\">2</span>_None:\n\t<span class=\"token opcode property\">LDA</span> SoundEffectPlaying<span class=\"token decimalnumber string\">2</span>\n\t<span class=\"token opcode property\">BEQ</span> ProcessSoundEffectQueue<span class=\"token decimalnumber string\">2</span>_NoneExit\n","line":49},{"comment":"Jumping","content":"\tLSR A\n\tBCS ProcessSoundEffectQueue2_JumpPart2\n","htmlComment":"<p>Jumping</p>\n","htmlContent":"\t<span class=\"token opcode property\">LSR</span> <span class=\"token register variable\">A</span>\n\t<span class=\"token opcode property\">BCS</span> ProcessSoundEffectQueue<span class=\"token decimalnumber string\">2</span>_JumpPart<span class=\"token decimalnumber string\">2</span>\n","line":141},{"comment":"Climbing","content":"\tLSR A\n\tBCS ProcessSoundEffectQueue2_DecrementTimer\n","htmlComment":"<p>Climbing</p>\n","htmlContent":"\t<span class=\"token opcode property\">LSR</span> <span class=\"token register variable\">A</span>\n\t<span class=\"token opcode property\">BCS</span> ProcessSoundEffectQueue<span class=\"token decimalnumber string\">2</span>_DecrementTimer\n","line":145},{"comment":"CoinGet","content":"\tLSR A\n\tBCS ProcessSoundEffectQueue2_CoinGetPart2\n","htmlComment":"<p>CoinGet</p>\n","htmlContent":"\t<span class=\"token opcode property\">LSR</span> <span class=\"token register variable\">A</span>\n\t<span class=\"token opcode property\">BCS</span> ProcessSoundEffectQueue<span class=\"token decimalnumber string\">2</span>_CoinGetPart<span class=\"token decimalnumber string\">2</span>\n","line":149},{"comment":"Shrinking","content":"\tLSR A\n\tBCS ProcessSoundEffectQueue2_ShrinkingPart2\n","htmlComment":"<p>Shrinking</p>\n","htmlContent":"\t<span class=\"token opcode property\">LSR</span> <span class=\"token register variable\">A</span>\n\t<span class=\"token opcode property\">BCS</span> ProcessSoundEffectQueue<span class=\"token decimalnumber string\">2</span>_ShrinkingPart<span class=\"token decimalnumber string\">2</span>\n","line":153},{"comment":"IntroFallSlide","content":"\tLSR A\n\tBCS ProcessSoundEffectQueue2_DecrementTimer\n","htmlComment":"<p>IntroFallSlide</p>\n","htmlContent":"\t<span class=\"token opcode property\">LSR</span> <span class=\"token register variable\">A</span>\n\t<span class=\"token opcode property\">BCS</span> ProcessSoundEffectQueue<span class=\"token decimalnumber string\">2</span>_DecrementTimer\n","line":157},{"comment":"Growing","content":"\tLSR A\n\tBCS ProcessSoundEffectQueue2_GrowingPart2\n\nProcessSoundEffectQueue2_NoneExit:\n\tRTS\n\nProcessSoundEffectQueue2_IntroFallSlide:\n\tLDA #$60\n\tLDY #$A5\n\tBNE ProcessSoundEffectQueue2_SingleSweep\n\nProcessSoundEffectQueue2_Climbing:\n\tSTY SoundEffectPlaying2\n\tLDA #$05\n\tLDY #$9C\n","htmlComment":"<p>Growing</p>\n","htmlContent":"\t<span class=\"token opcode property\">LSR</span> <span class=\"token register variable\">A</span>\n\t<span class=\"token opcode property\">BCS</span> ProcessSoundEffectQueue<span class=\"token decimalnumber string\">2</span>_GrowingPart<span class=\"token decimalnumber string\">2</span>\n\nProcessSoundEffectQueue<span class=\"token decimalnumber string\">2</span>_NoneExit:\n\t<span class=\"token opcode property\">RTS</span>\n\nProcessSoundEffectQueue<span class=\"token decimalnumber string\">2</span>_IntroFallSlide:\n\t<span class=\"token opcode property\">LDA</span> <span class=\"token hexnumber string\">#$60</span>\n\t<span class=\"token opcode property\">LDY</span> <span class=\"token hexnumber string\">#$A5</span>\n\t<span class=\"token opcode property\">BNE</span> ProcessSoundEffectQueue<span class=\"token decimalnumber string\">2</span>_SingleSweep\n\nProcessSoundEffectQueue<span class=\"token decimalnumber string\">2</span>_Climbing:\n\t<span class=\"token opcode property\">STY</span> SoundEffectPlaying<span class=\"token decimalnumber string\">2</span>\n\t<span class=\"token opcode property\">LDA</span> <span class=\"token hexnumber string\">#$05</span>\n\t<span class=\"token opcode property\">LDY</span> <span class=\"token hexnumber string\">#$9C</span>\n","line":161},{"comment":"A = timer\nY = sweep","content":"ProcessSoundEffectQueue2_SingleSweep:\n\tLDX #$9E\n\tSTA SoundEffectTimer2\n\tLDA #$60\n\tJSR PlaySquare1Sweep\n\nProcessSoundEffectQueue2_DecrementTimer:\n\tDEC SoundEffectTimer2\n\tBNE ProcessSoundEffectQueue2_Exit\n\n\tLDX #%00001110\n\tSTX SND_CHN\n\tLDX #%00001111\n\tSTX SND_CHN\n\tLDX #$00\n\tSTX SoundEffectPlaying2\n\nProcessSoundEffectQueue2_Exit:\n\tRTS\n\nProcessSoundEffectQueue2_Shrinking:\n\tLDA #$2F\n\tSTA SoundEffectTimer2\n\nProcessSoundEffectQueue2_ShrinkingPart2:\n\tLDA SoundEffectTimer2\n\tLSR A\n\tBCS ProcessSoundEffectQueue2_ShrinkingPart3\n\n\tLSR A\n\tBCS ProcessSoundEffectQueue2_ShrinkingPart3\n\n\tAND #$02\n\tBEQ ProcessSoundEffectQueue2_ShrinkingPart3\n\n\tLDY #$91\n\tLDX #$9A\n\tLDA #$68\n\tJSR PlaySquare1Sweep\n\nProcessSoundEffectQueue2_ShrinkingPart3:\n\tJMP ProcessSoundEffectQueue2_DecrementTimer\n\nProcessSoundEffectQueue2_Growing:\n\tLDA #$36\n\tSTA SoundEffectTimer2\n\nProcessSoundEffectQueue2_GrowingPart2:\n\tLDA SoundEffectTimer2\n\tLSR A\n\tBCS ProcessSoundEffectQueue2_DecrementTimer\n\n\tTAY\n\tLDA MushroomSoundData - 1, Y\n\tLDX #$5D\n\tLDY #$7F\n\tJSR PlaySquare1Sweep\n\n\tJMP ProcessSoundEffectQueue2_DecrementTimer\n\nMushroomSoundData:\n\t.db $6A, $74, $6A, $64, $5C, $52, $5C, $52, $4C, $44, $66, $70, $66, $60, $58, $4E\n\t.db $58, $4E, $48, $40, $56, $60, $56, $50, $48, $3E, $48, $3E, $38, $30 ; $10\n\n\nProcessSoundEffectQueue1:\n\tLDA SoundEffectQueue1\n\tBEQ ProcessSoundEffectQueue1_None\n\n\tCMP #SoundEffect1_StopwatchTick\n\tBNE ProcessSoundEffectQueue1_Part2\n\n\tLDX SoundEffectPlaying1\n\tBEQ ProcessSoundEffectQueue1_Part2\n\nProcessSoundEffectQueue1_None:\n\tLDA SoundEffectPlaying1\n\tBNE ProcessSoundEffectQueue1_Part3\n\n\tRTS\n\nProcessSoundEffectQueue1_Part2:\n\tSTA SoundEffectPlaying1\n\tLDY #$00\n\nProcessSoundEffectQueue1_PointerLoop:\n\tINY\n\tLSR A\n\tBCC ProcessSoundEffectQueue1_PointerLoop\n\n\tLDA SoundEffectPointers - 1, Y\n\tSTA SoundEffect1DataOffset\n\nProcessSoundEffectQueue1_Part3:\n\tLDY SoundEffect1DataOffset\n\tINC SoundEffect1DataOffset\n\tLDA SoundEffectPointers, Y\n\tBMI ProcessSoundEffectQueue1_Patch\n\n\tBNE ProcessSoundEffectQueue1_Note\n","htmlComment":"<p>A = timer\nY = sweep</p>\n","htmlContent":"ProcessSoundEffectQueue<span class=\"token decimalnumber string\">2</span>_SingleSweep:\n\t<span class=\"token opcode property\">LDX</span> <span class=\"token hexnumber string\">#$9E</span>\n\t<span class=\"token opcode property\">STA</span> SoundEffectTimer<span class=\"token decimalnumber string\">2</span>\n\t<span class=\"token opcode property\">LDA</span> <span class=\"token hexnumber string\">#$60</span>\n\t<span class=\"token opcode property\">JSR</span> PlaySquare<span class=\"token decimalnumber string\">1</span>Sweep\n\nProcessSoundEffectQueue<span class=\"token decimalnumber string\">2</span>_DecrementTimer:\n\t<span class=\"token opcode property\">DEC</span> SoundEffectTimer<span class=\"token decimalnumber string\">2</span>\n\t<span class=\"token opcode property\">BNE</span> ProcessSoundEffectQueue<span class=\"token decimalnumber string\">2</span>_Exit\n\n\t<span class=\"token opcode property\">LDX</span> <span class=\"token binarynumber string\">#%00001110</span>\n\t<span class=\"token opcode property\">STX</span> SND_CHN\n\t<span class=\"token opcode property\">LDX</span> <span class=\"token binarynumber string\">#%00001111</span>\n\t<span class=\"token opcode property\">STX</span> SND_CHN\n\t<span class=\"token opcode property\">LDX</span> <span class=\"token hexnumber string\">#$00</span>\n\t<span class=\"token opcode property\">STX</span> SoundEffectPlaying<span class=\"token decimalnumber string\">2</span>\n\nProcessSoundEffectQueue<span class=\"token decimalnumber string\">2</span>_Exit:\n\t<span class=\"token opcode property\">RTS</span>\n\nProcessSoundEffectQueue<span class=\"token decimalnumber string\">2</span>_Shrinking:\n\t<span class=\"token opcode property\">LDA</span> <span class=\"token hexnumber string\">#$2F</span>\n\t<span class=\"token opcode property\">STA</span> SoundEffectTimer<span class=\"token decimalnumber string\">2</span>\n\nProcessSoundEffectQueue<span class=\"token decimalnumber string\">2</span>_ShrinkingPart<span class=\"token decimalnumber string\">2</span>:\n\t<span class=\"token opcode property\">LDA</span> SoundEffectTimer<span class=\"token decimalnumber string\">2</span>\n\t<span class=\"token opcode property\">LSR</span> <span class=\"token register variable\">A</span>\n\t<span class=\"token opcode property\">BCS</span> ProcessSoundEffectQueue<span class=\"token decimalnumber string\">2</span>_ShrinkingPart<span class=\"token decimalnumber string\">3</span>\n\n\t<span class=\"token opcode property\">LSR</span> <span class=\"token register variable\">A</span>\n\t<span class=\"token opcode property\">BCS</span> ProcessSoundEffectQueue<span class=\"token decimalnumber string\">2</span>_ShrinkingPart<span class=\"token decimalnumber string\">3</span>\n\n\t<span class=\"token opcode property\">AND</span> <span class=\"token hexnumber string\">#$02</span>\n\t<span class=\"token opcode property\">BEQ</span> ProcessSoundEffectQueue<span class=\"token decimalnumber string\">2</span>_ShrinkingPart<span class=\"token decimalnumber string\">3</span>\n\n\t<span class=\"token opcode property\">LDY</span> <span class=\"token hexnumber string\">#$91</span>\n\t<span class=\"token opcode property\">LDX</span> <span class=\"token hexnumber string\">#$9A</span>\n\t<span class=\"token opcode property\">LDA</span> <span class=\"token hexnumber string\">#$68</span>\n\t<span class=\"token opcode property\">JSR</span> PlaySquare<span class=\"token decimalnumber string\">1</span>Sweep\n\nProcessSoundEffectQueue<span class=\"token decimalnumber string\">2</span>_ShrinkingPart<span class=\"token decimalnumber string\">3</span>:\n\t<span class=\"token opcode property\">JMP</span> ProcessSoundEffectQueue<span class=\"token decimalnumber string\">2</span>_DecrementTimer\n\nProcessSoundEffectQueue<span class=\"token decimalnumber string\">2</span>_Growing:\n\t<span class=\"token opcode property\">LDA</span> <span class=\"token hexnumber string\">#$36</span>\n\t<span class=\"token opcode property\">STA</span> SoundEffectTimer<span class=\"token decimalnumber string\">2</span>\n\nProcessSoundEffectQueue<span class=\"token decimalnumber string\">2</span>_GrowingPart<span class=\"token decimalnumber string\">2</span>:\n\t<span class=\"token opcode property\">LDA</span> SoundEffectTimer<span class=\"token decimalnumber string\">2</span>\n\t<span class=\"token opcode property\">LSR</span> <span class=\"token register variable\">A</span>\n\t<span class=\"token opcode property\">BCS</span> ProcessSoundEffectQueue<span class=\"token decimalnumber string\">2</span>_DecrementTimer\n\n\t<span class=\"token opcode property\">TAY</span>\n\t<span class=\"token opcode property\">LDA</span> MushroomSoundData - <span class=\"token decimalnumber string\">1</span>, <span class=\"token register variable\">Y</span>\n\t<span class=\"token opcode property\">LDX</span> <span class=\"token hexnumber string\">#$5D</span>\n\t<span class=\"token opcode property\">LDY</span> <span class=\"token hexnumber string\">#$7F</span>\n\t<span class=\"token opcode property\">JSR</span> PlaySquare<span class=\"token decimalnumber string\">1</span>Sweep\n\n\t<span class=\"token opcode property\">JMP</span> ProcessSoundEffectQueue<span class=\"token decimalnumber string\">2</span>_DecrementTimer\n\nMushroomSoundData:\n\t<span class=\"token directive keyword\">.db</span> <span class=\"token hexnumber string\">$6A</span>, <span class=\"token hexnumber string\">$74</span>, <span class=\"token hexnumber string\">$6A</span>, <span class=\"token hexnumber string\">$64</span>, <span class=\"token hexnumber string\">$5C</span>, <span class=\"token hexnumber string\">$52</span>, <span class=\"token hexnumber string\">$5C</span>, <span class=\"token hexnumber string\">$52</span>, <span class=\"token hexnumber string\">$4C</span>, <span class=\"token hexnumber string\">$44</span>, <span class=\"token hexnumber string\">$66</span>, <span class=\"token hexnumber string\">$70</span>, <span class=\"token hexnumber string\">$66</span>, <span class=\"token hexnumber string\">$60</span>, <span class=\"token hexnumber string\">$58</span>, <span class=\"token hexnumber string\">$4E</span>\n\t<span class=\"token directive keyword\">.db</span> <span class=\"token hexnumber string\">$58</span>, <span class=\"token hexnumber string\">$4E</span>, <span class=\"token hexnumber string\">$48</span>, <span class=\"token hexnumber string\">$40</span>, <span class=\"token hexnumber string\">$56</span>, <span class=\"token hexnumber string\">$60</span>, <span class=\"token hexnumber string\">$56</span>, <span class=\"token hexnumber string\">$50</span>, <span class=\"token hexnumber string\">$48</span>, <span class=\"token hexnumber string\">$3E</span>, <span class=\"token hexnumber string\">$48</span>, <span class=\"token hexnumber string\">$3E</span>, <span class=\"token hexnumber string\">$38</span>, <span class=\"token hexnumber string\">$30</span> <span class=\"token comment\">; $10</span>\n\n\nProcessSoundEffectQueue<span class=\"token decimalnumber string\">1</span>:\n\t<span class=\"token opcode property\">LDA</span> SoundEffectQueue<span class=\"token decimalnumber string\">1</span>\n\t<span class=\"token opcode property\">BEQ</span> ProcessSoundEffectQueue<span class=\"token decimalnumber string\">1</span>_None\n\n\t<span class=\"token opcode property\">CMP</span> #SoundEffect<span class=\"token decimalnumber string\">1</span>_StopwatchTick\n\t<span class=\"token opcode property\">BNE</span> ProcessSoundEffectQueue<span class=\"token decimalnumber string\">1</span>_Part<span class=\"token decimalnumber string\">2</span>\n\n\t<span class=\"token opcode property\">LDX</span> SoundEffectPlaying<span class=\"token decimalnumber string\">1</span>\n\t<span class=\"token opcode property\">BEQ</span> ProcessSoundEffectQueue<span class=\"token decimalnumber string\">1</span>_Part<span class=\"token decimalnumber string\">2</span>\n\nProcessSoundEffectQueue<span class=\"token decimalnumber string\">1</span>_None:\n\t<span class=\"token opcode property\">LDA</span> SoundEffectPlaying<span class=\"token decimalnumber string\">1</span>\n\t<span class=\"token opcode property\">BNE</span> ProcessSoundEffectQueue<span class=\"token decimalnumber string\">1</span>_Part<span class=\"token decimalnumber string\">3</span>\n\n\t<span class=\"token opcode property\">RTS</span>\n\nProcessSoundEffectQueue<span class=\"token decimalnumber string\">1</span>_Part<span class=\"token decimalnumber string\">2</span>:\n\t<span class=\"token opcode property\">STA</span> SoundEffectPlaying<span class=\"token decimalnumber string\">1</span>\n\t<span class=\"token opcode property\">LDY</span> <span class=\"token hexnumber string\">#$00</span>\n\nProcessSoundEffectQueue<span class=\"token decimalnumber string\">1</span>_PointerLoop:\n\t<span class=\"token opcode property\">INY</span>\n\t<span class=\"token opcode property\">LSR</span> <span class=\"token register variable\">A</span>\n\t<span class=\"token opcode property\">BCC</span> ProcessSoundEffectQueue<span class=\"token decimalnumber string\">1</span>_PointerLoop\n\n\t<span class=\"token opcode property\">LDA</span> SoundEffectPointers - <span class=\"token decimalnumber string\">1</span>, <span class=\"token register variable\">Y</span>\n\t<span class=\"token opcode property\">STA</span> SoundEffect<span class=\"token decimalnumber string\">1</span>DataOffset\n\nProcessSoundEffectQueue<span class=\"token decimalnumber string\">1</span>_Part<span class=\"token decimalnumber string\">3</span>:\n\t<span class=\"token opcode property\">LDY</span> SoundEffect<span class=\"token decimalnumber string\">1</span>DataOffset\n\t<span class=\"token opcode property\">INC</span> SoundEffect<span class=\"token decimalnumber string\">1</span>DataOffset\n\t<span class=\"token opcode property\">LDA</span> SoundEffectPointers, <span class=\"token register variable\">Y</span>\n\t<span class=\"token opcode property\">BMI</span> ProcessSoundEffectQueue<span class=\"token decimalnumber string\">1</span>_Patch\n\n\t<span class=\"token opcode property\">BNE</span> ProcessSoundEffectQueue<span class=\"token decimalnumber string\">1</span>_Note\n","line":179},{"comment":"if it was $00, we're at the end of the data for this sound effect","content":"\tLDX #$90\n\tSTX SQ2_VOL\n\tLDX #$18\n\tSTX SQ2_HI\n\tLDX #$00\n\tSTX SQ2_LO\n\tSTX SoundEffectPlaying1\n\tRTS\n\nProcessSoundEffectQueue1_Patch:\n\tSTA SQ2_VOL\n\tLDY SoundEffect1DataOffset\n\tINC SoundEffect1DataOffset\n\tLDA SoundEffectPointers, Y\n\nProcessSoundEffectQueue1_Note:\n\tCMP #$7E\n\tBEQ ProcessSoundEffectQueue1_Exit\n\n\tJSR PlaySquare2Note\n\nProcessSoundEffectQueue1_Exit:\n\tLDA #$7F\n\tSTA SQ2_SWEEP\n\n\tRTS\n\n","htmlComment":"<p>if it was $00, we're at the end of the data for this sound effect</p>\n","htmlContent":"\t<span class=\"token opcode property\">LDX</span> <span class=\"token hexnumber string\">#$90</span>\n\t<span class=\"token opcode property\">STX</span> SQ<span class=\"token decimalnumber string\">2</span>_VOL\n\t<span class=\"token opcode property\">LDX</span> <span class=\"token hexnumber string\">#$18</span>\n\t<span class=\"token opcode property\">STX</span> SQ<span class=\"token decimalnumber string\">2</span>_HI\n\t<span class=\"token opcode property\">LDX</span> <span class=\"token hexnumber string\">#$00</span>\n\t<span class=\"token opcode property\">STX</span> SQ<span class=\"token decimalnumber string\">2</span>_LO\n\t<span class=\"token opcode property\">STX</span> SoundEffectPlaying<span class=\"token decimalnumber string\">1</span>\n\t<span class=\"token opcode property\">RTS</span>\n\nProcessSoundEffectQueue<span class=\"token decimalnumber string\">1</span>_Patch:\n\t<span class=\"token opcode property\">STA</span> SQ<span class=\"token decimalnumber string\">2</span>_VOL\n\t<span class=\"token opcode property\">LDY</span> SoundEffect<span class=\"token decimalnumber string\">1</span>DataOffset\n\t<span class=\"token opcode property\">INC</span> SoundEffect<span class=\"token decimalnumber string\">1</span>DataOffset\n\t<span class=\"token opcode property\">LDA</span> SoundEffectPointers, <span class=\"token register variable\">Y</span>\n\nProcessSoundEffectQueue<span class=\"token decimalnumber string\">1</span>_Note:\n\t<span class=\"token opcode property\">CMP</span> <span class=\"token hexnumber string\">#$7E</span>\n\t<span class=\"token opcode property\">BEQ</span> ProcessSoundEffectQueue<span class=\"token decimalnumber string\">1</span>_Exit\n\n\t<span class=\"token opcode property\">JSR</span> PlaySquare<span class=\"token decimalnumber string\">2</span>Note\n\nProcessSoundEffectQueue<span class=\"token decimalnumber string\">1</span>_Exit:\n\t<span class=\"token opcode property\">LDA</span> <span class=\"token hexnumber string\">#$7F</span>\n\t<span class=\"token opcode property\">STA</span> SQ<span class=\"token decimalnumber string\">2</span>_SWEEP\n\n\t<span class=\"token opcode property\">RTS</span>\n\n","line":281},{"comment":"\nSound effect data\n","content":".include \"src/music/sound-effect-data.asm\"\n\n\nProcessSoundEffectQueue3_ShortNoise:\n\tLDA #$02\n\tSTA SoundEffectTimer3\n\nProcessSoundEffectQueue3_ShortNoisePart2:\n\tLDA #$1A\n\tSTA NOISE_VOL\n\tLDA #$04\n\tSTA NOISE_LO\n\tSTA NOISE_HI\n\tBNE ProcessSoundEffectQueue3_DecrementTimer\n\nProcessSoundEffectQueue3:\n\tLDY SoundEffectQueue3\n\tBEQ ProcessSoundEffectQueue3_Part2\n\n\tSTY SoundEffectPlaying3\n\tLSR SoundEffectQueue3\n\tBCS ProcessSoundEffectQueue3_ShortNoise\n\n\tLSR SoundEffectQueue3\n\tBCS ProcessSoundEffectQueue3_Rumble\n\n\tLSR SoundEffectQueue3\n\tBCS ProcessSoundEffectQueue3_Rumble\n\nProcessSoundEffectQueue3_Part2:\n\tLDA SoundEffectPlaying3\n\tLSR A\n\tBCS ProcessSoundEffectQueue3_ShortNoisePart2\n\n\tLSR A\n\tBCS ProcessSoundEffectQueue3_RumblePart2\n\n\tLSR A\n\tBCS ProcessSoundEffectQueue3_RumblePart2\n\n\tRTS\n\nProcessSoundEffectQueue3_Rumble:\n\tLDA #$7F\n\tSTA SoundEffectTimer3\n\nProcessSoundEffectQueue3_RumblePart2:\n\tLDY SoundEffectTimer3\n\tLDA ProcessMusicQueue, Y ; weird, but i guess that's one way to get \"random\" noise\n\tORA #$0C\n\tSTA NOISE_LO\n\tLDA SoundEffectTimer3\n\tLSR A\n\tLSR A\n\tLSR A\n\tAND #$1F\n\tORA #$10\n\tSTA NOISE_VOL\n\tLDA #$18\n\tSTA NOISE_HI\n\nProcessSoundEffectQueue3_DecrementTimer:\n\tDEC SoundEffectTimer3\n\tBNE ProcessSoundEffectQueue3_Exit\n\n\tLDX #$07\n\tSTX SND_CHN\n\tLDX #$0F\n\tSTX SND_CHN\n\tLDX #$00\n\tSTX SoundEffectPlaying3\n\nProcessSoundEffectQueue3_Exit:\n\tRTS\n\n\nProcessDPCMQueue:\n\tLDA DPCMQueue\n\tBNE ProcessDPCMQueue_Part2\n\n\tLDA DPCMPlaying\n\tBEQ ProcessDPCMQueue_None\n\n\tDEC DPCMTimer\n\tBNE ProcessDPCMQueue_Exit\n\nProcessDPCMQueue_None:\n\tLDA #$00\n\tSTA DPCMPlaying\n\tLDA #%00001111\n\tSTA SND_CHN\n\nProcessDPCMQueue_Exit:\n\tRTS\n\nProcessDPCMQueue_Part2:\n\tSTA DPCMPlaying\nIFDEF EXPAND_MUSIC\n\tCMP #$7E\n\tBNE ProcessDPCMQueue_LookUpSample\n\n\tLDA #$A0\n\tSTA DPCMTimer\n\tRTS\n\nProcessDPCMQueue_LookUpSample:\nENDIF\n\tLDY #$00\n\nIFNDEF EXPAND_MUSIC\nProcessDPCMQueue_PointerLoop:\n\tINY\n\tLSR A\n\tBCC ProcessDPCMQueue_PointerLoop\nELSE\n\tTAY\nENDIF\n\n\tLDA DMCFreqTable - 1, Y\n\tSTA DMC_FREQ\n\n\tLDA DMCStartTable - 1, Y\n\tSTA DMC_START\n\tLDA DMCLengthTable - 1, Y\n\tSTA DMC_LEN\n\tLDA #$A0\n\tSTA DPCMTimer\n\tLDA #%00001111\n\tSTA SND_CHN\n\tLDA #%00011111\n\tSTA SND_CHN\n\tRTS\n\n\nDMCStartTable:\n\t.db (DPCMSampleData_DoorOpenBombBom - DPCMSampleData)/64 ; $4F\n\t.db (DPCMSampleData_DrumSample - DPCMSampleData)/64 ; $60\n\t.db (DPCMSampleData_PlayerHurt - DPCMSampleData)/64 ; $4B\n\t.db (DPCMSampleData_ItemPull - DPCMSampleData)/64 ; $00\n\t.db (DPCMSampleData_BossDeath - DPCMSampleData)/64 ; $31\n\t.db (DPCMSampleData_DrumSample - DPCMSampleData)/64 ; $60\n\t.db (DPCMSampleData_BossHurt - DPCMSampleData)/64 ; $0E\n\t.db (DPCMSampleData_PlayerDeath - DPCMSampleData)/64 ; $1D\n\nDMCLengthTable:\n\t.db (DPCMSampleDataEnd_DoorOpenBombBom - DPCMSampleData_DoorOpenBombBom)/16 ; $43\n\t.db (DPCMSampleDataEnd_DrumSample_A - DPCMSampleData_DrumSample)/16 ; $14\n\t.db (DPCMSampleDataEnd_PlayerHurt - DPCMSampleData_PlayerHurt)/16 ; $10\n\t.db (DPCMSampleDataEnd_ItemPull - DPCMSampleData_ItemPull)/16 ; $38\n\t.db (DPCMSampleDataEnd_BossDeath - DPCMSampleData_BossDeath)/16 ; $48\n\t.db (DPCMSampleDataEnd_DrumSample_B - DPCMSampleData_DrumSample)/16 ; $28\n\t.db (DPCMSampleDataEnd_BossHurt - DPCMSampleData_BossHurt)/16 ; $3C\n\t.db (DPCMSampleDataEnd_PlayerDeath - DPCMSampleData_PlayerDeath)/16 ; $50\n\nDMCFreqTable:\n\t.db $0E\n\t.db $0E\n\t.db $0F\n\t.db $0F\n\t.db $0F\n\t.db $0F\n\t.db $0F\n\t.db $0F\n\t.db $60 ; ???\n\n\nProcessMusicQueue_ThenReadNoteData:\n\tJMP ProcessMusicQueue_ReadNoteData\n\nProcessMusicQueue_StopMusic:\n\tJMP StopMusic\n\nProcessMusicQueue:\n\tLDA MusicQueue2\n\tBMI ProcessMusicQueue_StopMusic\n\n\tCMP #Music2_EndingAndCast\n\tBEQ ProcessMusicQueue_EndingAndCast\n\n\tLDA MusicQueue2\n\tBNE ProcessMusicQueue_Part2\n\n\tLDA MusicQueue1\n\tBNE ProcessMusicQueue_MusicQueue1\n\n\tLDA MusicPlaying2\n\tORA MusicPlaying1\n\tBNE ProcessMusicQueue_ThenReadNoteData\n\n\tRTS\n\nProcessMusicQueue_EndingAndCast:\n\tSTA MusicPlaying2\n\tLDY #$00\n\tSTY MusicPlaying1\n\tLDY #$08 ; index of ending music pointer\n\tBNE ProcessMusicQueue_ReadFirstPointer\n\nProcessMusicQueue_MusicQueue1:\n\tSTA MusicPlaying1\n\tLDY #$00\n\tSTY MusicPlaying2\n\tLDY #$FF\n\nIFNDEF EXPAND_MUSIC\nProcessMusicQueue_FirstPointerLoop:\n\tINY\n\tLSR A\n\tBCC ProcessMusicQueue_FirstPointerLoop\nELSE\n\tTAY\n\tDEY\nENDIF\n\nProcessMusicQueue_ReadFirstPointer:\n\tLDA MusicPointersFirstPart, Y\n\tSTA MusicPointerFirstPart\n\tLDA MusicPointersEndPart, Y\n\tCLC\n\tADC #$02\n\tSTA MusicPointerEndPart\n\tLDA MusicPointersLoopPart, Y\n\tSTA MusicPointerLoopPart\n\tLDA MusicPointerFirstPart\n\nProcessMusicQueue_SetCurrentPart:\n\tSTA MusicPointerCurrentPart\n\nProcessMusicQueue_SetNextPart:\n\tINC MusicPointerCurrentPart\n\tLDY MusicPointerCurrentPart\n\tCPY MusicPointerEndPart\n\tBNE ProcessMusicQueue_ReadHeader\n\n\tLDA MusicPointerLoopPart\n\tBNE ProcessMusicQueue_SetCurrentPart\n\n\tJMP StopMusic\n\nProcessMusicQueue_Part2:\n\tSTA MusicPlaying2\n\tLDY MusicPlaying1\n\tSTY MusicResume1\n\tLDY #$00\n\tSTY MusicPlaying1\n\nIFNDEF EXPAND_MUSIC\nProcessMusicQueue_PointerLoop:\n\tINY\n\tLSR A\n\tBCC ProcessMusicQueue_PointerLoop\nELSE\n\tTAY\nENDIF\n\nIFNDEF EXPAND_MUSIC\nProcessMusicQueue_ReadHeader:\n\tLDA MusicPartPointers - 1, Y\n\tTAY\n\tLDA MusicPartPointers, Y\n\tSTA MusicTempoSetting\n\tLDA MusicPartPointers + 1, Y\n\tSTA CurrentMusicPointer\n\tLDA MusicPartPointers + 2, Y\n\tSTA CurrentMusicPointer + 1\n\tLDA MusicPartPointers + 3, Y\n\tSTA CurrentMusicTriangleOffset\n\tLDA MusicPartPointers + 4, Y\n\tSTA CurrentMusicSquare1Offset\n\tLDA MusicPartPointers + 5, Y\n\tSTA CurrentMusicNoiseOffset\n\tSTA CurrentMusicNoiseStartOffset\nIFDEF PROTOTYPE_MUSIC_UNDERGROUND\n\tLDA MusicPartPointers + 6, Y\nENDIF\n\tSTA CurrentMusicDPCMOffset\n\tSTA CurrentMusicDPCMStartOffset\nENDIF\n\nIFDEF EXPAND_MUSIC\nProcessMusicQueue_ReadHeader:\n\tLDA MusicPartPointers - 1, Y\n\tTAY\n\n\tLDA MusicHeaderPointersLo, Y\n\tSTA byte_RAM_0\n\tLDA MusicHeaderPointersHi, Y\n\tSTA byte_RAM_0+1\n\n\tLDY #$00\n\n\tLDA (byte_RAM_0), Y\n\tSTA MusicTempoSetting\n\tINY\n\tLDA (byte_RAM_0), Y\n\tSTA CurrentMusicPointer\n\tINY\n\tLDA (byte_RAM_0), Y\n\tSTA CurrentMusicPointer + 1\n\tINY\n\tLDA (byte_RAM_0), Y\n\tSTA CurrentMusicTriangleOffset\n\tINY\n\tLDA (byte_RAM_0), Y\n\tSTA CurrentMusicSquare1Offset\n\tINY\n\tLDA (byte_RAM_0), Y\n\tSTA CurrentMusicNoiseOffset\n\tSTA CurrentMusicNoiseStartOffset\n\tINY\n\tLDA (byte_RAM_0), Y\n\tSTA CurrentMusicDPCMOffset\n\tSTA CurrentMusicDPCMStartOffset\nENDIF\n\n\tLDA #$01\n\tSTA MusicSquare2NoteLength\n\tSTA MusicSquare1NoteLength\n\tSTA MusicTriangleNoteLength\n\tSTA MusicNoiseNoteLength\n\tSTA MusicDPCMNoteLength\n\n\tLDA #$00\n\tSTA CurrentMusicSquare2Offset\n\tSTA MusicSquare1NoteSweep\nIFDEF EXPAND_MUSIC\n\tSTA MusicSquare1NoteBend\n\tSTA MusicSquare2NoteBend\nENDIF\n\n\tLDA #%00001011\n\tSTA SND_CHN\n\tLDA #%00001111\n\tSTA SND_CHN\n\nProcessMusicQueue_ReadNoteData:\n\tDEC MusicSquare2NoteLength\n\tBNE ProcessMusicQueue_Square2SustainNote\n\n\tLDY CurrentMusicSquare2Offset\n\tINC CurrentMusicSquare2Offset\n\tLDA (CurrentMusicPointer), Y\n\tBEQ ProcessMusicQueue_EndOfSegment\n\n\tBPL ProcessMusicQueue_Square2Note\n\n\tBNE ProcessMusicQueue_Square2Patch\n\nProcessMusicQueue_EndOfSegment:\n\tLDA MusicPlaying1\n\tBNE ProcessMusicQueue_ThenSetNextPart\n\n\tLDA MusicPlaying2\n\tCMP #Music2_EndingAndCast\n\tBEQ ProcessMusicQueue_ThenSetNextPart\n\nIFNDEF EXPAND_MUSIC\n\tAND #Music1_Overworld | Music1_Inside | Music1_Subspace\nELSE\n\tJSR CheckStopMusic\nENDIF\n\tBEQ StopMusic\n\n\tLDA MusicResume1\n\tBNE ProcessMusicQueue_ResumeMusicQueue1\n\nStopMusic:\n\tLDA #$00\n\tSTA MusicPlaying2\n\tSTA MusicPlaying1\n\tSTA SND_CHN\n\tLDX #%00001111\n\tSTX SND_CHN\n\tRTS\n\nProcessMusicQueue_ThenSetNextPart:\n\tJMP ProcessMusicQueue_SetNextPart\n\nProcessMusicQueue_ResumeMusicQueue1:\n\tJMP ProcessMusicQueue_MusicQueue1\n\nProcessMusicQueue_Square2Patch:\n\tTAX\n\tAND #$F0\n\tSTA MusicSquare2Patch\n\tTXA\n\tJSR ProcessMusicQueue_PatchNoteLength\n\n\tSTA MusicSquare2NoteStartLength\n\nProcessMusicQueue_Square2NextOffset:\n\tLDY CurrentMusicSquare2Offset\n\tINC CurrentMusicSquare2Offset\n\tLDA (CurrentMusicPointer), Y\n\nProcessMusicQueue_Square2Note:\n\tLDX SoundEffectPlaying1\n\tBNE ProcessMusicQueue_Square2ContinueNote\n\n\tJSR PlaySquare2Note\n\n\tTAY\n\tBNE ProcessMusicQueue_Square2StartNote\n\n\tLDA MusicSquareInstrumentStartOffset\n\tJMP ProcessMusicQueue_Square2UpdateNoteOffset\n\nProcessMusicQueue_Square2StartNote:\n\tLDA MusicSquare2NoteStartLength","htmlComment":"<p>Sound effect data</p>\n","htmlContent":"<span class=\"token directive keyword\">.include</span> <a class=\"token string\" href=\"/smb2/src/music/sound-effect-data.asm\">\"src/music/sound-effect-data.asm\"</a>\n\n\nProcessSoundEffectQueue<span class=\"token decimalnumber string\">3</span>_ShortNoise:\n\t<span class=\"token opcode property\">LDA</span> <span class=\"token hexnumber string\">#$02</span>\n\t<span class=\"token opcode property\">STA</span> SoundEffectTimer<span class=\"token decimalnumber string\">3</span>\n\nProcessSoundEffectQueue<span class=\"token decimalnumber string\">3</span>_ShortNoisePart<span class=\"token decimalnumber string\">2</span>:\n\t<span class=\"token opcode property\">LDA</span> <span class=\"token hexnumber string\">#$1A</span>\n\t<span class=\"token opcode property\">STA</span> NOISE_VOL\n\t<span class=\"token opcode property\">LDA</span> <span class=\"token hexnumber string\">#$04</span>\n\t<span class=\"token opcode property\">STA</span> NOISE_LO\n\t<span class=\"token opcode property\">STA</span> NOISE_HI\n\t<span class=\"token opcode property\">BNE</span> ProcessSoundEffectQueue<span class=\"token decimalnumber string\">3</span>_DecrementTimer\n\nProcessSoundEffectQueue<span class=\"token decimalnumber string\">3</span>:\n\t<span class=\"token opcode property\">LDY</span> SoundEffectQueue<span class=\"token decimalnumber string\">3</span>\n\t<span class=\"token opcode property\">BEQ</span> ProcessSoundEffectQueue<span class=\"token decimalnumber string\">3</span>_Part<span class=\"token decimalnumber string\">2</span>\n\n\t<span class=\"token opcode property\">STY</span> SoundEffectPlaying<span class=\"token decimalnumber string\">3</span>\n\t<span class=\"token opcode property\">LSR</span> SoundEffectQueue<span class=\"token decimalnumber string\">3</span>\n\t<span class=\"token opcode property\">BCS</span> ProcessSoundEffectQueue<span class=\"token decimalnumber string\">3</span>_ShortNoise\n\n\t<span class=\"token opcode property\">LSR</span> SoundEffectQueue<span class=\"token decimalnumber string\">3</span>\n\t<span class=\"token opcode property\">BCS</span> ProcessSoundEffectQueue<span class=\"token decimalnumber string\">3</span>_Rumble\n\n\t<span class=\"token opcode property\">LSR</span> SoundEffectQueue<span class=\"token decimalnumber string\">3</span>\n\t<span class=\"token opcode property\">BCS</span> ProcessSoundEffectQueue<span class=\"token decimalnumber string\">3</span>_Rumble\n\nProcessSoundEffectQueue<span class=\"token decimalnumber string\">3</span>_Part<span class=\"token decimalnumber string\">2</span>:\n\t<span class=\"token opcode property\">LDA</span> SoundEffectPlaying<span class=\"token decimalnumber string\">3</span>\n\t<span class=\"token opcode property\">LSR</span> <span class=\"token register variable\">A</span>\n\t<span class=\"token opcode property\">BCS</span> ProcessSoundEffectQueue<span class=\"token decimalnumber string\">3</span>_ShortNoisePart<span class=\"token decimalnumber string\">2</span>\n\n\t<span class=\"token opcode property\">LSR</span> <span class=\"token register variable\">A</span>\n\t<span class=\"token opcode property\">BCS</span> ProcessSoundEffectQueue<span class=\"token decimalnumber string\">3</span>_RumblePart<span class=\"token decimalnumber string\">2</span>\n\n\t<span class=\"token opcode property\">LSR</span> <span class=\"token register variable\">A</span>\n\t<span class=\"token opcode property\">BCS</span> ProcessSoundEffectQueue<span class=\"token decimalnumber string\">3</span>_RumblePart<span class=\"token decimalnumber string\">2</span>\n\n\t<span class=\"token opcode property\">RTS</span>\n\nProcessSoundEffectQueue<span class=\"token decimalnumber string\">3</span>_Rumble:\n\t<span class=\"token opcode property\">LDA</span> <span class=\"token hexnumber string\">#$7F</span>\n\t<span class=\"token opcode property\">STA</span> SoundEffectTimer<span class=\"token decimalnumber string\">3</span>\n\nProcessSoundEffectQueue<span class=\"token decimalnumber string\">3</span>_RumblePart<span class=\"token decimalnumber string\">2</span>:\n\t<span class=\"token opcode property\">LDY</span> SoundEffectTimer<span class=\"token decimalnumber string\">3</span>\n\t<span class=\"token opcode property\">LDA</span> ProcessMusicQueue, <span class=\"token register variable\">Y</span> <span class=\"token comment\">; weird, but i guess that's one way to get \"random\" noise</span>\n\t<span class=\"token opcode property\">ORA</span> <span class=\"token hexnumber string\">#$0C</span>\n\t<span class=\"token opcode property\">STA</span> NOISE_LO\n\t<span class=\"token opcode property\">LDA</span> SoundEffectTimer<span class=\"token decimalnumber string\">3</span>\n\t<span class=\"token opcode property\">LSR</span> <span class=\"token register variable\">A</span>\n\t<span class=\"token opcode property\">LSR</span> <span class=\"token register variable\">A</span>\n\t<span class=\"token opcode property\">LSR</span> <span class=\"token register variable\">A</span>\n\t<span class=\"token opcode property\">AND</span> <span class=\"token hexnumber string\">#$1F</span>\n\t<span class=\"token opcode property\">ORA</span> <span class=\"token hexnumber string\">#$10</span>\n\t<span class=\"token opcode property\">STA</span> NOISE_VOL\n\t<span class=\"token opcode property\">LDA</span> <span class=\"token hexnumber string\">#$18</span>\n\t<span class=\"token opcode property\">STA</span> NOISE_HI\n\nProcessSoundEffectQueue<span class=\"token decimalnumber string\">3</span>_DecrementTimer:\n\t<span class=\"token opcode property\">DEC</span> SoundEffectTimer<span class=\"token decimalnumber string\">3</span>\n\t<span class=\"token opcode property\">BNE</span> ProcessSoundEffectQueue<span class=\"token decimalnumber string\">3</span>_Exit\n\n\t<span class=\"token opcode property\">LDX</span> <span class=\"token hexnumber string\">#$07</span>\n\t<span class=\"token opcode property\">STX</span> SND_CHN\n\t<span class=\"token opcode property\">LDX</span> <span class=\"token hexnumber string\">#$0F</span>\n\t<span class=\"token opcode property\">STX</span> SND_CHN\n\t<span class=\"token opcode property\">LDX</span> <span class=\"token hexnumber string\">#$00</span>\n\t<span class=\"token opcode property\">STX</span> SoundEffectPlaying<span class=\"token decimalnumber string\">3</span>\n\nProcessSoundEffectQueue<span class=\"token decimalnumber string\">3</span>_Exit:\n\t<span class=\"token opcode property\">RTS</span>\n\n\nProcessDPCMQueue:\n\t<span class=\"token opcode property\">LDA</span> DPCMQueue\n\t<span class=\"token opcode property\">BNE</span> ProcessDPCMQueue_Part<span class=\"token decimalnumber string\">2</span>\n\n\t<span class=\"token opcode property\">LDA</span> DPCMPlaying\n\t<span class=\"token opcode property\">BEQ</span> ProcessDPCMQueue_None\n\n\t<span class=\"token opcode property\">DEC</span> DPCMTimer\n\t<span class=\"token opcode property\">BNE</span> ProcessDPCMQueue_Exit\n\nProcessDPCMQueue_None:\n\t<span class=\"token opcode property\">LDA</span> <span class=\"token hexnumber string\">#$00</span>\n\t<span class=\"token opcode property\">STA</span> DPCMPlaying\n\t<span class=\"token opcode property\">LDA</span> <span class=\"token binarynumber string\">#%00001111</span>\n\t<span class=\"token opcode property\">STA</span> SND_CHN\n\nProcessDPCMQueue_Exit:\n\t<span class=\"token opcode property\">RTS</span>\n\nProcessDPCMQueue_Part<span class=\"token decimalnumber string\">2</span>:\n\t<span class=\"token opcode property\">STA</span> DPCMPlaying\nIFDEF EXPAND_MUSIC\n\t<span class=\"token opcode property\">CMP</span> <span class=\"token hexnumber string\">#$7E</span>\n\t<span class=\"token opcode property\">BNE</span> ProcessDPCMQueue_LookUpSample\n\n\t<span class=\"token opcode property\">LDA</span> <span class=\"token hexnumber string\">#$A0</span>\n\t<span class=\"token opcode property\">STA</span> DPCMTimer\n\t<span class=\"token opcode property\">RTS</span>\n\nProcessDPCMQueue_LookUpSample:\nENDIF\n\t<span class=\"token opcode property\">LDY</span> <span class=\"token hexnumber string\">#$00</span>\n\nIFNDEF EXPAND_MUSIC\nProcessDPCMQueue_PointerLoop:\n\t<span class=\"token opcode property\">INY</span>\n\t<span class=\"token opcode property\">LSR</span> <span class=\"token register variable\">A</span>\n\t<span class=\"token opcode property\">BCC</span> ProcessDPCMQueue_PointerLoop\nELSE\n\t<span class=\"token opcode property\">TAY</span>\nENDIF\n\n\t<span class=\"token opcode property\">LDA</span> DMCFreqTable - <span class=\"token decimalnumber string\">1</span>, <span class=\"token register variable\">Y</span>\n\t<span class=\"token opcode property\">STA</span> DMC_FREQ\n\n\t<span class=\"token opcode property\">LDA</span> DMCStartTable - <span class=\"token decimalnumber string\">1</span>, <span class=\"token register variable\">Y</span>\n\t<span class=\"token opcode property\">STA</span> DMC_START\n\t<span class=\"token opcode property\">LDA</span> DMCLengthTable - <span class=\"token decimalnumber string\">1</span>, <span class=\"token register variable\">Y</span>\n\t<span class=\"token opcode property\">STA</span> DMC_LEN\n\t<span class=\"token opcode property\">LDA</span> <span class=\"token hexnumber string\">#$A0</span>\n\t<span class=\"token opcode property\">STA</span> DPCMTimer\n\t<span class=\"token opcode property\">LDA</span> <span class=\"token binarynumber string\">#%00001111</span>\n\t<span class=\"token opcode property\">STA</span> SND_CHN\n\t<span class=\"token opcode property\">LDA</span> <span class=\"token binarynumber string\">#%00011111</span>\n\t<span class=\"token opcode property\">STA</span> SND_CHN\n\t<span class=\"token opcode property\">RTS</span>\n\n\nDMCStartTable:\n\t<span class=\"token directive keyword\">.db</span> (DPCMSampleData_DoorOpenBombBom - DPCMSampleData)/<span class=\"token decimalnumber string\">64</span> <span class=\"token comment\">; $4F</span>\n\t<span class=\"token directive keyword\">.db</span> (DPCMSampleData_DrumSample - DPCMSampleData)/<span class=\"token decimalnumber string\">64</span> <span class=\"token comment\">; $60</span>\n\t<span class=\"token directive keyword\">.db</span> (DPCMSampleData_PlayerHurt - DPCMSampleData)/<span class=\"token decimalnumber string\">64</span> <span class=\"token comment\">; $4B</span>\n\t<span class=\"token directive keyword\">.db</span> (DPCMSampleData_ItemPull - DPCMSampleData)/<span class=\"token decimalnumber string\">64</span> <span class=\"token comment\">; $00</span>\n\t<span class=\"token directive keyword\">.db</span> (DPCMSampleData_BossDeath - DPCMSampleData)/<span class=\"token decimalnumber string\">64</span> <span class=\"token comment\">; $31</span>\n\t<span class=\"token directive keyword\">.db</span> (DPCMSampleData_DrumSample - DPCMSampleData)/<span class=\"token decimalnumber string\">64</span> <span class=\"token comment\">; $60</span>\n\t<span class=\"token directive keyword\">.db</span> (DPCMSampleData_BossHurt - DPCMSampleData)/<span class=\"token decimalnumber string\">64</span> <span class=\"token comment\">; $0E</span>\n\t<span class=\"token directive keyword\">.db</span> (DPCMSampleData_PlayerDeath - DPCMSampleData)/<span class=\"token decimalnumber string\">64</span> <span class=\"token comment\">; $1D</span>\n\nDMCLengthTable:\n\t<span class=\"token directive keyword\">.db</span> (DPCMSampleDataEnd_DoorOpenBombBom - DPCMSampleData_DoorOpenBombBom)/<span class=\"token decimalnumber string\">16</span> <span class=\"token comment\">; $43</span>\n\t<span class=\"token directive keyword\">.db</span> (DPCMSampleDataEnd_DrumSample_A - DPCMSampleData_DrumSample)/<span class=\"token decimalnumber string\">16</span> <span class=\"token comment\">; $14</span>\n\t<span class=\"token directive keyword\">.db</span> (DPCMSampleDataEnd_PlayerHurt - DPCMSampleData_PlayerHurt)/<span class=\"token decimalnumber string\">16</span> <span class=\"token comment\">; $10</span>\n\t<span class=\"token directive keyword\">.db</span> (DPCMSampleDataEnd_ItemPull - DPCMSampleData_ItemPull)/<span class=\"token decimalnumber string\">16</span> <span class=\"token comment\">; $38</span>\n\t<span class=\"token directive keyword\">.db</span> (DPCMSampleDataEnd_BossDeath - DPCMSampleData_BossDeath)/<span class=\"token decimalnumber string\">16</span> <span class=\"token comment\">; $48</span>\n\t<span class=\"token directive keyword\">.db</span> (DPCMSampleDataEnd_DrumSample_B - DPCMSampleData_DrumSample)/<span class=\"token decimalnumber string\">16</span> <span class=\"token comment\">; $28</span>\n\t<span class=\"token directive keyword\">.db</span> (DPCMSampleDataEnd_BossHurt - DPCMSampleData_BossHurt)/<span class=\"token decimalnumber string\">16</span> <span class=\"token comment\">; $3C</span>\n\t<span class=\"token directive keyword\">.db</span> (DPCMSampleDataEnd_PlayerDeath - DPCMSampleData_PlayerDeath)/<span class=\"token decimalnumber string\">16</span> <span class=\"token comment\">; $50</span>\n\nDMCFreqTable:\n\t<span class=\"token directive keyword\">.db</span> <span class=\"token hexnumber string\">$0E</span>\n\t<span class=\"token directive keyword\">.db</span> <span class=\"token hexnumber string\">$0E</span>\n\t<span class=\"token directive keyword\">.db</span> <span class=\"token hexnumber string\">$0F</span>\n\t<span class=\"token directive keyword\">.db</span> <span class=\"token hexnumber string\">$0F</span>\n\t<span class=\"token directive keyword\">.db</span> <span class=\"token hexnumber string\">$0F</span>\n\t<span class=\"token directive keyword\">.db</span> <span class=\"token hexnumber string\">$0F</span>\n\t<span class=\"token directive keyword\">.db</span> <span class=\"token hexnumber string\">$0F</span>\n\t<span class=\"token directive keyword\">.db</span> <span class=\"token hexnumber string\">$0F</span>\n\t<span class=\"token directive keyword\">.db</span> <span class=\"token hexnumber string\">$60</span> <span class=\"token comment\">; ???</span>\n\n\nProcessMusicQueue_ThenReadNoteData:\n\t<span class=\"token opcode property\">JMP</span> ProcessMusicQueue_ReadNoteData\n\nProcessMusicQueue_StopMusic:\n\t<span class=\"token opcode property\">JMP</span> StopMusic\n\nProcessMusicQueue:\n\t<span class=\"token opcode property\">LDA</span> MusicQueue<span class=\"token decimalnumber string\">2</span>\n\t<span class=\"token opcode property\">BMI</span> ProcessMusicQueue_StopMusic\n\n\t<span class=\"token opcode property\">CMP</span> #Music<span class=\"token decimalnumber string\">2</span>_EndingAndCast\n\t<span class=\"token opcode property\">BEQ</span> ProcessMusicQueue_EndingAndCast\n\n\t<span class=\"token opcode property\">LDA</span> MusicQueue<span class=\"token decimalnumber string\">2</span>\n\t<span class=\"token opcode property\">BNE</span> ProcessMusicQueue_Part<span class=\"token decimalnumber string\">2</span>\n\n\t<span class=\"token opcode property\">LDA</span> MusicQueue<span class=\"token decimalnumber string\">1</span>\n\t<span class=\"token opcode property\">BNE</span> ProcessMusicQueue_MusicQueue<span class=\"token decimalnumber string\">1</span>\n\n\t<span class=\"token opcode property\">LDA</span> MusicPlaying<span class=\"token decimalnumber string\">2</span>\n\t<span class=\"token opcode property\">ORA</span> MusicPlaying<span class=\"token decimalnumber string\">1</span>\n\t<span class=\"token opcode property\">BNE</span> ProcessMusicQueue_ThenReadNoteData\n\n\t<span class=\"token opcode property\">RTS</span>\n\nProcessMusicQueue_EndingAndCast:\n\t<span class=\"token opcode property\">STA</span> MusicPlaying<span class=\"token decimalnumber string\">2</span>\n\t<span class=\"token opcode property\">LDY</span> <span class=\"token hexnumber string\">#$00</span>\n\t<span class=\"token opcode property\">STY</span> MusicPlaying<span class=\"token decimalnumber string\">1</span>\n\t<span class=\"token opcode property\">LDY</span> <span class=\"token hexnumber string\">#$08</span> <span class=\"token comment\">; index of ending music pointer</span>\n\t<span class=\"token opcode property\">BNE</span> ProcessMusicQueue_ReadFirstPointer\n\nProcessMusicQueue_MusicQueue<span class=\"token decimalnumber string\">1</span>:\n\t<span class=\"token opcode property\">STA</span> MusicPlaying<span class=\"token decimalnumber string\">1</span>\n\t<span class=\"token opcode property\">LDY</span> <span class=\"token hexnumber string\">#$00</span>\n\t<span class=\"token opcode property\">STY</span> MusicPlaying<span class=\"token decimalnumber string\">2</span>\n\t<span class=\"token opcode property\">LDY</span> <span class=\"token hexnumber string\">#$FF</span>\n\nIFNDEF EXPAND_MUSIC\nProcessMusicQueue_FirstPointerLoop:\n\t<span class=\"token opcode property\">INY</span>\n\t<span class=\"token opcode property\">LSR</span> <span class=\"token register variable\">A</span>\n\t<span class=\"token opcode property\">BCC</span> ProcessMusicQueue_FirstPointerLoop\nELSE\n\t<span class=\"token opcode property\">TAY</span>\n\t<span class=\"token opcode property\">DEY</span>\nENDIF\n\nProcessMusicQueue_ReadFirstPointer:\n\t<span class=\"token opcode property\">LDA</span> MusicPointersFirstPart, <span class=\"token register variable\">Y</span>\n\t<span class=\"token opcode property\">STA</span> MusicPointerFirstPart\n\t<span class=\"token opcode property\">LDA</span> MusicPointersEndPart, <span class=\"token register variable\">Y</span>\n\t<span class=\"token opcode property\">CLC</span>\n\t<span class=\"token opcode property\">ADC</span> <span class=\"token hexnumber string\">#$02</span>\n\t<span class=\"token opcode property\">STA</span> MusicPointerEndPart\n\t<span class=\"token opcode property\">LDA</span> MusicPointersLoopPart, <span class=\"token register variable\">Y</span>\n\t<span class=\"token opcode property\">STA</span> MusicPointerLoopPart\n\t<span class=\"token opcode property\">LDA</span> MusicPointerFirstPart\n\nProcessMusicQueue_SetCurrentPart:\n\t<span class=\"token opcode property\">STA</span> MusicPointerCurrentPart\n\nProcessMusicQueue_SetNextPart:\n\t<span class=\"token opcode property\">INC</span> MusicPointerCurrentPart\n\t<span class=\"token opcode property\">LDY</span> MusicPointerCurrentPart\n\t<span class=\"token opcode property\">CPY</span> MusicPointerEndPart\n\t<span class=\"token opcode property\">BNE</span> ProcessMusicQueue_ReadHeader\n\n\t<span class=\"token opcode property\">LDA</span> MusicPointerLoopPart\n\t<span class=\"token opcode property\">BNE</span> ProcessMusicQueue_SetCurrentPart\n\n\t<span class=\"token opcode property\">JMP</span> StopMusic\n\nProcessMusicQueue_Part<span class=\"token decimalnumber string\">2</span>:\n\t<span class=\"token opcode property\">STA</span> MusicPlaying<span class=\"token decimalnumber string\">2</span>\n\t<span class=\"token opcode property\">LDY</span> MusicPlaying<span class=\"token decimalnumber string\">1</span>\n\t<span class=\"token opcode property\">STY</span> MusicResume<span class=\"token decimalnumber string\">1</span>\n\t<span class=\"token opcode property\">LDY</span> <span class=\"token hexnumber string\">#$00</span>\n\t<span class=\"token opcode property\">STY</span> MusicPlaying<span class=\"token decimalnumber string\">1</span>\n\nIFNDEF EXPAND_MUSIC\nProcessMusicQueue_PointerLoop:\n\t<span class=\"token opcode property\">INY</span>\n\t<span class=\"token opcode property\">LSR</span> <span class=\"token register variable\">A</span>\n\t<span class=\"token opcode property\">BCC</span> ProcessMusicQueue_PointerLoop\nELSE\n\t<span class=\"token opcode property\">TAY</span>\nENDIF\n\nIFNDEF EXPAND_MUSIC\nProcessMusicQueue_ReadHeader:\n\t<span class=\"token opcode property\">LDA</span> MusicPartPointers - <span class=\"token decimalnumber string\">1</span>, <span class=\"token register variable\">Y</span>\n\t<span class=\"token opcode property\">TAY</span>\n\t<span class=\"token opcode property\">LDA</span> MusicPartPointers, <span class=\"token register variable\">Y</span>\n\t<span class=\"token opcode property\">STA</span> MusicTempoSetting\n\t<span class=\"token opcode property\">LDA</span> MusicPartPointers + <span class=\"token decimalnumber string\">1</span>, <span class=\"token register variable\">Y</span>\n\t<span class=\"token opcode property\">STA</span> CurrentMusicPointer\n\t<span class=\"token opcode property\">LDA</span> MusicPartPointers + <span class=\"token decimalnumber string\">2</span>, <span class=\"token register variable\">Y</span>\n\t<span class=\"token opcode property\">STA</span> CurrentMusicPointer + <span class=\"token decimalnumber string\">1</span>\n\t<span class=\"token opcode property\">LDA</span> MusicPartPointers + <span class=\"token decimalnumber string\">3</span>, <span class=\"token register variable\">Y</span>\n\t<span class=\"token opcode property\">STA</span> CurrentMusicTriangleOffset\n\t<span class=\"token opcode property\">LDA</span> MusicPartPointers + <span class=\"token decimalnumber string\">4</span>, <span class=\"token register variable\">Y</span>\n\t<span class=\"token opcode property\">STA</span> CurrentMusicSquare<span class=\"token decimalnumber string\">1</span>Offset\n\t<span class=\"token opcode property\">LDA</span> MusicPartPointers + <span class=\"token decimalnumber string\">5</span>, <span class=\"token register variable\">Y</span>\n\t<span class=\"token opcode property\">STA</span> CurrentMusicNoiseOffset\n\t<span class=\"token opcode property\">STA</span> CurrentMusicNoiseStartOffset\nIFDEF PROTOTYPE_MUSIC_UNDERGROUND\n\t<span class=\"token opcode property\">LDA</span> MusicPartPointers + <span class=\"token decimalnumber string\">6</span>, <span class=\"token register variable\">Y</span>\nENDIF\n\t<span class=\"token opcode property\">STA</span> CurrentMusicDPCMOffset\n\t<span class=\"token opcode property\">STA</span> CurrentMusicDPCMStartOffset\nENDIF\n\nIFDEF EXPAND_MUSIC\nProcessMusicQueue_ReadHeader:\n\t<span class=\"token opcode property\">LDA</span> MusicPartPointers - <span class=\"token decimalnumber string\">1</span>, <span class=\"token register variable\">Y</span>\n\t<span class=\"token opcode property\">TAY</span>\n\n\t<span class=\"token opcode property\">LDA</span> MusicHeaderPointersLo, <span class=\"token register variable\">Y</span>\n\t<span class=\"token opcode property\">STA</span> byte_RAM_<span class=\"token decimalnumber string\">0</span>\n\t<span class=\"token opcode property\">LDA</span> MusicHeaderPointersHi, <span class=\"token register variable\">Y</span>\n\t<span class=\"token opcode property\">STA</span> byte_RAM_<span class=\"token decimalnumber string\">0</span>+<span class=\"token decimalnumber string\">1</span>\n\n\t<span class=\"token opcode property\">LDY</span> <span class=\"token hexnumber string\">#$00</span>\n\n\t<span class=\"token opcode property\">LDA</span> (byte_RAM_<span class=\"token decimalnumber string\">0</span>), <span class=\"token register variable\">Y</span>\n\t<span class=\"token opcode property\">STA</span> MusicTempoSetting\n\t<span class=\"token opcode property\">INY</span>\n\t<span class=\"token opcode property\">LDA</span> (byte_RAM_<span class=\"token decimalnumber string\">0</span>), <span class=\"token register variable\">Y</span>\n\t<span class=\"token opcode property\">STA</span> CurrentMusicPointer\n\t<span class=\"token opcode property\">INY</span>\n\t<span class=\"token opcode property\">LDA</span> (byte_RAM_<span class=\"token decimalnumber string\">0</span>), <span class=\"token register variable\">Y</span>\n\t<span class=\"token opcode property\">STA</span> CurrentMusicPointer + <span class=\"token decimalnumber string\">1</span>\n\t<span class=\"token opcode property\">INY</span>\n\t<span class=\"token opcode property\">LDA</span> (byte_RAM_<span class=\"token decimalnumber string\">0</span>), <span class=\"token register variable\">Y</span>\n\t<span class=\"token opcode property\">STA</span> CurrentMusicTriangleOffset\n\t<span class=\"token opcode property\">INY</span>\n\t<span class=\"token opcode property\">LDA</span> (byte_RAM_<span class=\"token decimalnumber string\">0</span>), <span class=\"token register variable\">Y</span>\n\t<span class=\"token opcode property\">STA</span> CurrentMusicSquare<span class=\"token decimalnumber string\">1</span>Offset\n\t<span class=\"token opcode property\">INY</span>\n\t<span class=\"token opcode property\">LDA</span> (byte_RAM_<span class=\"token decimalnumber string\">0</span>), <span class=\"token register variable\">Y</span>\n\t<span class=\"token opcode property\">STA</span> CurrentMusicNoiseOffset\n\t<span class=\"token opcode property\">STA</span> CurrentMusicNoiseStartOffset\n\t<span class=\"token opcode property\">INY</span>\n\t<span class=\"token opcode property\">LDA</span> (byte_RAM_<span class=\"token decimalnumber string\">0</span>), <span class=\"token register variable\">Y</span>\n\t<span class=\"token opcode property\">STA</span> CurrentMusicDPCMOffset\n\t<span class=\"token opcode property\">STA</span> CurrentMusicDPCMStartOffset\nENDIF\n\n\t<span class=\"token opcode property\">LDA</span> <span class=\"token hexnumber string\">#$01</span>\n\t<span class=\"token opcode property\">STA</span> MusicSquare<span class=\"token decimalnumber string\">2</span>NoteLength\n\t<span class=\"token opcode property\">STA</span> MusicSquare<span class=\"token decimalnumber string\">1</span>NoteLength\n\t<span class=\"token opcode property\">STA</span> MusicTriangleNoteLength\n\t<span class=\"token opcode property\">STA</span> MusicNoiseNoteLength\n\t<span class=\"token opcode property\">STA</span> MusicDPCMNoteLength\n\n\t<span class=\"token opcode property\">LDA</span> <span class=\"token hexnumber string\">#$00</span>\n\t<span class=\"token opcode property\">STA</span> CurrentMusicSquare<span class=\"token decimalnumber string\">2</span>Offset\n\t<span class=\"token opcode property\">STA</span> MusicSquare<span class=\"token decimalnumber string\">1</span>NoteSweep\nIFDEF EXPAND_MUSIC\n\t<span class=\"token opcode property\">STA</span> MusicSquare<span class=\"token decimalnumber string\">1</span>NoteBend\n\t<span class=\"token opcode property\">STA</span> MusicSquare<span class=\"token decimalnumber string\">2</span>NoteBend\nENDIF\n\n\t<span class=\"token opcode property\">LDA</span> <span class=\"token binarynumber string\">#%00001011</span>\n\t<span class=\"token opcode property\">STA</span> SND_CHN\n\t<span class=\"token opcode property\">LDA</span> <span class=\"token binarynumber string\">#%00001111</span>\n\t<span class=\"token opcode property\">STA</span> SND_CHN\n\nProcessMusicQueue_ReadNoteData:\n\t<span class=\"token opcode property\">DEC</span> MusicSquare<span class=\"token decimalnumber string\">2</span>NoteLength\n\t<span class=\"token opcode property\">BNE</span> ProcessMusicQueue_Square<span class=\"token decimalnumber string\">2</span>SustainNote\n\n\t<span class=\"token opcode property\">LDY</span> CurrentMusicSquare<span class=\"token decimalnumber string\">2</span>Offset\n\t<span class=\"token opcode property\">INC</span> CurrentMusicSquare<span class=\"token decimalnumber string\">2</span>Offset\n\t<span class=\"token opcode property\">LDA</span> (CurrentMusicPointer), <span class=\"token register variable\">Y</span>\n\t<span class=\"token opcode property\">BEQ</span> ProcessMusicQueue_EndOfSegment\n\n\t<span class=\"token opcode property\">BPL</span> ProcessMusicQueue_Square<span class=\"token decimalnumber string\">2</span>Note\n\n\t<span class=\"token opcode property\">BNE</span> ProcessMusicQueue_Square<span class=\"token decimalnumber string\">2</span>Patch\n\nProcessMusicQueue_EndOfSegment:\n\t<span class=\"token opcode property\">LDA</span> MusicPlaying<span class=\"token decimalnumber string\">1</span>\n\t<span class=\"token opcode property\">BNE</span> ProcessMusicQueue_ThenSetNextPart\n\n\t<span class=\"token opcode property\">LDA</span> MusicPlaying<span class=\"token decimalnumber string\">2</span>\n\t<span class=\"token opcode property\">CMP</span> #Music<span class=\"token decimalnumber string\">2</span>_EndingAndCast\n\t<span class=\"token opcode property\">BEQ</span> ProcessMusicQueue_ThenSetNextPart\n\nIFNDEF EXPAND_MUSIC\n\t<span class=\"token opcode property\">AND</span> #Music<span class=\"token decimalnumber string\">1</span>_Overworld | Music<span class=\"token decimalnumber string\">1</span>_Inside | Music<span class=\"token decimalnumber string\">1</span>_Subspace\nELSE\n\t<span class=\"token opcode property\">JSR</span> CheckStopMusic\nENDIF\n\t<span class=\"token opcode property\">BEQ</span> StopMusic\n\n\t<span class=\"token opcode property\">LDA</span> MusicResume<span class=\"token decimalnumber string\">1</span>\n\t<span class=\"token opcode property\">BNE</span> ProcessMusicQueue_ResumeMusicQueue<span class=\"token decimalnumber string\">1</span>\n\nStopMusic:\n\t<span class=\"token opcode property\">LDA</span> <span class=\"token hexnumber string\">#$00</span>\n\t<span class=\"token opcode property\">STA</span> MusicPlaying<span class=\"token decimalnumber string\">2</span>\n\t<span class=\"token opcode property\">STA</span> MusicPlaying<span class=\"token decimalnumber string\">1</span>\n\t<span class=\"token opcode property\">STA</span> SND_CHN\n\t<span class=\"token opcode property\">LDX</span> <span class=\"token binarynumber string\">#%00001111</span>\n\t<span class=\"token opcode property\">STX</span> SND_CHN\n\t<span class=\"token opcode property\">RTS</span>\n\nProcessMusicQueue_ThenSetNextPart:\n\t<span class=\"token opcode property\">JMP</span> ProcessMusicQueue_SetNextPart\n\nProcessMusicQueue_ResumeMusicQueue<span class=\"token decimalnumber string\">1</span>:\n\t<span class=\"token opcode property\">JMP</span> ProcessMusicQueue_MusicQueue<span class=\"token decimalnumber string\">1</span>\n\nProcessMusicQueue_Square<span class=\"token decimalnumber string\">2</span>Patch:\n\t<span class=\"token opcode property\">TAX</span>\n\t<span class=\"token opcode property\">AND</span> <span class=\"token hexnumber string\">#$F0</span>\n\t<span class=\"token opcode property\">STA</span> MusicSquare<span class=\"token decimalnumber string\">2</span>Patch\n\t<span class=\"token opcode property\">TXA</span>\n\t<span class=\"token opcode property\">JSR</span> ProcessMusicQueue_PatchNoteLength\n\n\t<span class=\"token opcode property\">STA</span> MusicSquare<span class=\"token decimalnumber string\">2</span>NoteStartLength\n\nProcessMusicQueue_Square<span class=\"token decimalnumber string\">2</span>NextOffset:\n\t<span class=\"token opcode property\">LDY</span> CurrentMusicSquare<span class=\"token decimalnumber string\">2</span>Offset\n\t<span class=\"token opcode property\">INC</span> CurrentMusicSquare<span class=\"token decimalnumber string\">2</span>Offset\n\t<span class=\"token opcode property\">LDA</span> (CurrentMusicPointer), <span class=\"token register variable\">Y</span>\n\nProcessMusicQueue_Square<span class=\"token decimalnumber string\">2</span>Note:\n\t<span class=\"token opcode property\">LDX</span> SoundEffectPlaying<span class=\"token decimalnumber string\">1</span>\n\t<span class=\"token opcode property\">BNE</span> ProcessMusicQueue_Square<span class=\"token decimalnumber string\">2</span>ContinueNote\n\n\t<span class=\"token opcode property\">JSR</span> PlaySquare<span class=\"token decimalnumber string\">2</span>Note\n\n\t<span class=\"token opcode property\">TAY</span>\n\t<span class=\"token opcode property\">BNE</span> ProcessMusicQueue_Square<span class=\"token decimalnumber string\">2</span>StartNote\n\n\t<span class=\"token opcode property\">LDA</span> MusicSquareInstrumentStartOffset\n\t<span class=\"token opcode property\">JMP</span> ProcessMusicQueue_Square<span class=\"token decimalnumber string\">2</span>UpdateNoteOffset\n\nProcessMusicQueue_Square<span class=\"token decimalnumber string\">2</span>StartNote:\n\t<span class=\"token opcode property\">LDA</span> MusicSquare<span class=\"token decimalnumber string\">2</span>NoteStartLength","line":312},{"comment":"seems like the next line should be LDX MusicSquareEnvelope based on the equivalent code for square 1?","content":"\tLDX MusicSquareInstrumentStartOffset ; always overridden in the following subroutine...?\n\tJSR SetInstrumentStartOffset\n\nProcessMusicQueue_Square2UpdateNoteOffset:\n\tSTA MusicSquare2InstrumentOffset\n\nIFDEF EXPAND_MUSIC\n\tJSR CheckSquare2NoteBend\nENDIF\n\n\tJSR SetSquare2VolumeAndSweep\n\nProcessMusicQueue_Square2ContinueNote:\n\tLDA MusicSquare2NoteStartLength\n\tSTA MusicSquare2NoteLength\n\nProcessMusicQueue_Square2SustainNote:\n\tLDX SoundEffectPlaying1\n\tBNE ProcessMusicQueue_Square1\n\nIFDEF EXPAND_MUSIC\n\tLDA MusicSquare2NoteBend\n\tBEQ ProcessMusicQueue_LoadSquare2InstrumentOffset\n\n\tLDA MusicSquare2NoteStartLength\n\tLDX #$04\n\tJSR UpdateNoteBend\nENDIF\n\nProcessMusicQueue_LoadSquare2InstrumentOffset:\n\tLDY MusicSquare2InstrumentOffset\n\tBEQ ProcessMusicQueue_LoadSquare2Instrument\n\n\tDEC MusicSquare2InstrumentOffset\n\nProcessMusicQueue_LoadSquare2Instrument:\n\tLDA MusicSquare2NoteStartLength\n\tLDX MusicSquare2Patch\n\tJSR LoadSquareInstrumentDVE\n\n\tSTA SQ2_VOL\n\tLDX #$7F\n\tSTX SQ2_SWEEP\n\nProcessMusicQueue_Square1:\n\tDEC MusicSquare1NoteLength\n\tBNE ProcessMusicQueue_Square1SustainNote\n\nProcessMusicQueue_Square1Patch:\n\tLDY CurrentMusicSquare1Offset\n\tINC CurrentMusicSquare1Offset\n\tLDA (CurrentMusicPointer), Y\n\tBPL ProcessMusicQueue_Square1AfterPatch\n\n\tTAX\n\tAND #$F0\n\tSTA MusicSquare1Patch\n\tTXA\n\tJSR ProcessMusicQueue_PatchNoteLength\n\n\tSTA MusicSquare1NoteStartLength\n\nProcessMusicQueue_Square1NextOffset:\n\tLDY CurrentMusicSquare1Offset\n\tINC CurrentMusicSquare1Offset\n\tLDA (CurrentMusicPointer), Y\n\nProcessMusicQueue_Square1AfterPatch:\n\tTAY\n\tBNE ProcessMusicQueue_Square1Note\n\n\tLDA #$83\n\tSTA SQ1_VOL\n\tLDA #$94\n\tSTA SQ1_SWEEP\n\tSTA MusicSquare1NoteSweep\n\tBNE ProcessMusicQueue_Square1Patch\n\nProcessMusicQueue_Square1Note:\n\tLDY SoundEffectPlaying2\n\tBNE ProcessMusicQueue_Square1ContinueNote\n\n\tJSR PlaySquare1Note\n\n\tBNE ProcessMusicQueue_Square1StartNote\n\n\tLDA MusicSquareInstrumentStartOffset\n\tJMP ProcessMusicQueue_Square1UpdateNoteOffset\n\nProcessMusicQueue_Square1StartNote:\n\tLDA MusicSquare1NoteStartLength\n\tLDX MusicSquareEnvelope ; always overridden in the following subroutine...?\n\tJSR SetInstrumentStartOffset\n\nProcessMusicQueue_Square1UpdateNoteOffset:\n\tSTA MusicSquare1InstrumentOffset\n\nIFDEF EXPAND_MUSIC\n\tJSR CheckSquare1NoteBend\nENDIF\n\n\tJSR SetSquare1VolumeAndSweep\n\nProcessMusicQueue_Square1ContinueNote:\n\tLDA MusicSquare1NoteStartLength\n\tSTA MusicSquare1NoteLength\n\nProcessMusicQueue_Square1SustainNote:\n\tLDA SoundEffectPlaying2\n\tBNE ProcessMusicQueue_Triangle\n\nIFDEF EXPAND_MUSIC\n\tLDA MusicSquare1NoteBend\n\tBEQ ProcessMusicQueue_LoadSquare1InstrumentOffset\n\n\tLDX #$00\n\tLDA MusicSquare1NoteStartLength\n\tJSR UpdateNoteBend\nENDIF\n\nProcessMusicQueue_LoadSquare1InstrumentOffset:\n\tLDY MusicSquare1InstrumentOffset\n\tBEQ ProcessMusicQueue_Square1AfterDecrementInstrumentOffset\n\n\tDEC MusicSquare1InstrumentOffset\n\nProcessMusicQueue_Square1AfterDecrementInstrumentOffset:\n\tLDA MusicSquare1NoteStartLength\n\tLDX MusicSquare1Patch\n\tJSR LoadSquareInstrumentDVE\n\n\tSTA SQ1_VOL\n\tLDA MusicSquare1NoteSweep\n\tBNE ProcessMusicQueue_Square1Sweep\n\n\tLDA #$7F\n\nProcessMusicQueue_Square1Sweep:\n\tSTA SQ1_SWEEP\n\nProcessMusicQueue_Triangle:\n\tLDA CurrentMusicTriangleOffset\n\tBEQ ProcessMusicQueue_NoiseDPCM\n\n\tDEC MusicTriangleNoteLength\n\tBNE ProcessMusicQueue_NoiseDPCM\n\n\tLDY CurrentMusicTriangleOffset\n\tINC CurrentMusicTriangleOffset\n\tLDA (CurrentMusicPointer), Y\n\tBEQ ProcessMusicQueue_TriangleSetLength\n\n\tBPL ProcessMusicQueue_TriangleNote\n\n\tJSR ProcessMusicQueue_PatchNoteLength\n\n\tSTA MusicTriangleNoteStartLength\n\tLDA #$1F\n\tSTA TRI_LINEAR\n\tLDY CurrentMusicTriangleOffset\n\tINC CurrentMusicTriangleOffset\n\tLDA (CurrentMusicPointer), Y\n\tBEQ ProcessMusicQueue_TriangleSetLength\n\nProcessMusicQueue_TriangleNote:\n\tJSR PlayTriangleNote\n\n\tLDX MusicTriangleNoteStartLength\n\tSTX MusicTriangleNoteLength\n\tTXA\n\tCMP #$0A\n\tBCC ProcessMusicQueue_TriangleNoteShort\n\n\tCMP #$1E\n\tBCS ProcessMusicQueue_TriangleNoteLong\n\nProcessMusicQueue_TriangleNoteMedium:\n\tLDA #$24\n\tBNE ProcessMusicQueue_TriangleSetLength\n\nProcessMusicQueue_TriangleNoteShort:\n\tLDA #$18\n\tBNE ProcessMusicQueue_TriangleSetLength\n\nProcessMusicQueue_TriangleNoteLong:\n\tLDA #$6F\n\nProcessMusicQueue_TriangleSetLength:\n\tSTA TRI_LINEAR\n\nProcessMusicQueue_NoiseDPCM:\nIFNDEF EXPAND_MUSIC\n\tIFNDEF PROTOTYPE_MUSIC_UNDERGROUND\n\t\tIFNDEF PROTOTYPE_MUSIC_STARMAN","htmlComment":"<p>seems like the next line should be LDX MusicSquareEnvelope based on the equivalent code for square 1?</p>\n","htmlContent":"\t<span class=\"token opcode property\">LDX</span> MusicSquareInstrumentStartOffset <span class=\"token comment\">; always overridden in the following subroutine...?</span>\n\t<span class=\"token opcode property\">JSR</span> SetInstrumentStartOffset\n\nProcessMusicQueue_Square<span class=\"token decimalnumber string\">2</span>UpdateNoteOffset:\n\t<span class=\"token opcode property\">STA</span> MusicSquare<span class=\"token decimalnumber string\">2</span>InstrumentOffset\n\nIFDEF EXPAND_MUSIC\n\t<span class=\"token opcode property\">JSR</span> CheckSquare<span class=\"token decimalnumber string\">2</span>NoteBend\nENDIF\n\n\t<span class=\"token opcode property\">JSR</span> SetSquare<span class=\"token decimalnumber string\">2</span>VolumeAndSweep\n\nProcessMusicQueue_Square<span class=\"token decimalnumber string\">2</span>ContinueNote:\n\t<span class=\"token opcode property\">LDA</span> MusicSquare<span class=\"token decimalnumber string\">2</span>NoteStartLength\n\t<span class=\"token opcode property\">STA</span> MusicSquare<span class=\"token decimalnumber string\">2</span>NoteLength\n\nProcessMusicQueue_Square<span class=\"token decimalnumber string\">2</span>SustainNote:\n\t<span class=\"token opcode property\">LDX</span> SoundEffectPlaying<span class=\"token decimalnumber string\">1</span>\n\t<span class=\"token opcode property\">BNE</span> ProcessMusicQueue_Square<span class=\"token decimalnumber string\">1</span>\n\nIFDEF EXPAND_MUSIC\n\t<span class=\"token opcode property\">LDA</span> MusicSquare<span class=\"token decimalnumber string\">2</span>NoteBend\n\t<span class=\"token opcode property\">BEQ</span> ProcessMusicQueue_LoadSquare<span class=\"token decimalnumber string\">2</span>InstrumentOffset\n\n\t<span class=\"token opcode property\">LDA</span> MusicSquare<span class=\"token decimalnumber string\">2</span>NoteStartLength\n\t<span class=\"token opcode property\">LDX</span> <span class=\"token hexnumber string\">#$04</span>\n\t<span class=\"token opcode property\">JSR</span> UpdateNoteBend\nENDIF\n\nProcessMusicQueue_LoadSquare<span class=\"token decimalnumber string\">2</span>InstrumentOffset:\n\t<span class=\"token opcode property\">LDY</span> MusicSquare<span class=\"token decimalnumber string\">2</span>InstrumentOffset\n\t<span class=\"token opcode property\">BEQ</span> ProcessMusicQueue_LoadSquare<span class=\"token decimalnumber string\">2</span>Instrument\n\n\t<span class=\"token opcode property\">DEC</span> MusicSquare<span class=\"token decimalnumber string\">2</span>InstrumentOffset\n\nProcessMusicQueue_LoadSquare<span class=\"token decimalnumber string\">2</span>Instrument:\n\t<span class=\"token opcode property\">LDA</span> MusicSquare<span class=\"token decimalnumber string\">2</span>NoteStartLength\n\t<span class=\"token opcode property\">LDX</span> MusicSquare<span class=\"token decimalnumber string\">2</span>Patch\n\t<span class=\"token opcode property\">JSR</span> LoadSquareInstrumentDVE\n\n\t<span class=\"token opcode property\">STA</span> SQ<span class=\"token decimalnumber string\">2</span>_VOL\n\t<span class=\"token opcode property\">LDX</span> <span class=\"token hexnumber string\">#$7F</span>\n\t<span class=\"token opcode property\">STX</span> SQ<span class=\"token decimalnumber string\">2</span>_SWEEP\n\nProcessMusicQueue_Square<span class=\"token decimalnumber string\">1</span>:\n\t<span class=\"token opcode property\">DEC</span> MusicSquare<span class=\"token decimalnumber string\">1</span>NoteLength\n\t<span class=\"token opcode property\">BNE</span> ProcessMusicQueue_Square<span class=\"token decimalnumber string\">1</span>SustainNote\n\nProcessMusicQueue_Square<span class=\"token decimalnumber string\">1</span>Patch:\n\t<span class=\"token opcode property\">LDY</span> CurrentMusicSquare<span class=\"token decimalnumber string\">1</span>Offset\n\t<span class=\"token opcode property\">INC</span> CurrentMusicSquare<span class=\"token decimalnumber string\">1</span>Offset\n\t<span class=\"token opcode property\">LDA</span> (CurrentMusicPointer), <span class=\"token register variable\">Y</span>\n\t<span class=\"token opcode property\">BPL</span> ProcessMusicQueue_Square<span class=\"token decimalnumber string\">1</span>AfterPatch\n\n\t<span class=\"token opcode property\">TAX</span>\n\t<span class=\"token opcode property\">AND</span> <span class=\"token hexnumber string\">#$F0</span>\n\t<span class=\"token opcode property\">STA</span> MusicSquare<span class=\"token decimalnumber string\">1</span>Patch\n\t<span class=\"token opcode property\">TXA</span>\n\t<span class=\"token opcode property\">JSR</span> ProcessMusicQueue_PatchNoteLength\n\n\t<span class=\"token opcode property\">STA</span> MusicSquare<span class=\"token decimalnumber string\">1</span>NoteStartLength\n\nProcessMusicQueue_Square<span class=\"token decimalnumber string\">1</span>NextOffset:\n\t<span class=\"token opcode property\">LDY</span> CurrentMusicSquare<span class=\"token decimalnumber string\">1</span>Offset\n\t<span class=\"token opcode property\">INC</span> CurrentMusicSquare<span class=\"token decimalnumber string\">1</span>Offset\n\t<span class=\"token opcode property\">LDA</span> (CurrentMusicPointer), <span class=\"token register variable\">Y</span>\n\nProcessMusicQueue_Square<span class=\"token decimalnumber string\">1</span>AfterPatch:\n\t<span class=\"token opcode property\">TAY</span>\n\t<span class=\"token opcode property\">BNE</span> ProcessMusicQueue_Square<span class=\"token decimalnumber string\">1</span>Note\n\n\t<span class=\"token opcode property\">LDA</span> <span class=\"token hexnumber string\">#$83</span>\n\t<span class=\"token opcode property\">STA</span> SQ<span class=\"token decimalnumber string\">1</span>_VOL\n\t<span class=\"token opcode property\">LDA</span> <span class=\"token hexnumber string\">#$94</span>\n\t<span class=\"token opcode property\">STA</span> SQ<span class=\"token decimalnumber string\">1</span>_SWEEP\n\t<span class=\"token opcode property\">STA</span> MusicSquare<span class=\"token decimalnumber string\">1</span>NoteSweep\n\t<span class=\"token opcode property\">BNE</span> ProcessMusicQueue_Square<span class=\"token decimalnumber string\">1</span>Patch\n\nProcessMusicQueue_Square<span class=\"token decimalnumber string\">1</span>Note:\n\t<span class=\"token opcode property\">LDY</span> SoundEffectPlaying<span class=\"token decimalnumber string\">2</span>\n\t<span class=\"token opcode property\">BNE</span> ProcessMusicQueue_Square<span class=\"token decimalnumber string\">1</span>ContinueNote\n\n\t<span class=\"token opcode property\">JSR</span> PlaySquare<span class=\"token decimalnumber string\">1</span>Note\n\n\t<span class=\"token opcode property\">BNE</span> ProcessMusicQueue_Square<span class=\"token decimalnumber string\">1</span>StartNote\n\n\t<span class=\"token opcode property\">LDA</span> MusicSquareInstrumentStartOffset\n\t<span class=\"token opcode property\">JMP</span> ProcessMusicQueue_Square<span class=\"token decimalnumber string\">1</span>UpdateNoteOffset\n\nProcessMusicQueue_Square<span class=\"token decimalnumber string\">1</span>StartNote:\n\t<span class=\"token opcode property\">LDA</span> MusicSquare<span class=\"token decimalnumber string\">1</span>NoteStartLength\n\t<span class=\"token opcode property\">LDX</span> MusicSquareEnvelope <span class=\"token comment\">; always overridden in the following subroutine...?</span>\n\t<span class=\"token opcode property\">JSR</span> SetInstrumentStartOffset\n\nProcessMusicQueue_Square<span class=\"token decimalnumber string\">1</span>UpdateNoteOffset:\n\t<span class=\"token opcode property\">STA</span> MusicSquare<span class=\"token decimalnumber string\">1</span>InstrumentOffset\n\nIFDEF EXPAND_MUSIC\n\t<span class=\"token opcode property\">JSR</span> CheckSquare<span class=\"token decimalnumber string\">1</span>NoteBend\nENDIF\n\n\t<span class=\"token opcode property\">JSR</span> SetSquare<span class=\"token decimalnumber string\">1</span>VolumeAndSweep\n\nProcessMusicQueue_Square<span class=\"token decimalnumber string\">1</span>ContinueNote:\n\t<span class=\"token opcode property\">LDA</span> MusicSquare<span class=\"token decimalnumber string\">1</span>NoteStartLength\n\t<span class=\"token opcode property\">STA</span> MusicSquare<span class=\"token decimalnumber string\">1</span>NoteLength\n\nProcessMusicQueue_Square<span class=\"token decimalnumber string\">1</span>SustainNote:\n\t<span class=\"token opcode property\">LDA</span> SoundEffectPlaying<span class=\"token decimalnumber string\">2</span>\n\t<span class=\"token opcode property\">BNE</span> ProcessMusicQueue_Triangle\n\nIFDEF EXPAND_MUSIC\n\t<span class=\"token opcode property\">LDA</span> MusicSquare<span class=\"token decimalnumber string\">1</span>NoteBend\n\t<span class=\"token opcode property\">BEQ</span> ProcessMusicQueue_LoadSquare<span class=\"token decimalnumber string\">1</span>InstrumentOffset\n\n\t<span class=\"token opcode property\">LDX</span> <span class=\"token hexnumber string\">#$00</span>\n\t<span class=\"token opcode property\">LDA</span> MusicSquare<span class=\"token decimalnumber string\">1</span>NoteStartLength\n\t<span class=\"token opcode property\">JSR</span> UpdateNoteBend\nENDIF\n\nProcessMusicQueue_LoadSquare<span class=\"token decimalnumber string\">1</span>InstrumentOffset:\n\t<span class=\"token opcode property\">LDY</span> MusicSquare<span class=\"token decimalnumber string\">1</span>InstrumentOffset\n\t<span class=\"token opcode property\">BEQ</span> ProcessMusicQueue_Square<span class=\"token decimalnumber string\">1</span>AfterDecrementInstrumentOffset\n\n\t<span class=\"token opcode property\">DEC</span> MusicSquare<span class=\"token decimalnumber string\">1</span>InstrumentOffset\n\nProcessMusicQueue_Square<span class=\"token decimalnumber string\">1</span>AfterDecrementInstrumentOffset:\n\t<span class=\"token opcode property\">LDA</span> MusicSquare<span class=\"token decimalnumber string\">1</span>NoteStartLength\n\t<span class=\"token opcode property\">LDX</span> MusicSquare<span class=\"token decimalnumber string\">1</span>Patch\n\t<span class=\"token opcode property\">JSR</span> LoadSquareInstrumentDVE\n\n\t<span class=\"token opcode property\">STA</span> SQ<span class=\"token decimalnumber string\">1</span>_VOL\n\t<span class=\"token opcode property\">LDA</span> MusicSquare<span class=\"token decimalnumber string\">1</span>NoteSweep\n\t<span class=\"token opcode property\">BNE</span> ProcessMusicQueue_Square<span class=\"token decimalnumber string\">1</span>Sweep\n\n\t<span class=\"token opcode property\">LDA</span> <span class=\"token hexnumber string\">#$7F</span>\n\nProcessMusicQueue_Square<span class=\"token decimalnumber string\">1</span>Sweep:\n\t<span class=\"token opcode property\">STA</span> SQ<span class=\"token decimalnumber string\">1</span>_SWEEP\n\nProcessMusicQueue_Triangle:\n\t<span class=\"token opcode property\">LDA</span> CurrentMusicTriangleOffset\n\t<span class=\"token opcode property\">BEQ</span> ProcessMusicQueue_NoiseDPCM\n\n\t<span class=\"token opcode property\">DEC</span> MusicTriangleNoteLength\n\t<span class=\"token opcode property\">BNE</span> ProcessMusicQueue_NoiseDPCM\n\n\t<span class=\"token opcode property\">LDY</span> CurrentMusicTriangleOffset\n\t<span class=\"token opcode property\">INC</span> CurrentMusicTriangleOffset\n\t<span class=\"token opcode property\">LDA</span> (CurrentMusicPointer), <span class=\"token register variable\">Y</span>\n\t<span class=\"token opcode property\">BEQ</span> ProcessMusicQueue_TriangleSetLength\n\n\t<span class=\"token opcode property\">BPL</span> ProcessMusicQueue_TriangleNote\n\n\t<span class=\"token opcode property\">JSR</span> ProcessMusicQueue_PatchNoteLength\n\n\t<span class=\"token opcode property\">STA</span> MusicTriangleNoteStartLength\n\t<span class=\"token opcode property\">LDA</span> <span class=\"token hexnumber string\">#$1F</span>\n\t<span class=\"token opcode property\">STA</span> TRI_LINEAR\n\t<span class=\"token opcode property\">LDY</span> CurrentMusicTriangleOffset\n\t<span class=\"token opcode property\">INC</span> CurrentMusicTriangleOffset\n\t<span class=\"token opcode property\">LDA</span> (CurrentMusicPointer), <span class=\"token register variable\">Y</span>\n\t<span class=\"token opcode property\">BEQ</span> ProcessMusicQueue_TriangleSetLength\n\nProcessMusicQueue_TriangleNote:\n\t<span class=\"token opcode property\">JSR</span> PlayTriangleNote\n\n\t<span class=\"token opcode property\">LDX</span> MusicTriangleNoteStartLength\n\t<span class=\"token opcode property\">STX</span> MusicTriangleNoteLength\n\t<span class=\"token opcode property\">TXA</span>\n\t<span class=\"token opcode property\">CMP</span> <span class=\"token hexnumber string\">#$0A</span>\n\t<span class=\"token opcode property\">BCC</span> ProcessMusicQueue_TriangleNoteShort\n\n\t<span class=\"token opcode property\">CMP</span> <span class=\"token hexnumber string\">#$1E</span>\n\t<span class=\"token opcode property\">BCS</span> ProcessMusicQueue_TriangleNoteLong\n\nProcessMusicQueue_TriangleNoteMedium:\n\t<span class=\"token opcode property\">LDA</span> <span class=\"token hexnumber string\">#$24</span>\n\t<span class=\"token opcode property\">BNE</span> ProcessMusicQueue_TriangleSetLength\n\nProcessMusicQueue_TriangleNoteShort:\n\t<span class=\"token opcode property\">LDA</span> <span class=\"token hexnumber string\">#$18</span>\n\t<span class=\"token opcode property\">BNE</span> ProcessMusicQueue_TriangleSetLength\n\nProcessMusicQueue_TriangleNoteLong:\n\t<span class=\"token opcode property\">LDA</span> <span class=\"token hexnumber string\">#$6F</span>\n\nProcessMusicQueue_TriangleSetLength:\n\t<span class=\"token opcode property\">STA</span> TRI_LINEAR\n\nProcessMusicQueue_NoiseDPCM:\nIFNDEF EXPAND_MUSIC\n\tIFNDEF PROTOTYPE_MUSIC_UNDERGROUND\n\t\tIFNDEF PROTOTYPE_MUSIC_STARMAN","line":722},{"comment":"skip to DPCM for underground/invincibility music","content":"\t\t\tLDA MusicPlaying1\n\t\t\tAND #Music1_Inside | Music1_Invincible\n\t\t\tBNE ProcessMusicQueue_DPCM\n\t\tELSE","htmlComment":"<p>skip to DPCM for underground/invincibility music</p>\n","htmlContent":"\t\t\t<span class=\"token opcode property\">LDA</span> MusicPlaying<span class=\"token decimalnumber string\">1</span>\n\t\t\t<span class=\"token opcode property\">AND</span> #Music<span class=\"token decimalnumber string\">1</span>_Inside | Music<span class=\"token decimalnumber string\">1</span>_Invincible\n\t\t\t<span class=\"token opcode property\">BNE</span> ProcessMusicQueue_DPCM\n\t\tELSE","line":917},{"comment":"skip to DPCM for underground music ONLY","content":"\t\t\tLDA MusicPlaying1\n\t\t\tAND #Music1_Inside\n\t\t\tBNE ProcessMusicQueue_DPCM\n\t\tENDIF\n\tELSE\n\t\tIFNDEF PROTOTYPE_MUSIC_STARMAN","htmlComment":"<p>skip to DPCM for underground music ONLY</p>\n","htmlContent":"\t\t\t<span class=\"token opcode property\">LDA</span> MusicPlaying<span class=\"token decimalnumber string\">1</span>\n\t\t\t<span class=\"token opcode property\">AND</span> #Music<span class=\"token decimalnumber string\">1</span>_Inside\n\t\t\t<span class=\"token opcode property\">BNE</span> ProcessMusicQueue_DPCM\n\t\tENDIF\n\tELSE\n\t\tIFNDEF PROTOTYPE_MUSIC_STARMAN","line":922},{"comment":"no starman, underground","content":"\t\t\tLDA MusicPlaying1\n\t\t\tAND #Music1_Invincible\n\t\t\tBNE ProcessMusicQueue_DPCM\n\t\tENDIF\n\tENDIF\nENDIF\n\nProcessMusicQueue_Noise:\n\tLDA CurrentMusicNoiseOffset\n\tBEQ ProcessMusicQueue_ThenNoiseEnd\n\n\tDEC MusicNoiseNoteLength\n\tBNE ProcessMusicQueue_ThenNoiseEnd\n\nProcessMusicQueue_NoiseByte:\n\tLDY CurrentMusicNoiseOffset\n\tINC CurrentMusicNoiseOffset\n\tLDA (CurrentMusicPointer), Y\n\tBEQ ProcessMusicQueue_NoiseLoopSegment\n\n\tBPL ProcessMusicQueue_NoiseNote\n\n\tJSR ProcessMusicQueue_PatchNoteLength\n\n\tSTA MusicNoiseNoteStartLength\n\tLDY CurrentMusicNoiseOffset\n\tINC CurrentMusicNoiseOffset\n\tLDA (CurrentMusicPointer), Y\n\tBEQ ProcessMusicQueue_NoiseLoopSegment\n\nProcessMusicQueue_NoiseNote:\n\tLSR A\n\tTAY\n\tLDA NoiseVolTable, Y\n\tSTA NOISE_VOL\n\tLDA NoiseLoTable, Y\n\tSTA NOISE_LO\n\tLDA NoiseHiTable, Y\n\tSTA NOISE_HI\n\tLDA MusicNoiseNoteStartLength\n\tSTA MusicNoiseNoteLength\n\nProcessMusicQueue_ThenNoiseEnd:\n\tJMP ProcessMusicQueue_NoiseEnd\n\nProcessMusicQueue_NoiseLoopSegment:\n\tLDA CurrentMusicNoiseStartOffset\n\tSTA CurrentMusicNoiseOffset\n\tJMP ProcessMusicQueue_NoiseByte\n\nProcessMusicQueue_NoiseEnd:\nIFNDEF EXPAND_MUSIC\n\tLDA MusicPlaying1\n\tIFNDEF PROTOTYPE_MUSIC_STARMAN\n\t\tAND #Music1_Inside | Music1_Invincible\n\tELSE\n\t\tAND #Music1_Inside\n\tENDIF\n\tBNE ProcessMusicQueue_DPCM\n\n\tRTS\nENDIF\n\nProcessMusicQueue_DPCM:\n\tLDA CurrentMusicDPCMOffset\n\tBEQ ProcessMusicQueue_DPCMEnd\n\n\tDEC MusicDPCMNoteLength\n\tBNE ProcessMusicQueue_DPCMEnd\n\nProcessMusicQueue_DPCMByte:\n\tLDY CurrentMusicDPCMOffset\n\tINC CurrentMusicDPCMOffset\n\tLDA (CurrentMusicPointer), Y\n\tBEQ ProcessMusicQueue_DPCMLoopSegment\n\n\tBPL ProcessMusicQueue_DPCMNote\n\n\tJSR ProcessMusicQueue_PatchNoteLength\n\n\tSTA MusicDPCMNoteStartLength\n\tLDY CurrentMusicDPCMOffset\n\tINC CurrentMusicDPCMOffset\n\tLDA (CurrentMusicPointer), Y\n\tBEQ ProcessMusicQueue_DPCMLoopSegment\n\nProcessMusicQueue_DPCMNote:","htmlComment":"<p>no starman, underground</p>\n","htmlContent":"\t\t\t<span class=\"token opcode property\">LDA</span> MusicPlaying<span class=\"token decimalnumber string\">1</span>\n\t\t\t<span class=\"token opcode property\">AND</span> #Music<span class=\"token decimalnumber string\">1</span>_Invincible\n\t\t\t<span class=\"token opcode property\">BNE</span> ProcessMusicQueue_DPCM\n\t\tENDIF\n\tENDIF\nENDIF\n\nProcessMusicQueue_Noise:\n\t<span class=\"token opcode property\">LDA</span> CurrentMusicNoiseOffset\n\t<span class=\"token opcode property\">BEQ</span> ProcessMusicQueue_ThenNoiseEnd\n\n\t<span class=\"token opcode property\">DEC</span> MusicNoiseNoteLength\n\t<span class=\"token opcode property\">BNE</span> ProcessMusicQueue_ThenNoiseEnd\n\nProcessMusicQueue_NoiseByte:\n\t<span class=\"token opcode property\">LDY</span> CurrentMusicNoiseOffset\n\t<span class=\"token opcode property\">INC</span> CurrentMusicNoiseOffset\n\t<span class=\"token opcode property\">LDA</span> (CurrentMusicPointer), <span class=\"token register variable\">Y</span>\n\t<span class=\"token opcode property\">BEQ</span> ProcessMusicQueue_NoiseLoopSegment\n\n\t<span class=\"token opcode property\">BPL</span> ProcessMusicQueue_NoiseNote\n\n\t<span class=\"token opcode property\">JSR</span> ProcessMusicQueue_PatchNoteLength\n\n\t<span class=\"token opcode property\">STA</span> MusicNoiseNoteStartLength\n\t<span class=\"token opcode property\">LDY</span> CurrentMusicNoiseOffset\n\t<span class=\"token opcode property\">INC</span> CurrentMusicNoiseOffset\n\t<span class=\"token opcode property\">LDA</span> (CurrentMusicPointer), <span class=\"token register variable\">Y</span>\n\t<span class=\"token opcode property\">BEQ</span> ProcessMusicQueue_NoiseLoopSegment\n\nProcessMusicQueue_NoiseNote:\n\t<span class=\"token opcode property\">LSR</span> <span class=\"token register variable\">A</span>\n\t<span class=\"token opcode property\">TAY</span>\n\t<span class=\"token opcode property\">LDA</span> NoiseVolTable, <span class=\"token register variable\">Y</span>\n\t<span class=\"token opcode property\">STA</span> NOISE_VOL\n\t<span class=\"token opcode property\">LDA</span> NoiseLoTable, <span class=\"token register variable\">Y</span>\n\t<span class=\"token opcode property\">STA</span> NOISE_LO\n\t<span class=\"token opcode property\">LDA</span> NoiseHiTable, <span class=\"token register variable\">Y</span>\n\t<span class=\"token opcode property\">STA</span> NOISE_HI\n\t<span class=\"token opcode property\">LDA</span> MusicNoiseNoteStartLength\n\t<span class=\"token opcode property\">STA</span> MusicNoiseNoteLength\n\nProcessMusicQueue_ThenNoiseEnd:\n\t<span class=\"token opcode property\">JMP</span> ProcessMusicQueue_NoiseEnd\n\nProcessMusicQueue_NoiseLoopSegment:\n\t<span class=\"token opcode property\">LDA</span> CurrentMusicNoiseStartOffset\n\t<span class=\"token opcode property\">STA</span> CurrentMusicNoiseOffset\n\t<span class=\"token opcode property\">JMP</span> ProcessMusicQueue_NoiseByte\n\nProcessMusicQueue_NoiseEnd:\nIFNDEF EXPAND_MUSIC\n\t<span class=\"token opcode property\">LDA</span> MusicPlaying<span class=\"token decimalnumber string\">1</span>\n\tIFNDEF PROTOTYPE_MUSIC_STARMAN\n\t\t<span class=\"token opcode property\">AND</span> #Music<span class=\"token decimalnumber string\">1</span>_Inside | Music<span class=\"token decimalnumber string\">1</span>_Invincible\n\tELSE\n\t\t<span class=\"token opcode property\">AND</span> #Music<span class=\"token decimalnumber string\">1</span>_Inside\n\tENDIF\n\t<span class=\"token opcode property\">BNE</span> ProcessMusicQueue_DPCM\n\n\t<span class=\"token opcode property\">RTS</span>\nENDIF\n\nProcessMusicQueue_DPCM:\n\t<span class=\"token opcode property\">LDA</span> CurrentMusicDPCMOffset\n\t<span class=\"token opcode property\">BEQ</span> ProcessMusicQueue_DPCMEnd\n\n\t<span class=\"token opcode property\">DEC</span> MusicDPCMNoteLength\n\t<span class=\"token opcode property\">BNE</span> ProcessMusicQueue_DPCMEnd\n\nProcessMusicQueue_DPCMByte:\n\t<span class=\"token opcode property\">LDY</span> CurrentMusicDPCMOffset\n\t<span class=\"token opcode property\">INC</span> CurrentMusicDPCMOffset\n\t<span class=\"token opcode property\">LDA</span> (CurrentMusicPointer), <span class=\"token register variable\">Y</span>\n\t<span class=\"token opcode property\">BEQ</span> ProcessMusicQueue_DPCMLoopSegment\n\n\t<span class=\"token opcode property\">BPL</span> ProcessMusicQueue_DPCMNote\n\n\t<span class=\"token opcode property\">JSR</span> ProcessMusicQueue_PatchNoteLength\n\n\t<span class=\"token opcode property\">STA</span> MusicDPCMNoteStartLength\n\t<span class=\"token opcode property\">LDY</span> CurrentMusicDPCMOffset\n\t<span class=\"token opcode property\">INC</span> CurrentMusicDPCMOffset\n\t<span class=\"token opcode property\">LDA</span> (CurrentMusicPointer), <span class=\"token register variable\">Y</span>\n\t<span class=\"token opcode property\">BEQ</span> ProcessMusicQueue_DPCMLoopSegment\n\nProcessMusicQueue_DPCMNote:","line":929},{"comment":"POI: This left shift precludes using the first DPCM sample (bomb explosion) in the DPCM track.\nThis could be to allow $80 for a \"rest\" note on the DPCM track, but none of the in-game music\ntakes advantage of that.","content":"IFNDEF EXPAND_MUSIC\n\tASL A\nENDIF\n\tSTA DPCMQueue\n\tJSR ProcessDPCMQueue\n\n\tLDA MusicDPCMNoteStartLength\n\tSTA MusicDPCMNoteLength\n\nProcessMusicQueue_DPCMEnd:\n\tRTS\n\nProcessMusicQueue_DPCMLoopSegment:\n\tLDA CurrentMusicDPCMStartOffset\n\tSTA CurrentMusicDPCMOffset\n\tJMP ProcessMusicQueue_DPCMByte\n\n\nNoiseVolTable:\n\t.db $10\n\t.db $1E\n\t.db $1F\n\t.db $16\n\nNoiseLoTable:\n\t.db $00\n\t.db $03\n\t.db $0A\n\t.db $02\n\nNoiseHiTable:\n\t.db $00\n\t.db $18\n\t.db $18\n\t.db $58\n\n","htmlComment":"<p>POI: This left shift precludes using the first DPCM sample (bomb explosion) in the DPCM track.\nThis could be to allow $80 for a \"rest\" note on the DPCM track, but none of the in-game music\ntakes advantage of that.</p>\n","htmlContent":"IFNDEF EXPAND_MUSIC\n\t<span class=\"token opcode property\">ASL</span> <span class=\"token register variable\">A</span>\nENDIF\n\t<span class=\"token opcode property\">STA</span> DPCMQueue\n\t<span class=\"token opcode property\">JSR</span> ProcessDPCMQueue\n\n\t<span class=\"token opcode property\">LDA</span> MusicDPCMNoteStartLength\n\t<span class=\"token opcode property\">STA</span> MusicDPCMNoteLength\n\nProcessMusicQueue_DPCMEnd:\n\t<span class=\"token opcode property\">RTS</span>\n\nProcessMusicQueue_DPCMLoopSegment:\n\t<span class=\"token opcode property\">LDA</span> CurrentMusicDPCMStartOffset\n\t<span class=\"token opcode property\">STA</span> CurrentMusicDPCMOffset\n\t<span class=\"token opcode property\">JMP</span> ProcessMusicQueue_DPCMByte\n\n\nNoiseVolTable:\n\t<span class=\"token directive keyword\">.db</span> <span class=\"token hexnumber string\">$10</span>\n\t<span class=\"token directive keyword\">.db</span> <span class=\"token hexnumber string\">$1E</span>\n\t<span class=\"token directive keyword\">.db</span> <span class=\"token hexnumber string\">$1F</span>\n\t<span class=\"token directive keyword\">.db</span> <span class=\"token hexnumber string\">$16</span>\n\nNoiseLoTable:\n\t<span class=\"token directive keyword\">.db</span> <span class=\"token hexnumber string\">$00</span>\n\t<span class=\"token directive keyword\">.db</span> <span class=\"token hexnumber string\">$03</span>\n\t<span class=\"token directive keyword\">.db</span> <span class=\"token hexnumber string\">$0A</span>\n\t<span class=\"token directive keyword\">.db</span> <span class=\"token hexnumber string\">$02</span>\n\nNoiseHiTable:\n\t<span class=\"token directive keyword\">.db</span> <span class=\"token hexnumber string\">$00</span>\n\t<span class=\"token directive keyword\">.db</span> <span class=\"token hexnumber string\">$18</span>\n\t<span class=\"token directive keyword\">.db</span> <span class=\"token hexnumber string\">$18</span>\n\t<span class=\"token directive keyword\">.db</span> <span class=\"token hexnumber string\">$58</span>\n\n","line":1019},{"comment":"Input\nA = full patch byte\nOutput\nA = new note length","content":"ProcessMusicQueue_PatchNoteLength:\n\tAND #$0F\n\tCLC\n\tADC MusicTempoSetting\n\tTAY\n\tLDA NoteLengthTable, Y\n\tRTS\n","htmlComment":"<p>Input\nA = full patch byte\nOutput\nA = new note length</p>\n","htmlContent":"ProcessMusicQueue_PatchNoteLength:\n\t<span class=\"token opcode property\">AND</span> <span class=\"token hexnumber string\">#$0F</span>\n\t<span class=\"token opcode property\">CLC</span>\n\t<span class=\"token opcode property\">ADC</span> MusicTempoSetting\n\t<span class=\"token opcode property\">TAY</span>\n\t<span class=\"token opcode property\">LDA</span> NoteLengthTable, <span class=\"token register variable\">Y</span>\n\t<span class=\"token opcode property\">RTS</span>\n","line":1060},{"comment":"Input\nA = note start length, >= $13 for table A, < $13 for instrument table B\nOuput\nA = starting instrument offset ($16 for short, $3F for long)\nX = duty/volume/envelope ($82)\nY = sweep ($7F)\n","content":"SetInstrumentStartOffset:\n\tCMP #$13\n\tBCC SetInstrumentStartOffset_Short\n\tLDA #$3F\n\tBNE SetInstrumentStartOffset_Exit\nSetInstrumentStartOffset_Short:\n\tLDA #$16\nSetInstrumentStartOffset_Exit:\n\tLDX #$82\n\tLDY #$7F\n\tRTS\n","htmlComment":"<p>Input\nA = note start length, >= $13 for table A, &#x3C; $13 for instrument table B\nOuput\nA = starting instrument offset ($16 for short, $3F for long)\nX = duty/volume/envelope ($82)\nY = sweep ($7F)</p>\n","htmlContent":"SetInstrumentStartOffset:\n\t<span class=\"token opcode property\">CMP</span> <span class=\"token hexnumber string\">#$13</span>\n\t<span class=\"token opcode property\">BCC</span> SetInstrumentStartOffset_Short\n\t<span class=\"token opcode property\">LDA</span> <span class=\"token hexnumber string\">#$3F</span>\n\t<span class=\"token opcode property\">BNE</span> SetInstrumentStartOffset_Exit\nSetInstrumentStartOffset_Short:\n\t<span class=\"token opcode property\">LDA</span> <span class=\"token hexnumber string\">#$16</span>\nSetInstrumentStartOffset_Exit:\n\t<span class=\"token opcode property\">LDX</span> <span class=\"token hexnumber string\">#$82</span>\n\t<span class=\"token opcode property\">LDY</span> <span class=\"token hexnumber string\">#$7F</span>\n\t<span class=\"token opcode property\">RTS</span>\n","line":1075},{"comment":"\nLoads instrument data for a square channel\n\nEach instrument has two lookup tables based on the note length.\n\nInput\nA = note length, >= $13 for table A, < $13 for instrument table B\nX = instrument patch\nY = instrument offset\nOutput\nA = duty/volume/envelope\n","content":"LoadSquareInstrumentDVE:\n\tCPX #$90\n\tBEQ LoadSquareInstrumentDVE_90_E0\n\n\tCPX #$E0\n\tBEQ LoadSquareInstrumentDVE_90_E0\n\n\tCPX #$A0\n\tBEQ LoadSquareInstrumentDVE_A0\n\n\tCPX #$B0\n\tBEQ LoadSquareInstrumentDVE_B0\n\n\tCPX #$C0\n\tBEQ LoadSquareInstrumentDVE_C0\n\n\tCPX #$D0\n\tBEQ LoadSquareInstrumentDVE_D0\n\n\tCPX #$F0\n\tBEQ LoadSquareInstrumentDVE_F0\n\nLoadSquareInstrumentDVE_80:\n\tCMP #$13\n\tBCC LoadSquareInstrumentDVE_80_Short\n\tLDA InstrumentDVE_80, Y\n\tBNE LoadSquareInstrumentDVE_80_Exit\nLoadSquareInstrumentDVE_80_Short:\n\tLDA InstrumentDVE_80_Short, Y\nLoadSquareInstrumentDVE_80_Exit:\n\tRTS\n\nLoadSquareInstrumentDVE_90_E0:\n\tCMP #$13\n\tBCC LoadSquareInstrumentDVE_90_E0_Short\n\tLDA InstrumentDVE_90_E0, Y\n\tBNE LoadSquareInstrumentDVE_90_E0_Exit\nLoadSquareInstrumentDVE_90_E0_Short:\n\tLDA InstrumentDVE_90_E0_Short, Y\nLoadSquareInstrumentDVE_90_E0_Exit:\n\tRTS\n\nLoadSquareInstrumentDVE_A0:\n\tCMP #$13\n\tBCC LoadSquareInstrumentDVE_A0_Short\n\tLDA InstrumentDVE_A0, Y\n\tBNE LoadSquareInstrumentDVE_A0_Exit\nLoadSquareInstrumentDVE_A0_Short:\n\tLDA InstrumentDVE_A0_Short, Y\nLoadSquareInstrumentDVE_A0_Exit:\n\tRTS\n\nLoadSquareInstrumentDVE_B0:\n\tCMP #$13\n\tBCC LoadSquareInstrumentDVE_B0_Short\n\tLDA InstrumentDVE_B0, Y\n\tBNE LoadSquareInstrumentDVE_B0_Exit\nLoadSquareInstrumentDVE_B0_Short:\n\tLDA InstrumentDVE_B0_Short, Y\nLoadSquareInstrumentDVE_B0_Exit:\n\tRTS\n\nLoadSquareInstrumentDVE_C0:\n\tCMP #$13\n\tBCC LoadSquareInstrumentDVE_C0_Short\n\tLDA InstrumentDVE_C0, Y\n\tBNE LoadSquareInstrumentDVE_C0_Exit\nLoadSquareInstrumentDVE_C0_Short:\n\tLDA InstrumentDVE_C0_Short, Y\nLoadSquareInstrumentDVE_C0_Exit:\n\tRTS\n\nLoadSquareInstrumentDVE_F0:\n\tCMP #$13\n\tBCC LoadSquareInstrumentDVE_F0_Short\n\tLDA InstrumentDVE_F0, Y\n\tBNE LoadSquareInstrumentDVE_F0_Exit\nLoadSquareInstrumentDVE_F0_Short:\n\tLDA InstrumentDVE_F0_Short, Y\nLoadSquareInstrumentDVE_F0_Exit:\n\tRTS\n\nLoadSquareInstrumentDVE_D0:\n\tCMP #$13\n\tBCC LoadSquareInstrumentDVE_D0_Short\n\tLDA InstrumentDVE_D0, Y\n\tBNE LoadSquareInstrumentDVE_D0_Exit\nLoadSquareInstrumentDVE_D0_Short:\n\tLDA InstrumentDVE_D0_Short, Y\nLoadSquareInstrumentDVE_D0_Exit:\n\tRTS\n\n","htmlComment":"<p>Loads instrument data for a square channel</p>\n<p>Each instrument has two lookup tables based on the note length.</p>\n<p>Input\nA = note length, >= $13 for table A, &#x3C; $13 for instrument table B\nX = instrument patch\nY = instrument offset\nOutput\nA = duty/volume/envelope</p>\n","htmlContent":"LoadSquareInstrumentDVE:\n\t<span class=\"token opcode property\">CPX</span> <span class=\"token hexnumber string\">#$90</span>\n\t<span class=\"token opcode property\">BEQ</span> LoadSquareInstrumentDVE_<span class=\"token decimalnumber string\">90</span>_E<span class=\"token decimalnumber string\">0</span>\n\n\t<span class=\"token opcode property\">CPX</span> <span class=\"token hexnumber string\">#$E0</span>\n\t<span class=\"token opcode property\">BEQ</span> LoadSquareInstrumentDVE_<span class=\"token decimalnumber string\">90</span>_E<span class=\"token decimalnumber string\">0</span>\n\n\t<span class=\"token opcode property\">CPX</span> <span class=\"token hexnumber string\">#$A0</span>\n\t<span class=\"token opcode property\">BEQ</span> LoadSquareInstrumentDVE_A<span class=\"token decimalnumber string\">0</span>\n\n\t<span class=\"token opcode property\">CPX</span> <span class=\"token hexnumber string\">#$B0</span>\n\t<span class=\"token opcode property\">BEQ</span> LoadSquareInstrumentDVE_B<span class=\"token decimalnumber string\">0</span>\n\n\t<span class=\"token opcode property\">CPX</span> <span class=\"token hexnumber string\">#$C0</span>\n\t<span class=\"token opcode property\">BEQ</span> LoadSquareInstrumentDVE_C<span class=\"token decimalnumber string\">0</span>\n\n\t<span class=\"token opcode property\">CPX</span> <span class=\"token hexnumber string\">#$D0</span>\n\t<span class=\"token opcode property\">BEQ</span> LoadSquareInstrumentDVE_D<span class=\"token decimalnumber string\">0</span>\n\n\t<span class=\"token opcode property\">CPX</span> <span class=\"token hexnumber string\">#$F0</span>\n\t<span class=\"token opcode property\">BEQ</span> LoadSquareInstrumentDVE_F<span class=\"token decimalnumber string\">0</span>\n\nLoadSquareInstrumentDVE_<span class=\"token decimalnumber string\">80</span>:\n\t<span class=\"token opcode property\">CMP</span> <span class=\"token hexnumber string\">#$13</span>\n\t<span class=\"token opcode property\">BCC</span> LoadSquareInstrumentDVE_<span class=\"token decimalnumber string\">80</span>_Short\n\t<span class=\"token opcode property\">LDA</span> InstrumentDVE_<span class=\"token decimalnumber string\">80</span>, <span class=\"token register variable\">Y</span>\n\t<span class=\"token opcode property\">BNE</span> LoadSquareInstrumentDVE_<span class=\"token decimalnumber string\">80</span>_Exit\nLoadSquareInstrumentDVE_<span class=\"token decimalnumber string\">80</span>_Short:\n\t<span class=\"token opcode property\">LDA</span> InstrumentDVE_<span class=\"token decimalnumber string\">80</span>_Short, <span class=\"token register variable\">Y</span>\nLoadSquareInstrumentDVE_<span class=\"token decimalnumber string\">80</span>_Exit:\n\t<span class=\"token opcode property\">RTS</span>\n\nLoadSquareInstrumentDVE_<span class=\"token decimalnumber string\">90</span>_E<span class=\"token decimalnumber string\">0</span>:\n\t<span class=\"token opcode property\">CMP</span> <span class=\"token hexnumber string\">#$13</span>\n\t<span class=\"token opcode property\">BCC</span> LoadSquareInstrumentDVE_<span class=\"token decimalnumber string\">90</span>_E<span class=\"token decimalnumber string\">0</span>_Short\n\t<span class=\"token opcode property\">LDA</span> InstrumentDVE_<span class=\"token decimalnumber string\">90</span>_E<span class=\"token decimalnumber string\">0</span>, <span class=\"token register variable\">Y</span>\n\t<span class=\"token opcode property\">BNE</span> LoadSquareInstrumentDVE_<span class=\"token decimalnumber string\">90</span>_E<span class=\"token decimalnumber string\">0</span>_Exit\nLoadSquareInstrumentDVE_<span class=\"token decimalnumber string\">90</span>_E<span class=\"token decimalnumber string\">0</span>_Short:\n\t<span class=\"token opcode property\">LDA</span> InstrumentDVE_<span class=\"token decimalnumber string\">90</span>_E<span class=\"token decimalnumber string\">0</span>_Short, <span class=\"token register variable\">Y</span>\nLoadSquareInstrumentDVE_<span class=\"token decimalnumber string\">90</span>_E<span class=\"token decimalnumber string\">0</span>_Exit:\n\t<span class=\"token opcode property\">RTS</span>\n\nLoadSquareInstrumentDVE_A<span class=\"token decimalnumber string\">0</span>:\n\t<span class=\"token opcode property\">CMP</span> <span class=\"token hexnumber string\">#$13</span>\n\t<span class=\"token opcode property\">BCC</span> LoadSquareInstrumentDVE_A<span class=\"token decimalnumber string\">0</span>_Short\n\t<span class=\"token opcode property\">LDA</span> InstrumentDVE_A<span class=\"token decimalnumber string\">0</span>, <span class=\"token register variable\">Y</span>\n\t<span class=\"token opcode property\">BNE</span> LoadSquareInstrumentDVE_A<span class=\"token decimalnumber string\">0</span>_Exit\nLoadSquareInstrumentDVE_A<span class=\"token decimalnumber string\">0</span>_Short:\n\t<span class=\"token opcode property\">LDA</span> InstrumentDVE_A<span class=\"token decimalnumber string\">0</span>_Short, <span class=\"token register variable\">Y</span>\nLoadSquareInstrumentDVE_A<span class=\"token decimalnumber string\">0</span>_Exit:\n\t<span class=\"token opcode property\">RTS</span>\n\nLoadSquareInstrumentDVE_B<span class=\"token decimalnumber string\">0</span>:\n\t<span class=\"token opcode property\">CMP</span> <span class=\"token hexnumber string\">#$13</span>\n\t<span class=\"token opcode property\">BCC</span> LoadSquareInstrumentDVE_B<span class=\"token decimalnumber string\">0</span>_Short\n\t<span class=\"token opcode property\">LDA</span> InstrumentDVE_B<span class=\"token decimalnumber string\">0</span>, <span class=\"token register variable\">Y</span>\n\t<span class=\"token opcode property\">BNE</span> LoadSquareInstrumentDVE_B<span class=\"token decimalnumber string\">0</span>_Exit\nLoadSquareInstrumentDVE_B<span class=\"token decimalnumber string\">0</span>_Short:\n\t<span class=\"token opcode property\">LDA</span> InstrumentDVE_B<span class=\"token decimalnumber string\">0</span>_Short, <span class=\"token register variable\">Y</span>\nLoadSquareInstrumentDVE_B<span class=\"token decimalnumber string\">0</span>_Exit:\n\t<span class=\"token opcode property\">RTS</span>\n\nLoadSquareInstrumentDVE_C<span class=\"token decimalnumber string\">0</span>:\n\t<span class=\"token opcode property\">CMP</span> <span class=\"token hexnumber string\">#$13</span>\n\t<span class=\"token opcode property\">BCC</span> LoadSquareInstrumentDVE_C<span class=\"token decimalnumber string\">0</span>_Short\n\t<span class=\"token opcode property\">LDA</span> InstrumentDVE_C<span class=\"token decimalnumber string\">0</span>, <span class=\"token register variable\">Y</span>\n\t<span class=\"token opcode property\">BNE</span> LoadSquareInstrumentDVE_C<span class=\"token decimalnumber string\">0</span>_Exit\nLoadSquareInstrumentDVE_C<span class=\"token decimalnumber string\">0</span>_Short:\n\t<span class=\"token opcode property\">LDA</span> InstrumentDVE_C<span class=\"token decimalnumber string\">0</span>_Short, <span class=\"token register variable\">Y</span>\nLoadSquareInstrumentDVE_C<span class=\"token decimalnumber string\">0</span>_Exit:\n\t<span class=\"token opcode property\">RTS</span>\n\nLoadSquareInstrumentDVE_F<span class=\"token decimalnumber string\">0</span>:\n\t<span class=\"token opcode property\">CMP</span> <span class=\"token hexnumber string\">#$13</span>\n\t<span class=\"token opcode property\">BCC</span> LoadSquareInstrumentDVE_F<span class=\"token decimalnumber string\">0</span>_Short\n\t<span class=\"token opcode property\">LDA</span> InstrumentDVE_F<span class=\"token decimalnumber string\">0</span>, <span class=\"token register variable\">Y</span>\n\t<span class=\"token opcode property\">BNE</span> LoadSquareInstrumentDVE_F<span class=\"token decimalnumber string\">0</span>_Exit\nLoadSquareInstrumentDVE_F<span class=\"token decimalnumber string\">0</span>_Short:\n\t<span class=\"token opcode property\">LDA</span> InstrumentDVE_F<span class=\"token decimalnumber string\">0</span>_Short, <span class=\"token register variable\">Y</span>\nLoadSquareInstrumentDVE_F<span class=\"token decimalnumber string\">0</span>_Exit:\n\t<span class=\"token opcode property\">RTS</span>\n\nLoadSquareInstrumentDVE_D<span class=\"token decimalnumber string\">0</span>:\n\t<span class=\"token opcode property\">CMP</span> <span class=\"token hexnumber string\">#$13</span>\n\t<span class=\"token opcode property\">BCC</span> LoadSquareInstrumentDVE_D<span class=\"token decimalnumber string\">0</span>_Short\n\t<span class=\"token opcode property\">LDA</span> InstrumentDVE_D<span class=\"token decimalnumber string\">0</span>, <span class=\"token register variable\">Y</span>\n\t<span class=\"token opcode property\">BNE</span> LoadSquareInstrumentDVE_D<span class=\"token decimalnumber string\">0</span>_Exit\nLoadSquareInstrumentDVE_D<span class=\"token decimalnumber string\">0</span>_Short:\n\t<span class=\"token opcode property\">LDA</span> InstrumentDVE_D<span class=\"token decimalnumber string\">0</span>_Short, <span class=\"token register variable\">Y</span>\nLoadSquareInstrumentDVE_D<span class=\"token decimalnumber string\">0</span>_Exit:\n\t<span class=\"token opcode property\">RTS</span>\n\n","line":1099},{"comment":"Sets volume/sweep on Square 1 channel\n\nInput\nX = duty/volume/envelope\nY = sweep","content":"SetSquare1VolumeAndSweep:\n\tSTY SQ1_SWEEP\n\tSTX SQ1_VOL\n\tRTS\n","htmlComment":"<p>Sets volume/sweep on Square 1 channel</p>\n<p>Input\nX = duty/volume/envelope\nY = sweep</p>\n","htmlContent":"SetSquare<span class=\"token decimalnumber string\">1</span>VolumeAndSweep:\n\t<span class=\"token opcode property\">STY</span> SQ<span class=\"token decimalnumber string\">1</span>_SWEEP\n\t<span class=\"token opcode property\">STX</span> SQ<span class=\"token decimalnumber string\">1</span>_VOL\n\t<span class=\"token opcode property\">RTS</span>\n","line":1197},{"comment":"Sets volume/sweep on Square 2 channel\n\nInput\nX = duty/volume/envelope\nY = sweep","content":"SetSquare2VolumeAndSweep:\n\tSTX SQ2_VOL\n\tSTY SQ2_SWEEP\n\tRTS\n","htmlComment":"<p>Sets volume/sweep on Square 2 channel</p>\n<p>Input\nX = duty/volume/envelope\nY = sweep</p>\n","htmlContent":"SetSquare<span class=\"token decimalnumber string\">2</span>VolumeAndSweep:\n\t<span class=\"token opcode property\">STX</span> SQ<span class=\"token decimalnumber string\">2</span>_VOL\n\t<span class=\"token opcode property\">STY</span> SQ<span class=\"token decimalnumber string\">2</span>_SWEEP\n\t<span class=\"token opcode property\">RTS</span>\n","line":1207},{"comment":"Sets volume/sweep on Square 1 channel and plays a note\n\nInput\nA = note\nX = duty/volume/envelope\nY = sweep","content":"PlaySquare1Sweep:\n\tSTX SQ1_VOL\n\tSTY SQ1_SWEEP\n","htmlComment":"<p>Sets volume/sweep on Square 1 channel and plays a note</p>\n<p>Input\nA = note\nX = duty/volume/envelope\nY = sweep</p>\n","htmlContent":"PlaySquare<span class=\"token decimalnumber string\">1</span>Sweep:\n\t<span class=\"token opcode property\">STX</span> SQ<span class=\"token decimalnumber string\">1</span>_VOL\n\t<span class=\"token opcode property\">STY</span> SQ<span class=\"token decimalnumber string\">1</span>_SWEEP\n","line":1218},{"comment":"Play a note on the Square 1 channel\n\nInput\nA = note","content":"PlaySquare1Note:\n\tLDX #$00\n","htmlComment":"<p>Play a note on the Square 1 channel</p>\n<p>Input\nA = note</p>\n","htmlContent":"PlaySquare<span class=\"token decimalnumber string\">1</span>Note:\n\t<span class=\"token opcode property\">LDX</span> <span class=\"token hexnumber string\">#$00</span>\n","line":1226},{"comment":"Plays a note\n\nInput\nA = note\nX = channel\n$00: square 1\n$04: square 2\n$08: triangle\n$0C: noise\nOutput\nA = $00 for rest, hi frequency otherwise","content":"PlayNote:\n\tCMP #$7E\n\tBNE PlayNote_NotRest\n\n\tLDA #$10\n\tSTA SQ1_VOL, X\n\tLDA #$00\n\tRTS\n\nPlayNote_NotRest:\n\tLDY #$01\n\tSTY NextOctave\n\tPHA\n\tTAY\n\tBMI PlayNote_LoadFrequencyData\n\nPlayNote_IncrementOctave:\n\tINC NextOctave\n\tSEC\n\tSBC #$18\n\tBPL PlayNote_IncrementOctave\n\nPlayNote_LoadFrequencyData:\n\tCLC\n\tADC #$18\n\tTAY\n\tLDA NoteFrequencyData, Y\n\tSTA NextFrequencyLo\n\tLDA NoteFrequencyData + 1, Y\n\tSTA NextFrequencyHi\n\nPlayNote_FrequencyOctaveLoop:\n\tLSR NextFrequencyHi\n\tROR NextFrequencyLo\n\tDEC NextOctave\n\tBNE PlayNote_FrequencyOctaveLoop\n\n\tPLA\n\tCMP #$38\n\tBCC PlayNote_CheckSquareChorus\n","htmlComment":"<p>Plays a note</p>\n<p>Input\nA = note\nX = channel\n$00: square 1\n$04: square 2\n$08: triangle\n$0C: noise\nOutput\nA = $00 for rest, hi frequency otherwise</p>\n","htmlContent":"PlayNote:\n\t<span class=\"token opcode property\">CMP</span> <span class=\"token hexnumber string\">#$7E</span>\n\t<span class=\"token opcode property\">BNE</span> PlayNote_NotRest\n\n\t<span class=\"token opcode property\">LDA</span> <span class=\"token hexnumber string\">#$10</span>\n\t<span class=\"token opcode property\">STA</span> SQ<span class=\"token decimalnumber string\">1</span>_VOL, <span class=\"token register variable\">X</span>\n\t<span class=\"token opcode property\">LDA</span> <span class=\"token hexnumber string\">#$00</span>\n\t<span class=\"token opcode property\">RTS</span>\n\nPlayNote_NotRest:\n\t<span class=\"token opcode property\">LDY</span> <span class=\"token hexnumber string\">#$01</span>\n\t<span class=\"token opcode property\">STY</span> NextOctave\n\t<span class=\"token opcode property\">PHA</span>\n\t<span class=\"token opcode property\">TAY</span>\n\t<span class=\"token opcode property\">BMI</span> PlayNote_LoadFrequencyData\n\nPlayNote_IncrementOctave:\n\t<span class=\"token opcode property\">INC</span> NextOctave\n\t<span class=\"token opcode property\">SEC</span>\n\t<span class=\"token opcode property\">SBC</span> <span class=\"token hexnumber string\">#$18</span>\n\t<span class=\"token opcode property\">BPL</span> PlayNote_IncrementOctave\n\nPlayNote_LoadFrequencyData:\n\t<span class=\"token opcode property\">CLC</span>\n\t<span class=\"token opcode property\">ADC</span> <span class=\"token hexnumber string\">#$18</span>\n\t<span class=\"token opcode property\">TAY</span>\n\t<span class=\"token opcode property\">LDA</span> NoteFrequencyData, <span class=\"token register variable\">Y</span>\n\t<span class=\"token opcode property\">STA</span> NextFrequencyLo\n\t<span class=\"token opcode property\">LDA</span> NoteFrequencyData + <span class=\"token decimalnumber string\">1</span>, <span class=\"token register variable\">Y</span>\n\t<span class=\"token opcode property\">STA</span> NextFrequencyHi\n\nPlayNote_FrequencyOctaveLoop:\n\t<span class=\"token opcode property\">LSR</span> NextFrequencyHi\n\t<span class=\"token opcode property\">ROR</span> NextFrequencyLo\n\t<span class=\"token opcode property\">DEC</span> NextOctave\n\t<span class=\"token opcode property\">BNE</span> PlayNote_FrequencyOctaveLoop\n\n\t<span class=\"token opcode property\">PLA</span>\n\t<span class=\"token opcode property\">CMP</span> <span class=\"token hexnumber string\">#$38</span>\n\t<span class=\"token opcode property\">BCC</span> PlayNote_CheckSquareChorus\n","line":1240},{"comment":"tweak the frequency for notes >= $38","content":"\tDEC NextFrequencyLo\n","htmlComment":"<p>tweak the frequency for notes >= $38</p>\n","htmlContent":"\t<span class=\"token opcode property\">DEC</span> NextFrequencyLo\n","line":1282},{"comment":"\nSquare 2 plays slightly detuned when Square 1 is using instrument E0\n\nThis can be used to achieve a honky tonk piano effect, which is used for the\ntitle screen as well as the bridge of the overworld theme.\n","content":"PlayNote_CheckSquareChorus:\n\tTXA\n\tCMP #APUOffset_Square2\n\tBNE PlayNote_SetFrequency\n\n\tLDA MusicSquare1Patch\n\tCMP #$E0\n\tBEQ PlayNote_SetFrequency_Square2Detuned\n\nIFDEF EXPAND_MUSIC\n\tLDA MusicSquare1NoteBend, X\n\tBNE NoteBendStashFrequency\nENDIF\n\nPlayNote_SetFrequency:\n\tLDA NextFrequencyLo\n\tSTA SQ1_LO, X\n\tSTA MusicSquare1Lo, X ; unused\n\tLDA NextFrequencyHi\n\tORA #$08\n\tSTA SQ1_HI, X\n\tRTS\n\nPlayNote_SetFrequency_Square2Detuned:\n\tLDA NextFrequencyLo\n\tSEC\n\tSBC #$02\n\tSTA SQ2_LO\n\tSTA MusicSquare2Lo\n\tLDA NextFrequencyHi\n\tORA #$08\n\tSTA SQ2_HI\n\tRTS\n","htmlComment":"<p>Square 2 plays slightly detuned when Square 1 is using instrument E0</p>\n<p>This can be used to achieve a honky tonk piano effect, which is used for the\ntitle screen as well as the bridge of the overworld theme.</p>\n","htmlContent":"PlayNote_CheckSquareChorus:\n\t<span class=\"token opcode property\">TXA</span>\n\t<span class=\"token opcode property\">CMP</span> #APUOffset_Square<span class=\"token decimalnumber string\">2</span>\n\t<span class=\"token opcode property\">BNE</span> PlayNote_SetFrequency\n\n\t<span class=\"token opcode property\">LDA</span> MusicSquare<span class=\"token decimalnumber string\">1</span>Patch\n\t<span class=\"token opcode property\">CMP</span> <span class=\"token hexnumber string\">#$E0</span>\n\t<span class=\"token opcode property\">BEQ</span> PlayNote_SetFrequency_Square<span class=\"token decimalnumber string\">2</span>Detuned\n\nIFDEF EXPAND_MUSIC\n\t<span class=\"token opcode property\">LDA</span> MusicSquare<span class=\"token decimalnumber string\">1</span>NoteBend, <span class=\"token register variable\">X</span>\n\t<span class=\"token opcode property\">BNE</span> NoteBendStashFrequency\nENDIF\n\nPlayNote_SetFrequency:\n\t<span class=\"token opcode property\">LDA</span> NextFrequencyLo\n\t<span class=\"token opcode property\">STA</span> SQ<span class=\"token decimalnumber string\">1</span>_LO, <span class=\"token register variable\">X</span>\n\t<span class=\"token opcode property\">STA</span> MusicSquare<span class=\"token decimalnumber string\">1</span>Lo, <span class=\"token register variable\">X</span> <span class=\"token comment\">; unused</span>\n\t<span class=\"token opcode property\">LDA</span> NextFrequencyHi\n\t<span class=\"token opcode property\">ORA</span> <span class=\"token hexnumber string\">#$08</span>\n\t<span class=\"token opcode property\">STA</span> SQ<span class=\"token decimalnumber string\">1</span>_HI, <span class=\"token register variable\">X</span>\n\t<span class=\"token opcode property\">RTS</span>\n\nPlayNote_SetFrequency_Square<span class=\"token decimalnumber string\">2</span>Detuned:\n\t<span class=\"token opcode property\">LDA</span> NextFrequencyLo\n\t<span class=\"token opcode property\">SEC</span>\n\t<span class=\"token opcode property\">SBC</span> <span class=\"token hexnumber string\">#$02</span>\n\t<span class=\"token opcode property\">STA</span> SQ<span class=\"token decimalnumber string\">2</span>_LO\n\t<span class=\"token opcode property\">STA</span> MusicSquare<span class=\"token decimalnumber string\">2</span>Lo\n\t<span class=\"token opcode property\">LDA</span> NextFrequencyHi\n\t<span class=\"token opcode property\">ORA</span> <span class=\"token hexnumber string\">#$08</span>\n\t<span class=\"token opcode property\">STA</span> SQ<span class=\"token decimalnumber string\">2</span>_HI\n\t<span class=\"token opcode property\">RTS</span>\n","line":1290},{"comment":"(not referenced)\nSets volume/sweep on Square 2 channel and plays a note\n\nInput\nA = note\nX = duty/volume/envelope\nY = sweep","content":"PlaySquare2Sweep:\n\tSTX SQ2_VOL\n\tSTY SQ2_SWEEP\n","htmlComment":"<p>(not referenced)\nSets volume/sweep on Square 2 channel and plays a note</p>\n<p>Input\nA = note\nX = duty/volume/envelope\nY = sweep</p>\n","htmlContent":"PlaySquare<span class=\"token decimalnumber string\">2</span>Sweep:\n\t<span class=\"token opcode property\">STX</span> SQ<span class=\"token decimalnumber string\">2</span>_VOL\n\t<span class=\"token opcode property\">STY</span> SQ<span class=\"token decimalnumber string\">2</span>_SWEEP\n","line":1331},{"comment":"Play a note on the Square 2 channel\n\nInput\nA = note","content":"PlaySquare2Note:\n\tLDX #APUOffset_Square2\n\tBNE PlayNote\n","htmlComment":"<p>Play a note on the Square 2 channel</p>\n<p>Input\nA = note</p>\n","htmlContent":"PlaySquare<span class=\"token decimalnumber string\">2</span>Note:\n\t<span class=\"token opcode property\">LDX</span> #APUOffset_Square<span class=\"token decimalnumber string\">2</span>\n\t<span class=\"token opcode property\">BNE</span> PlayNote\n","line":1339},{"comment":"Play a note on the Triangle channel\n\nInput\nA = note","content":"PlayTriangleNote:\n\tLDX #APUOffset_Triangle\n\tBNE PlayNote\n\n\nIFDEF EXPAND_MUSIC","htmlComment":"<p>Play a note on the Triangle channel</p>\n<p>Input\nA = note</p>\n","htmlContent":"PlayTriangleNote:\n\t<span class=\"token opcode property\">LDX</span> #APUOffset_Triangle\n\t<span class=\"token opcode property\">BNE</span> PlayNote\n\n\nIFDEF EXPAND_MUSIC","line":1347},{"comment":"\nDetermines whether the currently playing track should stop\n\nInput\nA = MusicPlaying2\n","content":"CheckStopMusic:\n\tCMP #Music1_Overworld\n\tBEQ CheckStopMusic_Resume\n\tCMP #Music1_Inside\n\tBEQ CheckStopMusic_Resume\n\tCMP #Music1_Subspace\n\tBEQ CheckStopMusic_Resume\n\nCheckStopMusic_Stop:\n\tLDA #$00\n\tRTS\n\nCheckStopMusic_Resume:\n\tLDA #$01\n\tRTS\n\n","htmlComment":"<p>Determines whether the currently playing track should stop</p>\n<p>Input\nA = MusicPlaying2</p>\n","htmlContent":"CheckStopMusic:\n\t<span class=\"token opcode property\">CMP</span> #Music<span class=\"token decimalnumber string\">1</span>_Overworld\n\t<span class=\"token opcode property\">BEQ</span> CheckStopMusic_Resume\n\t<span class=\"token opcode property\">CMP</span> #Music<span class=\"token decimalnumber string\">1</span>_Inside\n\t<span class=\"token opcode property\">BEQ</span> CheckStopMusic_Resume\n\t<span class=\"token opcode property\">CMP</span> #Music<span class=\"token decimalnumber string\">1</span>_Subspace\n\t<span class=\"token opcode property\">BEQ</span> CheckStopMusic_Resume\n\nCheckStopMusic_Stop:\n\t<span class=\"token opcode property\">LDA</span> <span class=\"token hexnumber string\">#$00</span>\n\t<span class=\"token opcode property\">RTS</span>\n\nCheckStopMusic_Resume:\n\t<span class=\"token opcode property\">LDA</span> <span class=\"token hexnumber string\">#$01</span>\n\t<span class=\"token opcode property\">RTS</span>\n\n","line":1359},{"comment":"\nReads ahead to see if we have a note bend\n","content":"CheckSquare2NoteBend:\n\tLDY CurrentMusicSquare2Offset\n\tLDA (CurrentMusicPointer), Y\n\tCMP #$FF\n\tBNE CheckSquare2NoteBend_Exit\n\n\tINC CurrentMusicSquare2Offset\n\n\tLDA MusicSquare2Lo\n\tSTA MusicSquare2NoteBend\n\n\tPLA\n\tPLA\n\tJMP ProcessMusicQueue_Square2NextOffset\n\nCheckSquare2NoteBend_Exit:\n\tRTS\n\n","htmlComment":"<p>Reads ahead to see if we have a note bend</p>\n","htmlContent":"CheckSquare<span class=\"token decimalnumber string\">2</span>NoteBend:\n\t<span class=\"token opcode property\">LDY</span> CurrentMusicSquare<span class=\"token decimalnumber string\">2</span>Offset\n\t<span class=\"token opcode property\">LDA</span> (CurrentMusicPointer), <span class=\"token register variable\">Y</span>\n\t<span class=\"token opcode property\">CMP</span> <span class=\"token hexnumber string\">#$FF</span>\n\t<span class=\"token opcode property\">BNE</span> CheckSquare<span class=\"token decimalnumber string\">2</span>NoteBend_Exit\n\n\t<span class=\"token opcode property\">INC</span> CurrentMusicSquare<span class=\"token decimalnumber string\">2</span>Offset\n\n\t<span class=\"token opcode property\">LDA</span> MusicSquare<span class=\"token decimalnumber string\">2</span>Lo\n\t<span class=\"token opcode property\">STA</span> MusicSquare<span class=\"token decimalnumber string\">2</span>NoteBend\n\n\t<span class=\"token opcode property\">PLA</span>\n\t<span class=\"token opcode property\">PLA</span>\n\t<span class=\"token opcode property\">JMP</span> ProcessMusicQueue_Square<span class=\"token decimalnumber string\">2</span>NextOffset\n\nCheckSquare<span class=\"token decimalnumber string\">2</span>NoteBend_Exit:\n\t<span class=\"token opcode property\">RTS</span>\n\n","line":1379},{"comment":"\nReads ahead to see if we have a note bend\n","content":"CheckSquare1NoteBend:\n\tLDY CurrentMusicSquare1Offset\n\tLDA (CurrentMusicPointer), Y\n\tCMP #$FF\n\tBNE CheckSquare1NoteBend_Exit\n\n\tINC CurrentMusicSquare1Offset\n\n\tLDA MusicSquare1Lo\n\tSTA MusicSquare1NoteBend\n\n\tPLA\n\tPLA\n\tJMP ProcessMusicQueue_Square1NextOffset\n\nCheckSquare1NoteBend_Exit:\n\tRTS\n\n\nNoteBendStashFrequency:","htmlComment":"<p>Reads ahead to see if we have a note bend</p>\n","htmlContent":"CheckSquare<span class=\"token decimalnumber string\">1</span>NoteBend:\n\t<span class=\"token opcode property\">LDY</span> CurrentMusicSquare<span class=\"token decimalnumber string\">1</span>Offset\n\t<span class=\"token opcode property\">LDA</span> (CurrentMusicPointer), <span class=\"token register variable\">Y</span>\n\t<span class=\"token opcode property\">CMP</span> <span class=\"token hexnumber string\">#$FF</span>\n\t<span class=\"token opcode property\">BNE</span> CheckSquare<span class=\"token decimalnumber string\">1</span>NoteBend_Exit\n\n\t<span class=\"token opcode property\">INC</span> CurrentMusicSquare<span class=\"token decimalnumber string\">1</span>Offset\n\n\t<span class=\"token opcode property\">LDA</span> MusicSquare<span class=\"token decimalnumber string\">1</span>Lo\n\t<span class=\"token opcode property\">STA</span> MusicSquare<span class=\"token decimalnumber string\">1</span>NoteBend\n\n\t<span class=\"token opcode property\">PLA</span>\n\t<span class=\"token opcode property\">PLA</span>\n\t<span class=\"token opcode property\">JMP</span> ProcessMusicQueue_Square<span class=\"token decimalnumber string\">1</span>NextOffset\n\nCheckSquare<span class=\"token decimalnumber string\">1</span>NoteBend_Exit:\n\t<span class=\"token opcode property\">RTS</span>\n\n\nNoteBendStashFrequency:","line":1401},{"comment":"If bend is in effect, this stores the last set frequency","content":"\tLDA <NextFrequencyLo\n\tSTA MusicSquare1Lo, X\n\tRTS\n\n","htmlComment":"<p>If bend is in effect, this stores the last set frequency</p>\n","htmlContent":"\t<span class=\"token opcode property\">LDA</span> &#x3C;NextFrequencyLo\n\t<span class=\"token opcode property\">STA</span> MusicSquare<span class=\"token decimalnumber string\">1</span>Lo, <span class=\"token register variable\">X</span>\n\t<span class=\"token opcode property\">RTS</span>\n\n","line":1422},{"comment":"\nUpdates note bend\n\nInput\nA = rest time remaining\nX = channel\n$00: square 1\n$04: square 2\n","content":"UpdateNoteBend:\n\tAND #%00000011\n\tCMP #$03\n\tBEQ UpdateNoteBend_AfterDecrement\n\n\tDEC MusicSquare1NoteBend, X\n\nUpdateNoteBend_AfterDecrement:\n\tLDA MusicSquare1NoteBend, X\n\tCMP MusicSquare1Lo, X\n\tBCS UpdateNoteBend_Exit\n\n\tLDA #$00\n\tSTA MusicSquare1NoteBend, X\n\tLDA MusicSquare1Lo, X\n\nUpdateNoteBend_Exit:\n\tSTA SQ1_LO, X\n\tRTS\nENDIF\n\n","htmlComment":"<p>Updates note bend</p>\n<p>Input\nA = rest time remaining\nX = channel\n$00: square 1\n$04: square 2</p>\n","htmlContent":"UpdateNoteBend:\n\t<span class=\"token opcode property\">AND</span> <span class=\"token binarynumber string\">#%00000011</span>\n\t<span class=\"token opcode property\">CMP</span> <span class=\"token hexnumber string\">#$03</span>\n\t<span class=\"token opcode property\">BEQ</span> UpdateNoteBend_AfterDecrement\n\n\t<span class=\"token opcode property\">DEC</span> MusicSquare<span class=\"token decimalnumber string\">1</span>NoteBend, <span class=\"token register variable\">X</span>\n\nUpdateNoteBend_AfterDecrement:\n\t<span class=\"token opcode property\">LDA</span> MusicSquare<span class=\"token decimalnumber string\">1</span>NoteBend, <span class=\"token register variable\">X</span>\n\t<span class=\"token opcode property\">CMP</span> MusicSquare<span class=\"token decimalnumber string\">1</span>Lo, <span class=\"token register variable\">X</span>\n\t<span class=\"token opcode property\">BCS</span> UpdateNoteBend_Exit\n\n\t<span class=\"token opcode property\">LDA</span> <span class=\"token hexnumber string\">#$00</span>\n\t<span class=\"token opcode property\">STA</span> MusicSquare<span class=\"token decimalnumber string\">1</span>NoteBend, <span class=\"token register variable\">X</span>\n\t<span class=\"token opcode property\">LDA</span> MusicSquare<span class=\"token decimalnumber string\">1</span>Lo, <span class=\"token register variable\">X</span>\n\nUpdateNoteBend_Exit:\n\t<span class=\"token opcode property\">STA</span> SQ<span class=\"token decimalnumber string\">1</span>_LO, <span class=\"token register variable\">X</span>\n\t<span class=\"token opcode property\">RTS</span>\nENDIF\n\n","line":1436},{"comment":"\n-------------------------------------------------------------------------\nVarious bits of the music engine have been extracted into separate files;\nsee the individual files for details on the formats within\n","content":"","htmlComment":"<hr>\n<p>Various bits of the music engine have been extracted into separate files;\nsee the individual files for details on the formats within</p>\n","htmlContent":"","line":1463},{"comment":"Frequency table for notes; standard between various Mario games","content":".include \"src/music/frequency-table.asm\";\n","htmlComment":"<p>Frequency table for notes; standard between various Mario games</p>\n","htmlContent":"<span class=\"token directive keyword\">.include</span> <a class=\"token string\" href=\"/smb2/src/music/frequency-table.asm\">\"src/music/frequency-table.asm\"</a><span class=\"token comment\">;</span>\n","line":1465},{"comment":"Unused space in the original ($875F - $8EFF)","content":"unusedSpace $8F00, $FF\n","htmlComment":"<p>Unused space in the original ($875F - $8EFF)</p>\n","htmlContent":"unusedSpace <span class=\"token hexnumber string\">$8F00</span>, <span class=\"token hexnumber string\">$FF</span>\n","line":1468},{"comment":"Note lengths for various BPM settings","content":".include \"src/music/note-lengths.asm\";\n","htmlComment":"<p>Note lengths for various BPM settings</p>\n","htmlContent":"<span class=\"token directive keyword\">.include</span> <a class=\"token string\" href=\"/smb2/src/music/note-lengths.asm\">\"src/music/note-lengths.asm\"</a><span class=\"token comment\">;</span>\n","line":1471},{"comment":"Unused space in the original ($8FB3 - $8FFF)","content":"unusedSpace $9000, $FF\n","htmlComment":"<p>Unused space in the original ($8FB3 - $8FFF)</p>\n","htmlContent":"unusedSpace <span class=\"token hexnumber string\">$9000</span>, <span class=\"token hexnumber string\">$FF</span>\n","line":1474},{"comment":"Pointers to music segments","content":"IFNDEF EXPAND_MUSIC\n\t.include \"src/music/music-part-pointers.asm\"\nELSE\n\t.include \"src/music/music-part-pointers-expanded.asm\"\nENDIF\n","htmlComment":"<p>Pointers to music segments</p>\n","htmlContent":"IFNDEF EXPAND_MUSIC\n\t<span class=\"token directive keyword\">.include</span> <a class=\"token string\" href=\"/smb2/src/music/music-part-pointers.asm\">\"src/music/music-part-pointers.asm\"</a>\nELSE\n\t<span class=\"token directive keyword\">.include</span> <a class=\"token string\" href=\"/smb2/src/music/music-part-pointers-expanded.asm\">\"src/music/music-part-pointers-expanded.asm\"</a>\nENDIF\n","line":1477},{"comment":"Headers for songs (BPM, tracks to use, etc)","content":".include \"src/music/music-headers.asm\"\n","htmlComment":"<p>Headers for songs (BPM, tracks to use, etc)</p>\n","htmlContent":"<span class=\"token directive keyword\">.include</span> <a class=\"token string\" href=\"/smb2/src/music/music-headers.asm\">\"src/music/music-headers.asm\"</a>\n","line":1484},{"comment":"More music pointers","content":".include \"src/music/music-pointers.asm\"\n","htmlComment":"<p>More music pointers</p>\n","htmlContent":"<span class=\"token directive keyword\">.include</span> <a class=\"token string\" href=\"/smb2/src/music/music-pointers.asm\">\"src/music/music-pointers.asm\"</a>\n","line":1487},{"comment":"Music and track data","content":".include \"src/music/music-data.asm\"\n","htmlComment":"<p>Music and track data</p>\n","htmlContent":"<span class=\"token directive keyword\">.include</span> <a class=\"token string\" href=\"/smb2/src/music/music-data.asm\">\"src/music/music-data.asm\"</a>\n","line":1490},{"comment":"Instrument data and definitions","content":".include \"src/music/instruments.asm\"\n","htmlComment":"<p>Instrument data and definitions</p>\n","htmlContent":"<span class=\"token directive keyword\">.include</span> <a class=\"token string\" href=\"/smb2/src/music/instruments.asm\">\"src/music/instruments.asm\"</a>\n","line":1493}]}},"pageContext":{"isCreatedByStatefulCreatePages":false}}}